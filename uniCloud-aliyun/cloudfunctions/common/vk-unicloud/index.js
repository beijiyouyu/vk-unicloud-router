"use strict";var e={main:async e=>{let{url:t,data:n={},util:a}=e,{uniID:i}=a,{need_user_info:r=!0}=n,o={code:-1,msg:""},l=t.indexOf("/sys/")>-1,s=await i.checkToken(e.uniIdToken,{needPermission:l,needUserInfo:r});if(s.code&&s.code>0)return s;let d=s.userInfo;return d.permission=s.permission,delete d.token,delete d.password,o.uid=s.uid,o.userInfo=d,s.token&&(o.token=s.token,o.tokenExpired=s.tokenExpired),o.code=0,o.msg="ok",o}};async function t(e={},t){let{vk:n,db:a,_:i}=t,{whereJson:r={},fieldJson:o={},justNeedID:l=!1}=e;l&&(o={permission_id:!0}),r.enable=!0;let s=[],d=await n.baseDao.select({dbName:"uni-id-permissions",pageIndex:1,pageSize:500,fieldJson:o,whereJson:r});if(l)for(let e=0;e<d.rows.length;e++){let t=d.rows[e];s.push(t.permission_id)}else s=d.rows;return s}var n=[{id:"pub",regExp:"/pub/",description:"pub函数为所有人都可以访问的函数",index:100,mode:"onActionExecuting",main:async function(t){let n={};return t.data.need_user_info&&(n=await e.main(t)),n.code=0,n.msg="ok",n}},{id:"kh",regExp:"/kh/",description:"kh函数为必须登录后才能访问的函数(客户端用户)",index:200,mode:"onActionExecuting",main:e.main},{id:"sys",regExp:"/sys/",description:"sys函数为后端管理人员才能访问的函数(商家后台工作人员)",index:300,mode:"onActionExecuting",main:{main:async n=>{let{url:a,util:i}=n,{uniID:r,config:o,pubFun:l,vk:s,db:d,_:u}=i,c={code:-1,msg:""};const f=e;if(c=await f.main(n),0!==c.code)return c;if(c.userInfo.role||(c.userInfo.role=[]),c.userInfo.role.includes("admin"))return c;if(!c.userInfo.allow_login_background)return{code:403,msg:"您无权限登录后台"};let g=[];if(c.userInfo.role.includes("admin-lv3")){let e=await t({whereJson:{level:u.in([1,2,3])},justNeedID:!0},i);s.pubfn.isNotNull(e)&&(g=g.concat(e))}if(c.userInfo.role.includes("admin-lv2")){let e=await t({whereJson:{level:u.in([1,2])},justNeedID:!0},i);s.pubfn.isNotNull(e)&&(g=g.concat(e))}if(c.userInfo.role.includes("admin-lv1")){let e=await t({whereJson:{level:u.in([1])},justNeedID:!0},i);s.pubfn.isNotNull(e)&&(g=g.concat(e))}if(c.userInfo.role.includes("query-all")){let e=await t({whereJson:{curd_category:4,level:u.neq(4)},justNeedID:!0},i);s.pubfn.isNotNull(e)&&(g=g.concat(e))}let p=await async function(e,t){let{vk:n,db:a,_:i}=t,{role:r}=e;if(n.pubfn.isNull(r))return[];return(await n.baseDao.select({dbName:"uni-id-roles",whereJson:{role_id:i.in(r),enable:!0},fieldJson:{permission:!0}})).rows}({role:c.userInfo.role},i);for(let e in p){let t=p[e].permission;s.pubfn.isNotNull(t)&&(g=g.concat(t))}if(0==g.length)return{code:403,msg:"权限不足"};g=[...new Set(g)];let m=await t({whereJson:{permission_id:u.in(g),match_mode:u.in([1,2])}},i),y=!1;for(let e=0;e<m.length;e++){let t=m[e];if(1===t.match_mode){if(s.pubfn.wildcardTest(a,t.url)){y=!0;break}}else if(2===t.match_mode&&s.pubfn.regExpTest(a,t.url)){y=!0;break}}if(!y){await async function(e,t){let{vk:n,db:a,_:i}=t,{myPermission:r,url:o}=e;if(n.pubfn.isNull(r))return!1;return await n.baseDao.count({dbName:"uni-id-permissions",whereJson:{enable:!0,permission_id:i.in(r),url:o,match_mode:i.nin([1,2])}})>0}({myPermission:g,url:a},i)&&(y=!0)}return y?(c.code=0,c.msg="ok",c):{code:403,msg:"权限不足"}}}.main}];var a=function(e){let t=[];if(e){let a=[...n,...e];a.sort((function(e,t){return e.index-t.index})),t=a.filter((e,t,n)=>{var i=[];return a.forEach((e,t)=>{i.push(e.id)}),i.indexOf(e.id)===t})}else t=n;return t},i={regExpTest:function(e,t){let n=!1;if("string"==typeof e){new RegExp(e).test(t)&&(n=!0)}else if("object"==typeof e)for(let a=0;a<e.length;a++){if(new RegExp(e[a]).test(t)){n=!0;break}}return n}},r=i,o=async(e,t)=>{let n={code:403,msg:"access denied",filterStack:[]},{url:i}=e;const o=a(t);for(let t in o){let a=o[t],{mode:l="onActionExecuting",enable:s=!0}=a;if("onActionExecuting"===l&&(s&&r.regExpTest(a.regExp,i))){e.filterResponse=n;let t=await a.main(e);if(t.filterId=a.id,n.filterStack.push(t),0!==t.code){n=t;break}n=Object.assign(n,t)}}return n},l=async(e,t,n)=>{let{url:i}=e;const o=a(t);for(let t in o){let a=o[t],{mode:l="onActionExecuting",enable:s=!0}=a;if("onActionExecuted"===l&&(s&&r.regExpTest(a.regExp,i))){let t=await a.main(e,n);if(t){if(0!==t.code){n=t;break}n=Object.assign(n,t)}}}return n};process.env.TZ="Asia/Shanghai";var s=async function(e){let{event:t,context:n,vk:a}=e,{config:i,uniID:r,uniPay:s,db:d,middlewareService:u,pubFun:c,customUtil:f}=a.config;if(a.pubfn.getData(i,"vk.system.serviceShutdown"))return{code:405,msg:a.pubfn.getData(i,"vk.system.serviceShutdownDescription")};let g,p,m={event:t,context:n},y=a.getQueryStringParameters(t),{url:w,data:h,uniIdToken:b}=y,_={url:w,data:h,uniIdToken:b,util:{vk:a,config:i,pubFun:c,uniID:r,uniPay:s,db:d,customUtil:f,_:d.command},originalParam:m},N=await o(_,u);if(0!==N.code)return N;N.uid&&(h.uid=N.uid),_.filterResponse=N;try{g=a.require("service/"+w)}catch(e){return e&&"MODULE_NOT_FOUND"==e.code?(console.error(`云函数 ${w} 不存在!`,e),{code:404,msg:`云函数 ${w} 不存在!`,err:{message:e.message,stack:e.stack}}):(console.error(`云函数 ${w} 编译异常!`,e),{code:500,msg:`云函数 ${w} 编译异常!`,err:{message:e.message,stack:e.stack}})}try{p=await async function(e={}){let{res:t,serviceParam:n,serviceMain:a}=e;t.uid&&(n.uid=t.uid);t.userInfo&&(n.userInfo=t.userInfo);let i=await a.main(n);t.token&&"object"==typeof i&&(i.vk_uni_token={token:t.token,tokenExpired:t.tokenExpired});return i}({res:N,serviceParam:_,serviceMain:g})}catch(e){let t=`云函数 ${w} 运行异常!`;return console.error(t,e),{code:500,msg:t,err:{message:e.message,stack:e.stack}}}try{p=await l(_,u,p)}catch(e){let t=`云函数 ${w} 的中间件运行异常!`;return console.error(t,e),{code:500,msg:t,err:{message:e.message,stack:e.stack}}}return p};function d(e,t,n,a,i,r){return p((o=p(p(t,e),p(a,r)))<<(l=i)|o>>>32-l,n);var o,l}function u(e,t,n,a,i,r,o){return d(t&n|~t&a,e,t,i,r,o)}function c(e,t,n,a,i,r,o){return d(t&a|n&~a,e,t,i,r,o)}function f(e,t,n,a,i,r,o){return d(t^n^a,e,t,i,r,o)}function g(e,t,n,a,i,r,o){return d(n^(t|~a),e,t,i,r,o)}function p(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}var m=function(e){return function(e){for(var t="",n=0;n<4*e.length;n++)t+="0123456789abcdef".charAt(e[n>>2]>>n%4*8+4&15)+"0123456789abcdef".charAt(e[n>>2]>>n%4*8&15);return t}(function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,a=-271733879,i=-1732584194,r=271733878,o=0;o<e.length;o+=16){var l=n,s=a,d=i,m=r;n=u(n,a,i,r,e[o+0],7,-680876936),r=u(r,n,a,i,e[o+1],12,-389564586),i=u(i,r,n,a,e[o+2],17,606105819),a=u(a,i,r,n,e[o+3],22,-1044525330),n=u(n,a,i,r,e[o+4],7,-176418897),r=u(r,n,a,i,e[o+5],12,1200080426),i=u(i,r,n,a,e[o+6],17,-1473231341),a=u(a,i,r,n,e[o+7],22,-45705983),n=u(n,a,i,r,e[o+8],7,1770035416),r=u(r,n,a,i,e[o+9],12,-1958414417),i=u(i,r,n,a,e[o+10],17,-42063),a=u(a,i,r,n,e[o+11],22,-1990404162),n=u(n,a,i,r,e[o+12],7,1804603682),r=u(r,n,a,i,e[o+13],12,-40341101),i=u(i,r,n,a,e[o+14],17,-1502002290),a=u(a,i,r,n,e[o+15],22,1236535329),n=c(n,a,i,r,e[o+1],5,-165796510),r=c(r,n,a,i,e[o+6],9,-1069501632),i=c(i,r,n,a,e[o+11],14,643717713),a=c(a,i,r,n,e[o+0],20,-373897302),n=c(n,a,i,r,e[o+5],5,-701558691),r=c(r,n,a,i,e[o+10],9,38016083),i=c(i,r,n,a,e[o+15],14,-660478335),a=c(a,i,r,n,e[o+4],20,-405537848),n=c(n,a,i,r,e[o+9],5,568446438),r=c(r,n,a,i,e[o+14],9,-1019803690),i=c(i,r,n,a,e[o+3],14,-187363961),a=c(a,i,r,n,e[o+8],20,1163531501),n=c(n,a,i,r,e[o+13],5,-1444681467),r=c(r,n,a,i,e[o+2],9,-51403784),i=c(i,r,n,a,e[o+7],14,1735328473),a=c(a,i,r,n,e[o+12],20,-1926607734),n=f(n,a,i,r,e[o+5],4,-378558),r=f(r,n,a,i,e[o+8],11,-2022574463),i=f(i,r,n,a,e[o+11],16,1839030562),a=f(a,i,r,n,e[o+14],23,-35309556),n=f(n,a,i,r,e[o+1],4,-1530992060),r=f(r,n,a,i,e[o+4],11,1272893353),i=f(i,r,n,a,e[o+7],16,-155497632),a=f(a,i,r,n,e[o+10],23,-1094730640),n=f(n,a,i,r,e[o+13],4,681279174),r=f(r,n,a,i,e[o+0],11,-358537222),i=f(i,r,n,a,e[o+3],16,-722521979),a=f(a,i,r,n,e[o+6],23,76029189),n=f(n,a,i,r,e[o+9],4,-640364487),r=f(r,n,a,i,e[o+12],11,-421815835),i=f(i,r,n,a,e[o+15],16,530742520),a=f(a,i,r,n,e[o+2],23,-995338651),n=g(n,a,i,r,e[o+0],6,-198630844),r=g(r,n,a,i,e[o+7],10,1126891415),i=g(i,r,n,a,e[o+14],15,-1416354905),a=g(a,i,r,n,e[o+5],21,-57434055),n=g(n,a,i,r,e[o+12],6,1700485571),r=g(r,n,a,i,e[o+3],10,-1894986606),i=g(i,r,n,a,e[o+10],15,-1051523),a=g(a,i,r,n,e[o+1],21,-2054922799),n=g(n,a,i,r,e[o+8],6,1873313359),r=g(r,n,a,i,e[o+15],10,-30611744),i=g(i,r,n,a,e[o+6],15,-1560198380),a=g(a,i,r,n,e[o+13],21,1309151649),n=g(n,a,i,r,e[o+4],6,-145523070),r=g(r,n,a,i,e[o+11],10,-1120210379),i=g(i,r,n,a,e[o+2],15,718787259),a=g(a,i,r,n,e[o+9],21,-343485551),n=p(n,l),a=p(a,s),i=p(i,d),r=p(r,m)}return Array(n,a,i,r)}(function(e){for(var t=Array(),n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t}(e),8*e.length))},y={},w={init:function(e){y=e},add:async function(e){let{db:t,_:n,vk:a,config:i}=y,{dbName:r,dataJson:o,db:l,cancelAddTime:s}=e,d=l||t;if(!o._add_time){let e=a.pubfn.getData(i,"vk.db.unicloud.cancelAddTime");if(e&&(s=e),!s){let e=new Date;o._add_time=e.getTime();let t={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"};o._add_time_str=e.toLocaleString("zh-CN",t)}}if(o._id)throw new Error("vk.baseDao.add 中 dataJson 不能带 _id");let u=await d.collection(r).add(o);return u.id?u.id:null},adds:async function(e){let{db:t,_:n,vk:a,config:i}=y,{dbName:r,dataJson:o,cancelAddTime:l}=e,s=a.pubfn.getData(i,"vk.db.unicloud.cancelAddTime");if(s&&(l=s),!l){let e=new Date,t=e.getTime(),n={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"},a=e.toLocaleString("zh-CN",n);for(let e in o)o[e]._add_time||(o[e]._add_time=t,o[e]._add_time_str=a)}let d=await t.collection(r).add(o);return d.id?d.id:null},del:async function(e){let{db:t,_:n}=y,{dbName:a,whereJson:i}=e,r=0;if(i&&"{}"!==JSON.stringify(i)){let e=await t.collection(a).where(i).remove();e?r=e.deleted:(console.error(e.errMsg),r=-1)}else console.error("whereJson条件不能为空");return r},delete:async function(e){return await w.del(e)},remove:async function(e){return await w.del(e)},deleteById:async function(e){let{db:t,_:n}=y,{dbName:a,id:i,db:r}=e,o=r||t,l=0;if(vk.pubfn.isNull(i))throw new Error("deleteById的id不能为空,且必须是字符串");let s=await o.collection(a).doc(i).remove();return s?l=s.deleted:(console.error(s.errMsg),l=0),l},update:async function(e){let{db:t,_:n}=y,{dbName:a,whereJson:i,dataJson:r}=e,o=0;if(i&&"{}"!==JSON.stringify(i)){let e=await t.collection(a).where(i).update(r);e?o=e.updated:(console.error(e.errMsg),o=-1)}else console.error("whereJson条件不能为空");return o},updateById:async function(e){let{db:t,_:n,vk:a}=y,{dbName:i,id:r,dataJson:o,getUpdateData:l,db:s}=e,d=s||t,u=0;if(a.pubfn.isNull(r))throw new Error("updateById的id不能为空,且必须是字符串");let c=await d.collection(i).doc(r).update(o);return l?c?await w.findById({db:d,dbName:i,id:r}):null:(c?u=c.updated:(console.error(c.errMsg),u=0),u)},select:async function(e){let{db:t,_:n}=y,{dbName:a,whereJson:i,pageSize:r=10}=e;if(i&&"{}"!==JSON.stringify(i)||(i={_id:n.neq("___")}),r<=0&&(r=999999999),r>100)return await w.selectAll(e);let o=await w.getSelectData(e),{result:l,hasMore:s,total:d,getCount:u,pageIndex:c}=o;return l=l.skip((c-1)*r).limit(r),l.get().then(e=>{let t={};return u?(t.hasMore=s,t.total=d):(t.total=e.data?e.data.length:0,t.hasMore=t.total>=r),t.rows=e.data,t.code=0,t.key=1,t.pageIndex=c,t.pageSize=r,t})},findById:async function(e){let{db:t,_:n}=y,{dbName:a,id:i,fieldJson:r,db:o}=e,l=o||t;try{let e=l.collection(a).doc(i);r&&(e=e.field(r));let t=await e.get();return"[object Array]"===Object.prototype.toString.call(t.data)?t.data[0]:t.data}catch(e){return console.error(e),null}},findByWhereJson:async function(e){let{db:t,_:n}=y,{dbName:a,whereJson:i,fieldJson:r,sortArr:o}=e;try{if(i&&"{}"!==JSON.stringify(i)){let e=t.collection(a).where(i);if(o)for(let t in o){let n=o[t],a=n.name,i=n.type;null!=i&&""!=i||(i="asc"),e=e.orderBy(a,i)}r&&(e=e.field(r));let n=await e.limit(1).get();if(n.data&&n.data.length>0)return n.data[0]}else console.error("whereJson条件不能为空")}catch(e){console.error(e)}return null},count:async function(e){let{db:t,_:n}=y,{dbName:a,whereJson:i}=e;i&&"{}"!==JSON.stringify(i)||(i={_id:n.neq("___")});try{return(await t.collection(a).where(i).count()).total}catch(e){return console.error(e),null}},select2:async function(e){let{foreignKeyType:t="many-to-one"}=e;return"many-to-one"===t?await w.select2_ManyToOne(e):"one-to-many"===t?await w.select2_OneToMany(e):(console.error("不支持的foreignKeyType"),{})},count2_ManyToOne:async function(e){let{db:t,_:n,vk:a}=y,{dbName:i,dbName2:r,foreignKey:o="_id",foreignKey2:l="_id",whereJson:s={},whereJson2:d={},pageIndex:u=1,pageSize:c=10,getCount:f=!1,sortArr:g={},fieldJson:p={},fieldJson2:m={},as:w}=e;w||(w=r),"{}"===JSON.stringify(s)&&(s={_id:n.neq("___")});n.aggregate;let h=t.collection(i).aggregate();if(s&&"{}"!==JSON.stringify(s)&&(h=h.match(s)),p&&"{}"!==JSON.stringify(p)&&(h=h.project(p)),g&&"{}"!==JSON.stringify(g)){let e={};for(let t in g){let n=g[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}h=h.sort(e)}let b={from:r,localField:o,foreignField:l,as:w};if(h=h.lookup(b),m&&"{}"!==JSON.stringify(m)){let e={};for(let t in m)e[w+"."+t]=m[t];h=h.project(e)}if(d&&"{}"!==JSON.stringify(d)){let e={};for(let t in d)e[w+"."+t]=d[t];h=h.match(e)}let _=await h.count("total").end();try{return _.data[0].total}catch(e){return console.log(e),0}},select2_ManyToOne:async function(e){let{db:t,_:n,vk:a}=y,{dbName:i,dbName2:r,foreignKey:o="_id",foreignKey2:l="_id",whereJson:s={},whereJson2:d={},pageIndex:u=1,pageSize:c=10,getCount:f=!1,sortArr:g=[],fieldJson:p={},fieldJson2:m={},as:w,whereJsonPub:h={}}=e;w||(w=r),"{}"===JSON.stringify(s)&&(s={_id:n.neq("___")}),-1==c&&(u=1,c=999999999,f=!1);let b=0,_=!1;if(f){b=(await t.collection(i).where(s).count()).total,u<Math.ceil(b/c)&&(_=!0)}let N={};const x=n.aggregate;let k=t.collection(i).aggregate();if(s&&"{}"!==JSON.stringify(s)&&(k=k.match(s)),p&&"{}"!==JSON.stringify(p)&&(k=k.project(p)),g&&"[]"!==JSON.stringify(g)){let e={};for(let t in g){let n=g[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}k=k.sort(e)}k=k.skip((u-1)*c).limit(c);let v=x.pipeline().match(n.expr(x.and([x.eq(["$"+l,"$$foreignKey"+o])])));d&&"{}"!==JSON.stringify(d)&&(v=v.match(d)),m&&"{}"!==JSON.stringify(m)&&(v=v.project(m)),v=v.done();let S={};S["foreignKey"+o]="$"+o;let J={from:r,let:S,pipeline:v,as:w};k=k.lookup(J),h&&"{}"!==JSON.stringify(h)&&(k=k.match(h)),k=await k.end();let T=k.data;for(let e in T)T[e][w]&&T[e][w].length>0?T[e][w]=T[e][w][0]:T[e][w]={};return f?(N.hasMore=_,N.total=b):(N.total=T?T.length:0,N.hasMore=b>=c),N.rows=T,N.code=0,N.key=1,N},select2_OneToMany:async function(e){let{db:t,_:n,vk:a}=y,{dbName:i,dbName2:r,foreignKey:o="_id",foreignKey2:l="_id",whereJson:s={},whereJson2:d={},pageIndex:u=1,pageSize:c=10,getCount:f=!1,sortArr:g=[],sortArr2:p=[],fieldJson:m={},fieldJson2:w={},as:h}=e;h||(h=r),"{}"===JSON.stringify(s)&&(s={_id:n.neq("___")}),-1==c&&(u=1,c=999999999,f=!1);let b=0,_=!1;if(f){b=(await t.collection(i).where(s).count()).total,u<Math.ceil(b/c)&&(_=!0)}let N={};const x=n.aggregate;let k=t.collection(i).aggregate();if(s&&"{}"!==JSON.stringify(s)&&(k=k.match(s)),m&&"{}"!==JSON.stringify(m)&&(k=k.project(m)),g&&"[]"!==JSON.stringify(g)){let e={};for(let t in g){let n=g[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}k=k.sort(e)}k=k.skip((u-1)*c).limit(c);let v=x.pipeline().match(n.expr(x.and([x.eq(["$"+l,"$$foreignKey"+o])])));if(d&&"{}"!==JSON.stringify(d)&&(v=v.match(d)),p&&"[]"!==JSON.stringify(p)){let e={};for(let t in p){let n=p[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}v=v.sort(e)}w&&"{}"!==JSON.stringify(w)&&(v=v.project(w)),v=v.done();let S={};S["foreignKey"+o]="$"+o;let J={from:r,let:S,pipeline:v,as:h};k=k.lookup(J),k=await k.end();let T=k.data;return f?(N.hasMore=_,N.total=b):(N.total=T?T.length:0,N.hasMore=b>=c),N.rows=T,N.code=0,N.key=1,N},getSelectData:async function(e){let{db:t,_:n}=y,{dbName:a,whereJson:i,pageIndex:r=1,pageSize:o=10,getCount:l=!1}=e;i&&"{}"!==JSON.stringify(i)||(i={_id:n.neq("___")}),o<0&&(r=1,o=999999999,l=!0);let s=e.sortArr,d=e.fieldJson,u=0,c=!1;if(l){u=(await t.collection(a).where(i).count()).total,r<Math.ceil(u/o)&&(c=!0)}let f=t.collection(a);if(d&&(f=f.field(d)),i&&(f=f.where(i)),s)for(let e in s){let t=s[e],n=t.name,a=t.type;null!=a&&""!=a||(a="asc"),f=f.orderBy(n,a)}return{result:f,dbName:a,whereJson:i,pageIndex:r,pageSize:o,getCount:l,sortArr:s,fieldJson:d,total:u,hasMore:c}},selectAll:async function(e){let{db:t,_:n,vk:a,config:i}=y,r=(e.dbName,{}),o=500;a.pubfn.getData(i,"vk.db.unicloud.maxLimit")&&(o=a.pubfn.getData(i,"vk.db.unicloud.maxLimit"),o<=0&&(o=500),o>1e3&&(o=1e3));let l=await w.getSelectData(e),{result:s,hasMore:d,total:u,getCount:c,pageIndex:f,pageSize:g}=l;g>0&&!u&&!c&&(u=g);let p={};if(c&&0===u)p={data:[]};else{let t=u;g<u&&(t=g);let n=Math.ceil(t/o),a=[],i=(f-1)*g,r=i+g;for(let e=0;e<n;e++){let t=i+e*o,n=o;t+o>r&&(n=r-t);let l=s.skip(t).limit(n).get();a.push(l)}try{p=(await Promise.all(a)).reduce((e,t)=>({data:e.data.concat(t.data),errMsg:e.errMsg}))}catch(t){console.error("selectAll-异常",e,t),p={data:[]}}}return r.rows=p.data,r.key=1,r.code=0,r.hasMore=d,r.pageIndex=f,r.pageSize=g,r.total=c?u:p.data?p.data.length:0,r},sum:async function(e){let{db:t,_:n}=y,{dbName:a,fieldName:i,whereJson:r}=e;r&&"{}"!==JSON.stringify(r)||(r={_id:n.neq("___")});const o=t.command.aggregate;try{let e=await t.collection(a).aggregate().match(r).group({_id:null,num:o.sum("$"+i)}).end();return e.data&&e.data[0]?e.data[0].num:0}catch(e){return console.error(e),null}},avg:async function(e){let{db:t,_:n}=y,{dbName:a,fieldName:i,whereJson:r}=e;r&&"{}"!==JSON.stringify(r)||(r={_id:n.neq("___")});const o=t.command.aggregate;try{let e=await t.collection(a).aggregate().match(r).group({_id:null,num:o.avg("$"+i)}).end();return e.data&&e.data[0]?e.data[0].num:null}catch(e){return console.error(e),null}},max:async function(e){let{db:t,_:n}=y,{dbName:a,fieldName:i,whereJson:r}=e;r&&"{}"!==JSON.stringify(r)||(r={_id:n.neq("___")});const o=t.command.aggregate;try{let e=await t.collection(a).aggregate().match(r).group({_id:null,num:o.max("$"+i)}).end();return e.data&&e.data[0]?e.data[0].num:null}catch(e){return console.error(e),null}},min:async function(e){let{db:t,_:n}=y,{dbName:a,fieldName:i,whereJson:r}=e;r&&"{}"!==JSON.stringify(r)||(r={_id:n.neq("___")});const o=t.command.aggregate;try{let e=await t.collection(a).aggregate().match(r).group({_id:null,num:o.min("$"+i)}).end();return e.data&&e.data[0]?e.data[0].num:null}catch(e){return console.error(e),null}},sample:async function(e){let{db:t,_:n}=y,{dbName:a,whereJson:i,size:r}=e;i&&"{}"!==JSON.stringify(i)||(i={_id:n.neq("___")});t.command.aggregate;try{return(await t.collection(a).aggregate().match(i).sample({size:r}).end()).data}catch(e){return console.error(e),null}},selects:async function(e){let{db:t,_:n,vk:a}=y,{dbName:i,foreignKey:r="_id",whereJson:o={},pageIndex:l=1,pageSize:s=10,getCount:d=!1,sortArr:u=[],fieldJson:c={},foreignDB:f=[],lastWhereJson:g}=e;a.pubfn.isNull(o)&&(o={_id:n.neq("___")}),-1==s&&(l=1,s=999999999,d=!1);let p=0,m=!1;if(d){p=(await t.collection(i).where(o).count()).total,l<Math.ceil(p/s)&&(m=!0)}let w={};const h=n.aggregate;let b=t.collection(i).aggregate();if(a.pubfn.isNotNull(o)&&(b=b.match(o)),a.pubfn.isNotNull(c)&&(b=b.project(c)),a.pubfn.isNotNull(u)){let e={};for(let t in u){let n=u[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}b=b.sort(e)}b=b.skip((l-1)*s).limit(s);for(let e in f){let t,{dbName:i,foreignKey:o,as:l,limit:s,whereJson:d,fieldJson:u,sortArr:c}=f[e];l||(l=i),t="object"==typeof r?r[e]:r;let g=[h.eq(["$"+o,"$$foreignKey"+t])],p=h.pipeline().match(n.expr(h.and(g)));if(a.pubfn.isNotNull(d)&&(p=p.match(d)),a.pubfn.isNotNull(c)){let e={};for(let t in c){let n=c[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}p=p.sort(e)}s&&(p=p.limit(s)),a.pubfn.isNotNull(u)&&(p=p.project(u)),p=p.done();let m={};m["foreignKey"+t]="$"+t;let y={from:i,let:m,pipeline:p,as:l};b=b.lookup(y)}a.pubfn.isNotNull(g)&&(b=b.match(g)),b=await b.end();let _=b.data;for(let e in _)for(let t in f){let{as:n,limit:a}=f[t];1===a&&(_[e][n]&&_[e][n].length>0?_[e][n]=_[e][n][0]:_[e][n]={})}return d?(w.hasMore=m,w.total=p):(w.total=_?_.length:0,w.hasMore=p>=s),w.rows=_,w.code=0,w.key=1,w},addWhereJson:function(e,t={}){let{vk:n,db:a,_:i}=y,{formData:r,columns:o}=e;for(let e in o){let a,l=o[e],{key:s,mode:d,defaultValue:u,type:c=""}=l,f=s;if(n.pubfn.isNotNull(l.fieldName)&&(f=l.fieldName),a=n.pubfn.isNotNull(l.value)?l.value:r[s],n.pubfn.isNull(a)&&n.pubfn.isNotNull(u)&&(a=u),n.pubfn.isNull(d)&&(d=["address","province","city","area"].indexOf(c)>-1?"address":"[object Array]"===Object.prototype.toString.call(a)&&a.length>=2?"[]":"="),n.pubfn.isNotNull(a))if("custom"===d);else if("%%"===d)try{t[f]=new RegExp(a)}catch(e){}else if("%*"===d)try{t[f]=new RegExp("^"+a)}catch(e){}else if("*%"===d)try{t[f]=new RegExp(a+"$")}catch(e){}else if(">"===d)t[f]=i.gt(a);else if(">="===d)t[f]=i.gte(a);else if("<"===d)t[f]=i.lt(a);else if("<="===d)t[f]=i.lte(a);else if("in"===d)t[f]=i.in(a);else if("nin"===d)t[f]=i.nin(a);else if("!="===d)t[f]=i.neq(a);else if("[]"===d)t[f]=i.gte(a[0]).lte(a[1]);else if("[)"===d)t[f]=i.gte(a[0]).lt(a[1]);else if("(]"===d)t[f]=i.gt(a[0]).lte(a[1]);else if("()"===d)t[f]=i.gt(a[0]).lt(a[1]);else if("address"===d){let e={};a.province&&a.province.code&&(e["province.code"]=a.province.code),a.city&&a.city.code&&(e["city.code"]=a.city.code),a.area&&a.area.code&&(e["area.code"]=a.area.code),t[f]=e}else t[f]=a}return t},getTableData:async function(e){let{vk:t,db:n,_:a}=y,{dbName:i,data:r,whereJson:o,fieldJson:l,sortArr:s,foreignKey:d,foreignDB:u,lastWhereJson:c}=e,{pageIndex:f,pageSize:g,pagination:p,sortRule:m,formData:h,columns:b}=r;p&&(f=p.pageIndex,g=p.pageSize);let _={},N={},x=[];return t.pubfn.isNotNull(s)?x=s:x.push({name:"_add_time",type:"desc"}),t.pubfn.isNotNull(m)&&(x=m),N=w.addWhereJson(r),t.pubfn.isNotNull(o)&&t.pubfn.objectAssign(N,o),t.pubfn.isNotNull(l)&&t.pubfn.objectAssign(_,l),t.pubfn.isNull(u)?await t.baseDao.select({dbName:i,getCount:!0,pageIndex:f,pageSize:g,fieldJson:_,whereJson:N,sortArr:x}):await t.baseDao.selects({dbName:i,foreignKey:d,getCount:!0,pageIndex:f,pageSize:g,whereJson:N,fieldJson:_,sortArr:x,foreignDB:u,lastWhereJson:c})},startTransaction:async function(e){let{vk:t,db:n,_:a}=y;return await n.startTransaction()}},h=w,b=async(e={})=>{"[object object]"==Object.prototype.toString.call(e.content)&&(e.content=JSON.stringify(e.content)),void 0===e.dataType&&(e.dataType="json"),"default"==e.dataType&&delete e.dataType,e.useContent&&(e.content=JSON.stringify(e.data)),e.method||(e.method="POST"),e.data&&(e.headers||(e.headers={"content-type":"application/json; charset=UTF-8"}));var t=await uniCloud.httpclient.request(e.url,e);return t&&t.data?t.data:t},_={formValidateItem:function(e,t,n){let a={code:0,msg:"ok"};for(let i in n){let r=n[i];if(void 0===e[t]&&r.required){a={type:"undefined",code:-1,msg:"字段："+t+" 名称错误，请检查！",key:t,value:e[t]};break}if(r.required&&(null==e[t]||null==e[t]||""===e[t]||0==e[t].length)){a={type:"required",code:-1,msg:r.message,key:t,value:e[t]};break}if(r.type){if(Object.prototype.toString.call(e[t]).toLowerCase()!==`[object ${r.type}]`){a={type:"type",code:-1,msg:r.message,key:t,value:e[t]};break}}if(r.len&&e[t].length!=r.len){a={type:"len",code:-1,msg:r.message,key:t,value:e[t]};break}if(r.min)if(r.type&&"number"==r.type){if(e[t]<r.min){a={type:"min",code:-1,msg:r.message,key:t,value:e[t]};break}}else if(e[t].length<r.min){a={type:"min",code:-1,msg:r.message,key:t,value:e[t]};break}if(r.max)if(r.type&&"number"==r.type){if(e[t]>r.max){a={type:"max",code:-1,msg:r.message,key:t,value:e[t]};break}}else if(e[t].length>r.max){a={type:"max",code:-1,msg:r.message,key:t,value:e[t]};break}if("function"==typeof r.validator){let n=r.validator(r,e[t],(function(e){return e}));if(void 0!==n&&!0!==n){a={type:"validator",code:-1,msg:r.message,key:t,value:e[t]};break}}}return a}};function N(e){return JSON.parse(JSON.stringify(e))}var x={};function k(e){let t=[];for(let n=0;n<e.length;n++)-1==t.indexOf(e[n])&&t.push(e[n]);return t}x.treeToArray=function(e,t){let n=N(e);return x.treeToArrayFn(n,t)},x.treeToArrayFn=function(e,t={},n=[],a){let{id:i="_id",parent_id:r="parent_id",children:o="children",deleteChildren:l=!0}=t;for(let s in e){let d=e[s];a&&(d[r]=a),n.push(d),d[o]&&d[o].length>0&&(n=x.treeToArrayFn(d[o],t,n,d[i])),l&&delete d[o]}return n},x.arrayToTree=function(e,t){let n=N(e),{id:a="_id",parent_id:i="parent_id",children:r="children",deleteParentId:o=!0,need_field:l}=t,s=[],d={};for(let e=0;e<n.length;e++)d[n[e][a]]=n[e];for(let e=0;e<n.length;e++){let t=n[e];if(l){l=k(l.concat([a,i,r]));for(let e in t)-1===l.indexOf(e)&&delete t[e]}let u=d[t[i]];u?(u[r]||(u[r]=[]),o&&delete t[i],u[r].push(t)):s.push(t)}return s};var v=x,S={timeFormat:function(e,t="yyyy-MM-dd hh:mm:ss",n=8){if(!e)return"";let a;"number"==typeof e?(10==e.toString().length&&(e*=1e3),a=new Date(e)):a=e;const i=60*a.getTimezoneOffset()*1e3+60*n*60*1e3,r=a.getTime()+i;a=new Date(r);let o={"M+":a.getMonth()+1,"d+":a.getDate(),"h+":a.getHours(),"m+":a.getMinutes(),"s+":a.getSeconds(),"q+":Math.floor((a.getMonth()+3)/3),S:a.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(a.getFullYear()+"").substr(4-RegExp.$1.length)));for(let e in o)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?o[e]:("00"+o[e]).substr((""+o[e]).length)));return t},getFullTime:function(e,t=0,n=8){if(!e)return"";"number"==typeof e&&(e=new Date(e));const a=60*e.getTimezoneOffset()*1e3+60*n*60*1e3,i=e.getTime()+a;let r=(e=new Date(i)).getFullYear()+"",o=e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1,l=e.getDate()<10?"0"+e.getDate():e.getDate(),s=e.getHours()<10?"0"+e.getHours():e.getHours(),d=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),u=e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds();return 2===t?{YYYY:Number(r),MM:Number(o),DD:Number(l),hh:Number(s),mm:Number(d),ss:Number(u),year:Number(r),month:Number(o),day:Number(l),hour:Number(s),minute:Number(d),second:Number(u)}:1===t?r+""+o+l+s+d+u:r+"-"+o+"-"+l+" "+s+":"+d+":"+u},getWeekStartAndEnd:function(e=0,t=new Date,n=8){let a={};const i=60*t.getTimezoneOffset()*1e3+60*n*60*1e3,r=t.getTime()+i,o=new Date(r);let l=o.getDay();o.getDate();t=new Date(t.getTime()+6048e5*e);let s=0!=l?l-1:6,d=new Date(t.getTime()-864e5*s),u=new Date(d.getTime()+5184e5),c=S.getFullTime(d,2),f=S.getFullTime(u,2);return a.weekStart=new Date(`${c.year}/${c.month}/${c.day}`).getTime()-i,a.weekEnd=new Date(`${f.year}/${f.month}/${f.day}`).getTime()+86399999-i,a},getCommonTime:function(e=new Date,t=8){let n={};const a=60*e.getTimezoneOffset()*1e3+60*t*60*1e3,{year:i,month:r,day:o,hour:l,minute:s,second:d}=S.getFullTime(e,2);n.now={year:i,month:r,day:o,hour:l,minute:s,second:d};let u=new Date(i,r,0).getDate(),c=new Date(i,12,0).getDate();n.todayStart=new Date(`${i}/${r}/${o}`).getTime()-a,n.today12End=new Date(`${i}/${r}/${o}`).getTime()+43199999-a,n.todayEnd=new Date(`${i}/${r}/${o}`).getTime()+86399999-a,n.monthStart=new Date(`${i}/${r}/1`).getTime()-a,n.monthEnd=new Date(`${i}/${r}/${u}`).getTime()+86399999-a,n.yearStart=new Date(i+"/1/1").getTime()-a,n.yearEnd=new Date(`${i}/12/${c}`).getTime()+86399999-a;let f=i,g=r-1;0===g&&(g=12,f=i-1);let p=new Date(f,g,0).getDate();n.lastMonthStart=new Date(`${f}/${g}/1`).getTime()-a,n.lastMonthEnd=new Date(`${f}/${g}/${p}`).getTime()+86399999-a;let m=S.getWeekStartAndEnd(0,e);n.weekStart=m.weekStart,n.weekEnd=m.weekEnd,n.months=[],n.months[0]={monthStart:n.monthStart,monthEnd:n.monthEnd};for(let e=1;e<=12;e++){let t=new Date(i,e,0).getDate(),r=new Date(`${i}/${e}/1`).getTime()-a,o=new Date(`${i}/${e}/${t}`).getTime()+86399999-a;n.months[e]={monthStart:r,monthEnd:o}}return n},getMonthStartAndEnd:function(e,t=8){let n={startTime:null,endTime:null},{year:a,month:i}=e;if(a>0&&i>0){const e=60*(new Date).getTimezoneOffset()*1e3+60*t*60*1e3;let r=new Date(a,i,0).getDate();n.startTime=new Date(`${a}/${i}/1`).getTime()-e,n.endTime=new Date(`${a}/${i}/${r}`).getTime()+86399999-e}return n}},J=S,T={formValidate:function(e={}){let t={code:0,msg:"ok"},{data:n,rules:a}=e;if(a)for(let e in a){let i=a[e];if(t=_.formValidateItem(n,e,i),0!=t.code)break}return t}};T.treeUtil=v,T.timeUtil=J,T.timeFormat=T.timeUtil.timeFormat,T.getFullTime=T.timeUtil.getFullTime,T.getWeekStartAndEnd=T.timeUtil.getWeekStartAndEnd,T.getCommonTime=T.timeUtil.getCommonTime,T.getMonthStartAndEnd=T.timeUtil.getMonthStartAndEnd,T.validator=function(e){return function(t,n,a){let i=T.test(n,e);return"function"!=typeof a||!i&&n?a(!1):void a()}},T.test=function(e,t){switch(t){case"mobile":return new RegExp(/^1[3|4|5|6|7|8|9][0-9]{9}$/).test(e);case"tel":return new RegExp(/^(0\d{2,3}-\d{7,8})(-\d{1,4})?$/).test(e);case"card":return new RegExp(/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/).test(e);case"mobileCode":return new RegExp(/^[0-9]{6}$/).test(e);case"username":return new RegExp(/^[a-zA-Z]([-_a-zA-Z0-9]{5,17})$/).test(e);case"pwd":return new RegExp(/^([a-zA-Z0-9_]){6,18}$/).test(e);case"payPwd":return new RegExp(/^[0-9]{6}$/).test(e);case"postal":return new RegExp(/[1-9]\d{5}(?!\d)/).test(e);case"QQ":return new RegExp(/^[1-9][0-9]{4,9}$/).test(e);case"email":return new RegExp(/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/).test(e);case"money":return new RegExp(/^\d*(?:\.\d{0,2})?$/).test(e);case"URL":return new RegExp(/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/).test(e);case"IP":return new RegExp(/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/).test(e);case"date":return new RegExp(/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])$/).test(e);case"time":return new RegExp(/^(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/).test(e);case"dateTime":return new RegExp(/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])\s+(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/).test(e);case"number":return new RegExp(/^[0-9]*$/).test(e);case"english":return new RegExp(/^[a-zA-Z]+$/).test(e);case"chinese":return new RegExp(/^[\\u4E00-\\u9FA5]+$/).test(e);case"lower":return new RegExp(/^[a-z]+$/).test(e);case"upper":return new RegExp(/^[A-Z]+$/).test(e);case"HTML":return new RegExp(/<("[^"]*"|'[^']*'|[^'">])*>/).test(e);default:return!0}},T.checkStr=T.test,T.priceFilter=function(e){return"string"==typeof e&&(e=parseFloat(e)),(e/100).toFixed(2)},T.objectAssign=function(e,t){return Object.assign(e,t)},T.copyObject=function(e){return JSON.parse(JSON.stringify(e))},T.formAssign=function(e,t){let n=T.copyObject(e);return T.objectAssign(n,t)},T.arr_concat=function(e,t,n){n||(n="id");var a=e.concat(t),i=[];if(-1!=n){var r=[];for(var o in a)-1==r.indexOf(a[o][n])&&(r.push(a[o][n]),i.push(a[o]))}else i=a;return i},T.getData=function(e,t,n){var a=JSON.parse(JSON.stringify(e));t=t.replace(/\s+/g,"")+".";for(var i="",r=0;r<t.length;r++){var o=t.charAt(r);"."!=o&&"["!=o&&"]"!=o?i+=o:a&&(""!=i&&(a=a[i]),i="")}return void 0===a&&T.isNotNull(n)&&(a=n),a},T.setData=function(e,t,n){const a=t.match(/([\w$]+)|\[(:\d)\]/g);for(let t=0;t<a.length-1;t++){e=e[a[t]]}e[a[a.length-1]]=n},T.isNull=function(e){let t=!1;return void 0!==e&&"[object Null]"!=Object.prototype.toString.call(e)&&""!==e&&"{}"!=JSON.stringify(e)&&"[]"!=JSON.stringify(e)&&void 0!==JSON.stringify(e)||(t=!0),t},T.isNotNull=function(e){return!T.isNull(e)},T.isNullOne=function(...e){let t=!1;for(let n=0;n<e.length;n++){let a=e[n];if(T.isNull(a)){t=!0;break}}return t},T.isNullOneByObject=function(e){let t;for(let n in e){let a=e[n];if(T.isNull(a)){t=n;break}}return t},T.isNullAll=function(...e){let t=!0;for(let n=0;n<e.length;n++){let a=e[n];if(T.isNotNull(a)){t=!1;break}}return t},T.isNotNullAll=function(...e){return!T.isNullOne(...e)},T.getListItem=function(e,t,n){let a;for(let i=0;i<e.length;i++)if(T.isNotNull(n)&&e[i][t]===n){a=e[i];break}return a},T.getListIndex=function(e,t,n){let a=-1;for(let i=0;i<e.length;i++)if(T.isNotNull(n)&&e[i][t]===n){a=i;break}return a},T.getListItemIndex=function(e,t,n){let a,i={},r=-1;for(let i=0;i<e.length;i++)if(T.isNotNull(n)&&e[i][t]===n){r=i,a=e[i];break}return i={item:a,index:r},i},T.arrayToJson=function(e,t){let n={};for(let a in e){let i=e[a];n[i[t]]=i}return n},T.listToJson=T.arrayToJson,T.random=function(e,t){let n="",a="123456789";T.isNotNull(t)&&("a-z,0-9"==t?t="abcdefghijklmnopqrstuvwxyz0123456789":"A-Z,0-9"==t?t="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789":"a-z,A-Z,0-9"!=t&&"A-Z,a-z,0-9"!=t||(t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"),a=t);for(let t=0;t<e;t++){n+=a[Math.floor(Math.random()*a.length)]}return n},T.stringIdToNumberId=function(e,t){let n="",a=e.split("").reverse().join("");for(let e=0;e<t;e++)if(a.length>e){n+="0123456789"[a[e].charCodeAt()%10]}else n="0"+n;return n},T.hidden=function(e,t,n){let a=e.length-t-n,i="";for(let e=0;e<a;e++)i+="*";return e.substring(0,t)+i+e.substring(e.length-n)},T.checkArrayIntersection=function(e=[],t=[]){let n=!1;for(let a=0;a<t.length;a++)e.indexOf(t[a])>-1&&(n=!0);return n},T.calcFreights=function(e,t){let{first_weight:n,first_weight_price:a,continuous_weight:i,continuous_weight_price:r,max_weight:o=1e8}=e,l=0,s=0,d=o,u=!1,c=0;for(;t>0;)u?(c++,t-=i,d-=i):(u=!0,s++,d=o,t-=n,d-=n),d<=0&&(u=!1);return l=s*a+r*c,l},T.getNewObject=function(e,t){let n=T.copyObject(e),a={};if(t&&t.length>0)for(let e in t){let i=t[e];T.isNotNull(n[i])&&(a[i]=n[i])}else a=n;return a},T.deleteObjectKeys=function(e,t=[]){var n={};if(e)for(let a in e)-1==t.indexOf(a)&&(n[a]=e[a]);return n},T.arrayToTree=T.treeUtil.arrayToTree,T.treeToArray=T.treeUtil.treeToArray,T.wildcardTestOne=function(e,t){if(!t)return!1;let n=t.replace(new RegExp("\\*"),"(.*)"),a=0!==t.indexOf("*")?"^":"",i="*"!==t[t.length-1]?"$":"";return new RegExp(a+n+i).test(e)},T.wildcardTest=function(e,t){let n=0;if("string"==typeof t)T.wildcardTestOne(e,t)&&n++;else if("object"==typeof t)for(let a=0;a<t.length;a++){let i=t[a];T.wildcardTestOne(e,i)&&n++}return n},T.regExpTestOne=function(e,t){if(!t)return!1;return new RegExp(t).test(e)},T.regExpTest=function(e,t){let n=0;if("string"==typeof t)T.regExpTestOne(e,t)&&n++;else if("object"==typeof t)for(let a=0;a<t.length;a++){let i=t[a];T.regExpTestOne(e,i)&&n++}return n},T.createOrderNo=function(e=""){return e+T.getFullTime(new Date,1)+T.random(16)},T.urlStringToJson=function(e){var t={};if(""!=e&&null!=e&&null!=e)for(var n=e.split("&"),a=0;a<n.length;a++){var i=n[a].split("="),r=i[0],o=i[1];t[r]=o}return t},T.getQueryStringParameters=function(e){let t={};if(e.httpMethod){if(console.log("event.path:",e.path),e.body){let n=e.body;e.isBase64Encoded&&(n=Buffer.from(n,"base64").toString("utf-8")),"string"==typeof n&&(n=JSON.parse(n)),t=n}else if(e.queryStringParameters){let n=e.queryStringParameters;"string"==typeof n.data&&(n.data=JSON.parse(n.data)),t=n}}else t=JSON.parse(JSON.stringify(e));return t.data||(t.data={}),t.url=t.$url||"",t},T.stringToFormData=function(e){e||(e="");for(var t=e.split("Content-Disposition: form-data;"),n={},a=0;a<t.length;a++){var i=t[a];let e='name="';var r=i.indexOf(e)+e.length;if(r>-1){var o=i.indexOf('"',r),l=i.substring(r,o);if(o>r){var s=i.indexOf("---",o),d=i.substring(o+1,s).trim();n[l]=d}}}return n};var O=T;var D={addAsyncTasks:async(e={},t)=>{let{vk:n,db:a,_:i}=t,{type:r,title:o,out_trade_no:l,user_order_success:s}=e,d={};return d=await n.baseDao.add({dbName:"opendb-async-tasks",dataJson:{status:0,type:r,title:o,out_trade_no:l,user_order_success:s}},t),d},addPayOrders:async(e={},t)=>{let{vk:n,db:a,_:i}=t,{pay_type:r,out_trade_no:o,openid:l,total_fee:s,appid:d,original_data:u,wxpay_info:c,alipay_info:f}=e,g={};return g=await n.baseDao.add({dbName:"uni-pay-orders",dataJson:{pay_type:r,out_trade_no:o,openid:l,total_fee:s,appid:d,original_data:u,wxpay_info:c,alipay_info:f}},t),g},findPayOrdersByOutTradeNo:async(e="___",t)=>{let{vk:n,db:a,_:i}=t,r={};return r=await n.baseDao.findByWhereJson({dbName:"uni-pay-orders",whereJson:{out_trade_no:e}},t),r}},A=D,E={};E.payDao=A,E.pay=async(e={},t)=>{let{uniPay:n,config:a,vk:i,db:r,_:o}=t,{data:l={},userInfo:s,provider:d,originalParam:u}=e,{outTradeNo:c,subject:f="",body:g="",totalFee:p}=l;const{wxConfigMp:m,wxConfigApp:y,wxConfigH5:w,aliConfigMp:h,aliConfigApp:b,aliConfigH5:_,notifyUrl:N,alipay_app_to_h5:x}=a["uni-pay"];let k,v,S,J=d+"_"+u.context.PLATFORM;x&&"alipay_app-plus"==J&&(J="alipay_h5");var T=N+"/"+J;switch(J){case"wxpay_mp-weixin":k=n.initWeixin(m),v=s.wx_openid["mp-weixin"],S="JSAPI";break;case"wxpay_app-plus":k=n.initWeixin(y),S="APP";break;case"wxpay_h5":k=n.initWeixin(w),S="NATIVE";break;case"alipay_mp-alipay":k=n.initAlipay(h),v=s.ali_openid;break;case"alipay_app-plus":k=n.initAlipay(b),S="APP";break;case"alipay_h5":k=n.initAlipay(_),S="NATIVE";break;default:return{code:-1,msg:"参数错误",value:d+"_"+u.context.PLATFORM}}let O;try{v&&(l.openid=v),l.notifyUrl=T,l.tradeType=S,"alipay"===d&&void 0===l.extendParams&&(l.extendParams={sysServiceProviderId:"2088731216435275"}),O=await k.getOrderInfo(l)}catch(e){return console.log("error: ",e.message),{code:-3,msg:"获取支付信息失败，请稍后再试。"+e.message}}return{code:0,msg:"ok",outTradeNo:c,orderInfo:O}},E.payNotify=async function(e){let{event:t,context:n,vk:a,orderPaySuccess:i}=e,{config:r,uniPay:o,db:l,customUtil:s}=a.config,d={vk:a,config:r,uniPay:o,db:l,customUtil:s,_:l.command};const{wxConfigMp:u,wxConfigApp:c,wxConfigH5:f,aliConfigMp:g,aliConfigApp:p,aliConfigH5:m,alipay_app_to_h5:y}=r["uni-pay"];(new Date).getTime();let w,h=t.path.substring(1);switch(y&&"alipay_app-plus"==h&&(h="alipay_h5"),h){case"wxpay_mp-weixin":w=o.initWeixin(u);break;case"wxpay_app-plus":w=o.initWeixin(c);break;case"wxpay_h5":w=o.initWeixin(f);break;case"alipay_mp-alipay":w=o.initAlipay(g);break;case"alipay_app-plus":w=o.initAlipay(p);break;case"alipay_h5":w=o.initAlipay(m);break;default:return console.log("---------参数错误---------"),{code:-1,msg:"参数错误"}}let b=await w.verifyPaymentNotify(t);if(!b)return console.log("---------!验证未通过!---------"),{};let _,N,{outTradeNo:x,totalFee:k,transactionId:v,resultCode:S,openid:J,appId:T}=b;0==h.indexOf("wxpay_")?_=b:0==h.indexOf("alipay_")&&(N=b);let O=!1;return"function"==typeof i&&(O=await i({util:d,data:b})),"SUCCESS"==S&&(await A.addAsyncTasks({type:1001,title:`订单【${x}】付款成功`,out_trade_no:x,user_order_success:O},d),await A.addPayOrders({pay_type:h,out_trade_no:x,openid:J,total_fee:k,appid:T,original_data:t.body,wxpay_info:_,alipay_info:N},d)),0==h.indexOf("wxpay_")?{mpserverlessComposedResponse:!0,statusCode:200,headers:{"content-type":"text/xml"},body:"<xml><return_code><![CDATA[SUCCESS]]></return_code><return_msg><![CDATA[OK]]></return_msg></xml>"}:(h.indexOf("alipay_"),"SUCCESS")},E.payQuery=async(e={},t)=>{let{uniPay:n,config:a,vk:i,db:r,_:o}=t,{data:l={}}=e,{outTradeNo:s}=l,d={code:-1,msg:""};const{wxConfigMp:u,wxConfigApp:c,wxConfigH5:f,aliConfigMp:g,aliConfigApp:p,aliConfigH5:m,notifyUrl:y}=a["uni-pay"];if(!s)return{code:-1,msg:"订单号不能为空"};let w=await A.findPayOrdersByOutTradeNo(s,t);if(!w)return{code:-2,msg:"订单不存在或订单未支付!"};let h;switch(w.pay_type){case"wxpay_mp-weixin":h=n.initWeixin(u);break;case"wxpay_app-plus":h=n.initWeixin(c);break;case"wxpay_h5":h=n.initWeixin(f);break;case"alipay_mp-alipay":h=n.initAlipay(g);break;case"alipay_app-plus":h=n.initAlipay(p);break;case"alipay_h5":h=n.initAlipay(m);break;default:return{code:-1,msg:"参数错误"}}let b=await h.orderQuery({outTradeNo:s});if("SUCCESS"===b.tradeState||"FINISHED"===b.tradeState)d={code:0,msg:"支付成功",orderPaid:!0};else{let e=b.tradeStateDesc||"未支付或已退款";e.indexOf("订单发生过退款")>-1&&(e="订单已退款"),d={code:-1,msg:e,orderPaid:!1}}return d},E.refund=async(e={},t)=>{let{uniPay:n,config:a,vk:i,db:r,_:o}=t,{data:l={},originalParam:s,orderRefundSuccess:d}=e,{outTradeNo:u}=l,c={code:-1,msg:""};const{wxConfigMp:f,wxConfigApp:g,wxConfigH5:p,aliConfigMp:m,aliConfigApp:y,aliConfigH5:w,notifyUrl:h}=a["uni-pay"];let b=u;if(!u)return{code:-1,msg:"订单号不能为空"};let _=await A.findPayOrdersByOutTradeNo(u,t);if(!_)return{code:-2,msg:"订单不存在或订单未支付!"};let N=_.total_fee,x=N;const k=_.pay_type;let v;switch(k){case"wxpay_mp-weixin":v=n.initWeixin(f);break;case"wxpay_app-plus":v=n.initWeixin(g);break;case"wxpay_h5":v=n.initWeixin(p);break;case"alipay_mp-alipay":v=n.initAlipay(m);break;case"alipay_app-plus":v=n.initAlipay(y);break;case"alipay_h5":v=n.initAlipay(w);break;default:return{code:-1,msg:"参数错误,暂不支持"+k}}let S=!1;return"function"==typeof d&&(S=await d({payOrder:_})),await A.addAsyncTasks({type:1002,title:`订单【${u}】退款成功`,out_trade_no:u,user_order_success:S},t),console.log(`---- ${u} -- ${b} -- ${N} -- ${x}`),c=await v.refund({outTradeNo:u,outRefundNo:b,totalFee:N,refundFee:x}),c.outTradeNo?(c.code=0,c.msg="退款成功"):(c.code=-1,c.msg="退款失败"),c},E.refundQuery=async(e={},t)=>{let{uniPay:n,config:a,vk:i,db:r,_:o}=t,{data:l={}}=e,{outTradeNo:s}=l,d={code:-1,msg:""};const{wxConfigMp:u,wxConfigApp:c,wxConfigH5:f,aliConfigMp:g,aliConfigApp:p,aliConfigH5:m,notifyUrl:y}=a["uni-pay"];if(!s)return{code:-1,msg:"订单号不能为空"};let w=await A.findPayOrdersByOutTradeNo(s,t);if(!w)return{code:-2,msg:"订单不存在或订单未支付!"};let h,b;switch(w.pay_type){case"wxpay_mp-weixin":h=n.initWeixin(u);break;case"wxpay_app-plus":h=n.initWeixin(c);break;case"wxpay_h5":h=n.initWeixin(f);break;case"alipay_mp-alipay":h=n.initAlipay(g);break;case"alipay_app-plus":h=n.initAlipay(p);break;case"alipay_h5":h=n.initAlipay(m);break;default:return{code:-1,msg:"参数错误"}}let _={};try{b=await h.refundQuery({outTradeNo:s,outRefundNo:s})}catch(e){return{code:-1,msg:"查询失败,请稍后再试!",err:e,refundQueryJson:_,queryResult:b}}if(b.refundFee>0){let e="退款成功";for(let t in b.refundList){let n=b.refundList[t];e+=`${t+1}、 ${n.refundSuccessTime}: \r\n退款到 ${n.refundRecvAccout};\r\n`}d={code:0,msg:e,queryResult:b}}else d={code:-1,msg:"未退款",queryResult:b};return d};var $=E,C={},I={};C.get=function(e){let t,n=I[e];if(n){let{value:a,expired:i}=n;C.isExpired(e)?delete I[e]:t=a}return t},C.set=function(e,t,n=0){let a={value:t,expired:n>0?(new Date).getTime()+1e3*n:0};I[e]=a},C.del=function(e){delete I[e]},C.clear=function(e){if(e)for(let t in I)0==t.indexOf(e)&&delete I[t];else I={}},C.isExpired=function(e){let t=!0,n=I[e];return n&&(0==n.expired||n.expired>(new Date).getTime())&&(t=!1),t},C.getAll=function(e){let t={};if(e)for(let n in I)0==n.indexOf(e)&&(t[e]=I[e]);else t=I;for(let e in t)C.isExpired(e)&&(delete t[e],delete I[e]);return t};var M=C;const P="opendb-global-data";var R={},j={};R.init=function(e){j=e},R.find=async e=>{let{vk:t,db:n,_:a}=j,i={};return i=await t.baseDao.findByWhereJson({dbName:P,whereJson:{key:e}}),i},R.del=async e=>{let{vk:t,db:n,_:a}=j,i={};return i=await t.baseDao.del({dbName:P,whereJson:{key:e}}),i},R.deleteByWhere=async e=>{let{vk:t,db:n,_:a}=j,i={};return i=await t.baseDao.del({dbName:P,whereJson:e}),i},R.update=async e=>{let{vk:t,db:n,_:a}=j,i={},{key:r,value:o,comment:l,expired_at:s}=e;return i=await t.baseDao.update({dbName:P,whereJson:{key:r},dataJson:{value:a.set(o),comment:l,expired_at:s}}),i},R.add=async e=>{let{vk:t,db:n,_:a}=j,i={},{key:r,value:o,comment:l,expired_at:s}=e;return i=await t.baseDao.add({dbName:P,dataJson:{key:r,value:o,comment:l,expired_at:s}}),i},R.count=async e=>{let{vk:t,db:n,_:a}=j,i={};return i=await t.baseDao.count({dbName:P,whereJson:e}),i},R.set=async e=>{let t={code:0,msg:"ok"};return await R.count({key:e.key})>0?(t.num=await R.update(e),t.mode="update"):(t.num=await R.add(e),t.mode="add"),t},R.list=async e=>{let{vk:t,db:n,_:a}=j,i={},{pageIndex:r,pageSize:o,whereJson:l,sortArr:s}=e;return i=await t.baseDao.select({dbName:P,pageIndex:r,pageSize:o,whereJson:l,sortArr:s}),i};var q=R,F={init:function(e){q.init(e)},get:async function(e){let t;try{let n=await q.find(e);if(n){let{value:a,expired_at:i}=n;F.isExpired(n)?await F.del(e):t=a}}catch(e){return}return t},set:async function(e,t,n=0){let a;e&&void 0!==e.key&&void 0!==e.value?(a=e.key,t=e.value,n=e.second):a=e;let i={code:0,msg:"ok"};try{if(!a)return{code:-1,msg:"key值不能为空"};let e=n>0?(new Date).getTime()+1e3*n:0;i=await q.set({key:a,value:t,expired_at:e})}catch(e){return{code:-1,msg:"异常"}}return i},del:async function(e){await q.del(e)},clear:async function(e){if(e)return await q.deleteByWhere({key:new RegExp("^"+e)})},list:async function(e){return await q.list(e)},count:async function(e){return await q.count(e)},isExpired:function(e){let t=!0;return e&&(!e.expired_at||0==e.expired_at||e.expired_at>(new Date).getTime())&&(t=!1),t}},z=F,U={};U.router=s,U.md5=m,U.baseDao=h,U.request=b,U.pubfn=O,U.payUtil=$,U.temporaryCache=M,U.globalDataCache=z,U.requireCache={},U.require=function(e){if(U.requireCache&&U.requireCache[e])return U.requireCache[e];{const t=U.config.requireFn(U.config.baseDir+"/"+e);return U.requireCache[e]=t,t}},U.config={},U.init=function(e){U.config.config=e.config,U.config.uniID=e.uniID,U.config.uniPay=e.uniPay,U.config.db=e.db,U.config._=e.db.command,U.config.pubfn=U.pubfn,U.config.middlewareService=e.middlewareService,U.config.pubFun=e.pubFun,U.config.customUtil=e.customUtil,U.config.baseDir=e.baseDir,U.config.requireFn=e.requireFn;const t={vk:U,...U.config};U.baseDao.init(t),U.daoCenter=e.daoCenter,U.daoCenter&&"function"==typeof U.daoCenter.init&&U.daoCenter.init(t),U.globalDataCache.init(t)},U.getQueryStringParameters=function(e){let t={};if(e.httpMethod){if(e.body){let n=e.body;e.isBase64Encoded&&(n=Buffer.from(n,"base64").toString("utf-8")),"string"==typeof n&&(n=JSON.parse(n)),t=n}else if(e.queryStringParameters){let n=e.queryStringParameters;"string"==typeof n.data&&(n.data=JSON.parse(n.data)),t=n}}else t=JSON.parse(JSON.stringify(e));return t.data||(t.data={}),t.uniIdToken||(t.uniIdToken=t.uni_id_token),t.url=t.$url||"",t};var W=U;module.exports=W;
