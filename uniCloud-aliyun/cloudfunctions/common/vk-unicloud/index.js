"use strict";var e={main:async e=>{let{uniID:t}=e.util,n={code:-1,msg:""},i=await t.checkToken(e.uniIdToken);if(i.code&&i.code>0)return i;let a=i.userInfo;return delete a.token,delete a.password,n.uid=i.uid,n.userInfo=a,i.token&&(n.token=i.token,n.tokenExpired=i.tokenExpired),n.code=0,n.msg="ok",n}},t=[{id:"pub",regExp:"/pub/",description:"pub函数为所有人都可以访问的函数",index:100,mode:"onActionExecuting",main:async function(t){let n={};return t.data.need_user_info&&(n=await e.main(t)),n.code=0,n.msg="ok",n}},{id:"kh",regExp:"/kh/",description:"kh函数为必须登录后才能访问的函数(客户端用户)",index:200,mode:"onActionExecuting",main:e.main},{id:"sys",regExp:"/sys/",description:"sys函数为后端管理人员才能访问的函数(商家后台工作人员)",index:300,mode:"onActionExecuting",main:{main:async t=>{let{url:n,util:i}=t,{uniID:a,config:r,pubFun:o,vk:l,db:s,_:d}=i,u={code:-1,msg:""};const c=e;if(u=await c.main(t),0!==u.code)return u;if(!u.userInfo.allow_login_background)return{code:403,msg:"您无权限登录后台"};if(l.pubfn.isNotNull(u.userInfo.role)&&u.userInfo.role.includes("admin"))return u;let f=await l.baseDao.select({dbName:"uni-id-roles",whereJson:{role_id:d.in(u.userInfo.role),enable:!0},fieldJson:{permission:!0}},t.util),g=[];for(let e in f.rows){let t=f.rows[e].permission;l.pubfn.isNotNull(t)&&(g=g.concat(t))}return 0==g.length||await l.baseDao.count({dbName:"uni-id-permissions",whereJson:{permission_id:d.in(g),enable:!0,url:n}},t.util)<=0?{code:403,msg:"权限不足"}:(u.code=0,u.msg="ok",u)}}.main}];var n=function(e){let n=[];if(e){let i=[...t,...e];i.sort((function(e,t){return e.index-t.index})),n=i.filter((e,t,n)=>{var a=[];return i.forEach((e,t)=>{a.push(e.id)}),a.indexOf(e.id)===t})}else n=t;return n},i={regExpTest:function(e,t){let n=!1;if("string"==typeof e){new RegExp(e).test(t)&&(n=!0)}else if("object"==typeof e)for(let i=0;i<e.length;i++){if(new RegExp(e[i]).test(t)){n=!0;break}}return n}},a=i,r=async(e,t)=>{let i={code:403,msg:"access denied",filterStack:[]},{url:r}=e;const o=n(t);for(let t in o){let n=o[t],{mode:l="onActionExecuting",enable:s=!0}=n;if("onActionExecuting"===l&&(s&&a.regExpTest(n.regExp,r))){e.filterResponse=i;let t=await n.main(e);if(t.filterId=n.id,i.filterStack.push(t),0!==t.code){i=t;break}i=Object.assign(i,t)}}return i},o=async(e,t,i)=>{let{url:r}=e;const o=n(t);for(let t in o){let n=o[t],{mode:l="onActionExecuting",enable:s=!0}=n;if("onActionExecuted"===l&&(s&&a.regExpTest(n.regExp,r))){let t=await n.main(e,i);if(t){if(0!==t.code){i=t;break}i=Object.assign(i,t)}}}return i};process.env.TZ="Asia/Shanghai";var l=async function(e){let t,{event:n,context:i,vk:a}=e,{config:l,uniID:s,uniPay:d,db:u,middlewareService:c,pubFun:f,customUtil:g}=a.config,p={event:n,context:i},y=a.getQueryStringParameters(n),{url:m,data:h,uniIdToken:w}=y,_={url:m,data:h,uniIdToken:w,util:{vk:a,config:l,pubFun:f,uniID:s,uniPay:d,db:u,customUtil:g,_:u.command},originalParam:p},b=await r(_,c);if(0!==b.code)return b;b.uid&&(h.uid=b.uid),_.filterResponse=b;try{t=a.require("service/"+m)}catch(e){return e&&"MODULE_NOT_FOUND"==e.code?{code:404,msg:`云函数 ${m} 不存在!`,err:e}:{code:500,msg:`云函数 ${m} 编译异常!`,err:e}}let x=await async function(e={}){let{res:t,serviceParam:n,serviceMain:i}=e;t.uid&&(n.uid=t.uid);t.userInfo&&(n.userInfo=t.userInfo);let a=await i.main(n);t.token&&"object"==typeof a&&(a.vk_uni_token={token:t.token,tokenExpired:t.tokenExpired});return a}({res:b,serviceParam:_,serviceMain:t});return x=await o(_,c,x),x};function s(e,t,n,i,a,r){return g((o=g(g(t,e),g(i,r)))<<(l=a)|o>>>32-l,n);var o,l}function d(e,t,n,i,a,r,o){return s(t&n|~t&i,e,t,a,r,o)}function u(e,t,n,i,a,r,o){return s(t&i|n&~i,e,t,a,r,o)}function c(e,t,n,i,a,r,o){return s(t^n^i,e,t,a,r,o)}function f(e,t,n,i,a,r,o){return s(n^(t|~i),e,t,a,r,o)}function g(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}var p=function(e){return function(e){for(var t="",n=0;n<4*e.length;n++)t+="0123456789abcdef".charAt(e[n>>2]>>n%4*8+4&15)+"0123456789abcdef".charAt(e[n>>2]>>n%4*8&15);return t}(function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,i=-271733879,a=-1732584194,r=271733878,o=0;o<e.length;o+=16){var l=n,s=i,p=a,y=r;n=d(n,i,a,r,e[o+0],7,-680876936),r=d(r,n,i,a,e[o+1],12,-389564586),a=d(a,r,n,i,e[o+2],17,606105819),i=d(i,a,r,n,e[o+3],22,-1044525330),n=d(n,i,a,r,e[o+4],7,-176418897),r=d(r,n,i,a,e[o+5],12,1200080426),a=d(a,r,n,i,e[o+6],17,-1473231341),i=d(i,a,r,n,e[o+7],22,-45705983),n=d(n,i,a,r,e[o+8],7,1770035416),r=d(r,n,i,a,e[o+9],12,-1958414417),a=d(a,r,n,i,e[o+10],17,-42063),i=d(i,a,r,n,e[o+11],22,-1990404162),n=d(n,i,a,r,e[o+12],7,1804603682),r=d(r,n,i,a,e[o+13],12,-40341101),a=d(a,r,n,i,e[o+14],17,-1502002290),i=d(i,a,r,n,e[o+15],22,1236535329),n=u(n,i,a,r,e[o+1],5,-165796510),r=u(r,n,i,a,e[o+6],9,-1069501632),a=u(a,r,n,i,e[o+11],14,643717713),i=u(i,a,r,n,e[o+0],20,-373897302),n=u(n,i,a,r,e[o+5],5,-701558691),r=u(r,n,i,a,e[o+10],9,38016083),a=u(a,r,n,i,e[o+15],14,-660478335),i=u(i,a,r,n,e[o+4],20,-405537848),n=u(n,i,a,r,e[o+9],5,568446438),r=u(r,n,i,a,e[o+14],9,-1019803690),a=u(a,r,n,i,e[o+3],14,-187363961),i=u(i,a,r,n,e[o+8],20,1163531501),n=u(n,i,a,r,e[o+13],5,-1444681467),r=u(r,n,i,a,e[o+2],9,-51403784),a=u(a,r,n,i,e[o+7],14,1735328473),i=u(i,a,r,n,e[o+12],20,-1926607734),n=c(n,i,a,r,e[o+5],4,-378558),r=c(r,n,i,a,e[o+8],11,-2022574463),a=c(a,r,n,i,e[o+11],16,1839030562),i=c(i,a,r,n,e[o+14],23,-35309556),n=c(n,i,a,r,e[o+1],4,-1530992060),r=c(r,n,i,a,e[o+4],11,1272893353),a=c(a,r,n,i,e[o+7],16,-155497632),i=c(i,a,r,n,e[o+10],23,-1094730640),n=c(n,i,a,r,e[o+13],4,681279174),r=c(r,n,i,a,e[o+0],11,-358537222),a=c(a,r,n,i,e[o+3],16,-722521979),i=c(i,a,r,n,e[o+6],23,76029189),n=c(n,i,a,r,e[o+9],4,-640364487),r=c(r,n,i,a,e[o+12],11,-421815835),a=c(a,r,n,i,e[o+15],16,530742520),i=c(i,a,r,n,e[o+2],23,-995338651),n=f(n,i,a,r,e[o+0],6,-198630844),r=f(r,n,i,a,e[o+7],10,1126891415),a=f(a,r,n,i,e[o+14],15,-1416354905),i=f(i,a,r,n,e[o+5],21,-57434055),n=f(n,i,a,r,e[o+12],6,1700485571),r=f(r,n,i,a,e[o+3],10,-1894986606),a=f(a,r,n,i,e[o+10],15,-1051523),i=f(i,a,r,n,e[o+1],21,-2054922799),n=f(n,i,a,r,e[o+8],6,1873313359),r=f(r,n,i,a,e[o+15],10,-30611744),a=f(a,r,n,i,e[o+6],15,-1560198380),i=f(i,a,r,n,e[o+13],21,1309151649),n=f(n,i,a,r,e[o+4],6,-145523070),r=f(r,n,i,a,e[o+11],10,-1120210379),a=f(a,r,n,i,e[o+2],15,718787259),i=f(i,a,r,n,e[o+9],21,-343485551),n=g(n,l),i=g(i,s),a=g(a,p),r=g(r,y)}return Array(n,i,a,r)}(function(e){for(var t=Array(),n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t}(e),8*e.length))},y={add:async function(e,t){let{db:n,_:i}=t,{dbName:a,dataJson:r}=e;if(!r._add_time){let e=new Date;r._add_time=e.getTime();let t={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"};r._add_time_str=e.toLocaleString("zh-CN",t)}let o=await n.collection(a).add(r);return o.id?o.id:null},adds:async function(e,t){let{db:n,_:i}=t,{dbName:a,dataJson:r}=e,o=new Date,l=o.getTime(),s=o.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});for(let e in r)r[e]._add_time||(r[e]._add_time=l,r[e]._add_time_str=s);let d=await n.collection(a).add(r);return d.id?d.id:null},del:async function(e,t){let{db:n,_:i}=t,{dbName:a,whereJson:r}=e,o=0;if(r&&"{}"!==JSON.stringify(r)){let e=await n.collection(a).where(r).remove();e?o=e.deleted:(console.error(e.errMsg),o=-1)}else console.error("whereJson条件不能为空");return o},delete:async function(e,t){return await y.del(e,t)},update:async function(e,t){let{db:n,_:i}=t,{dbName:a,whereJson:r,dataJson:o}=e,l=0;if(r&&"{}"!==JSON.stringify(r)){let e=await n.collection(a).where(r).update(o);e?l=e.updated:(console.error(e.errMsg),l=-1)}else console.error("whereJson条件不能为空");return l},select:async function(e,t){let{db:n,_:i}=t,{dbName:a,whereJson:r,pageSize:o=10}=e;if(r&&"{}"!==JSON.stringify(r)||(r={_id:i.neq("___")}),o<=0&&(o=999999999),o>100)return await y.selectAll(e,t);let l=await y.getSelectData(e,t),{result:s,hasMore:d,total:u,getCount:c,pageIndex:f}=l;return s=s.skip((f-1)*o).limit(o),s.get().then(e=>{let t={};return c?(t.hasMore=d,t.total=u):(t.total=e.data?e.data.length:0,t.hasMore=t.total>=o),t.rows=e.data,t.code=0,t.key=1,t.pageIndex=f,t.pageSize=o,t})},findById:async function(e,t){let{db:n,_:i}=t,{dbName:a,id:r,fieldJson:o}=e;try{let e=n.collection(a).doc(r);return o&&(e=e.field(o)),(await e.get()).data[0]}catch(e){return console.error(e),null}},findByWhereJson:async function(e,t){let{db:n,_:i}=t,{dbName:a,whereJson:r,fieldJson:o}=e;try{if(r&&"{}"!==JSON.stringify(r)){let e=n.collection(a).where(r);o&&(e=e.field(o));let t=await e.limit(1).get();if(t.data&&t.data.length>0)return t.data[0]}else console.error("whereJson条件不能为空")}catch(e){console.error(e)}return null},count:async function(e,t){let{db:n,_:i}=t,{dbName:a,whereJson:r}=e;r&&"{}"!==JSON.stringify(r)||(r={_id:i.neq("___")});try{return(await n.collection(a).where(r).count()).total}catch(e){return console.error(e),null}},select2:async function(e,t){let{foreignKeyType:n="many-to-one"}=e;return"many-to-one"===n?await y.select2_ManyToOne(e,t):"one-to-many"===n?await y.select2_OneToMany(e,t):(console.error("不支持的foreignKeyType"),{})},count2_ManyToOne:async function(e,t){let{db:n,_:i,vk:a}=t,{dbName:r,dbName2:o,foreignKey:l="_id",foreignKey2:s="_id",whereJson:d={},whereJson2:u={},pageIndex:c=1,pageSize:f=10,getCount:g=!1,sortArr:p={},fieldJson:y={},fieldJson2:m={},as:h}=e;h||(h=o),"{}"===JSON.stringify(d)&&(d={_id:i.neq("___")});i.aggregate;let w=n.collection(r).aggregate();if(d&&"{}"!==JSON.stringify(d)&&(w=w.match(d)),y&&"{}"!==JSON.stringify(y)&&(w=w.project(y)),p&&"{}"!==JSON.stringify(p)){let e={};for(let t in p){let n=p[t],i=n.name,a=n.type;a=null==a||""==a||"asc"==a?1:-1,e[i]=a}w=w.sort(e)}let _={from:o,localField:l,foreignField:s,as:h};if(w=w.lookup(_),m&&"{}"!==JSON.stringify(m)){let e={};for(let t in m)e[h+"."+t]=m[t];w=w.project(e)}if(u&&"{}"!==JSON.stringify(u)){let e={};for(let t in u)e[h+"."+t]=u[t];w=w.match(e)}let b=await w.count("total").end();try{return b.data[0].total}catch(e){return console.log(e),0}},select2_ManyToOne:async function(e,t){let{db:n,_:i,vk:a}=t,{dbName:r,dbName2:o,foreignKey:l="_id",foreignKey2:s="_id",whereJson:d={},whereJson2:u={},pageIndex:c=1,pageSize:f=10,getCount:g=!1,sortArr:p=[],fieldJson:y={},fieldJson2:m={},as:h,whereJsonPub:w={}}=e;h||(h=o),"{}"===JSON.stringify(d)&&(d={_id:i.neq("___")}),-1==f&&(c=1,f=999999999,g=!1);let _=0,b=!1;if(g){_=(await n.collection(r).where(d).count()).total,c<Math.ceil(_/f)&&(b=!0)}let x={};const N=i.aggregate;let k=n.collection(r).aggregate();if(d&&"{}"!==JSON.stringify(d)&&(k=k.match(d)),y&&"{}"!==JSON.stringify(y)&&(k=k.project(y)),p&&"[]"!==JSON.stringify(p)){let e={};for(let t in p){let n=p[t],i=n.name,a=n.type;a=null==a||""==a||"asc"==a?1:-1,e[i]=a}k=k.sort(e)}k=k.skip((c-1)*f).limit(f);let S=N.pipeline().match(i.expr(N.and([N.eq(["$"+s,"$$foreignKey"+l])])));u&&"{}"!==JSON.stringify(u)&&(S=S.match(u)),m&&"{}"!==JSON.stringify(m)&&(S=S.project(m)),S=S.done();let O={};O["foreignKey"+l]="$"+l;let T={from:o,let:O,pipeline:S,as:h};k=k.lookup(T),w&&"{}"!==JSON.stringify(w)&&(k=k.match(w)),k=await k.end();let J=k.data;for(let e in J)J[e][h]&&J[e][h].length>0?J[e][h]=J[e][h][0]:J[e][h]={};return g?(x.hasMore=b,x.total=_):(x.total=J?J.length:0,x.hasMore=_>=f),x.rows=J,x.code=0,x.key=1,x},select2_OneToMany:async function(e,t){let{db:n,_:i,vk:a}=t,{dbName:r,dbName2:o,foreignKey:l="_id",foreignKey2:s="_id",whereJson:d={},whereJson2:u={},pageIndex:c=1,pageSize:f=10,getCount:g=!1,sortArr:p=[],sortArr2:y=[],fieldJson:m={},fieldJson2:h={},as:w}=e;w||(w=o),"{}"===JSON.stringify(d)&&(d={_id:i.neq("___")}),-1==f&&(c=1,f=999999999,g=!1);let _=0,b=!1;if(g){_=(await n.collection(r).where(d).count()).total,c<Math.ceil(_/f)&&(b=!0)}let x={};const N=i.aggregate;let k=n.collection(r).aggregate();if(d&&"{}"!==JSON.stringify(d)&&(k=k.match(d)),m&&"{}"!==JSON.stringify(m)&&(k=k.project(m)),p&&"[]"!==JSON.stringify(p)){let e={};for(let t in p){let n=p[t],i=n.name,a=n.type;a=null==a||""==a||"asc"==a?1:-1,e[i]=a}k=k.sort(e)}k=k.skip((c-1)*f).limit(f);let S=N.pipeline().match(i.expr(N.and([N.eq(["$"+s,"$$foreignKey"+l])])));if(u&&"{}"!==JSON.stringify(u)&&(S=S.match(u)),y&&"[]"!==JSON.stringify(y)){let e={};for(let t in y){let n=y[t],i=n.name,a=n.type;a=null==a||""==a||"asc"==a?1:-1,e[i]=a}S=S.sort(e)}h&&"{}"!==JSON.stringify(h)&&(S=S.project(h)),S=S.done();let O={};O["foreignKey"+l]="$"+l;let T={from:o,let:O,pipeline:S,as:w};k=k.lookup(T),k=await k.end();let J=k.data;return g?(x.hasMore=b,x.total=_):(x.total=J?J.length:0,x.hasMore=_>=f),x.rows=J,x.code=0,x.key=1,x},getSelectData:async function(e,t){let{db:n,_:i}=t,{dbName:a,whereJson:r,pageIndex:o=1,pageSize:l=10,getCount:s=!1}=e;r&&"{}"!==JSON.stringify(r)||(r={_id:i.neq("___")}),l<0&&(o=1,l=999999999,s=!0);let d=e.sortArr,u=e.fieldJson,c=0,f=!1;if(s){c=(await n.collection(a).where(r).count()).total,o<Math.ceil(c/l)&&(f=!0)}let g=n.collection(a);if(u&&(g=g.field(u)),r&&(g=g.where(r)),d)for(let e in d){let t=d[e],n=t.name,i=t.type;null!=i&&""!=i||(i="asc"),g=g.orderBy(n,i)}return{result:g,dbName:a,whereJson:r,pageIndex:o,pageSize:l,getCount:s,sortArr:d,fieldJson:u,total:c,hasMore:f}},selectAll:async function(e,t){let{db:n,_:i,vk:a,config:r}=t,o=(e.dbName,{}),l=500;a.pubfn.getData(r,"vk.db.unicloud")&&(l=a.pubfn.getData(r,"vk.db.unicloud.max_limit"));let s=await y.getSelectData(e,t),{result:d,hasMore:u,total:c,getCount:f,pageIndex:g,pageSize:p}=s;p>0&&!c&&!f&&(c=p);let m={};if(f&&0===c)m={data:[]};else{let t=c;p<c&&(t=p);let n=Math.ceil(t/l),i=[],a=(g-1)*p,r=a+p;for(let e=0;e<n;e++){let t=a+e*l,n=l;t+l>r&&(n=r-t);let o=d.skip(t).limit(n).get();i.push(o)}try{m=(await Promise.all(i)).reduce((e,t)=>({data:e.data.concat(t.data),errMsg:e.errMsg}))}catch(t){console.error("selectAll-异常",e,t),m={data:[]}}}return o.rows=m.data,o.key=1,o.code=0,o.hasMore=u,o.pageIndex=g,o.pageSize=p,o.total=f?c:m.data?m.data.length:0,o},sum:async function(e,t){let{db:n,_:i}=t,{dbName:a,fieldName:r,whereJson:o}=e;o&&"{}"!==JSON.stringify(o)||(o={_id:i.neq("___")});const l=n.command.aggregate;try{let e=await n.collection(a).aggregate().match(o).group({_id:null,num:l.sum("$"+r)}).end();return e.data&&e.data[0]?e.data[0].num:0}catch(e){return console.error(e),null}},avg:async function(e,t){let{db:n,_:i}=t,{dbName:a,fieldName:r,whereJson:o}=e;o&&"{}"!==JSON.stringify(o)||(o={_id:i.neq("___")});const l=n.command.aggregate;try{let e=await n.collection(a).aggregate().match(o).group({_id:null,num:l.avg("$"+r)}).end();return e.data&&e.data[0]?e.data[0].num:null}catch(e){return console.error(e),null}},max:async function(e,t){let{db:n,_:i}=t,{dbName:a,fieldName:r,whereJson:o}=e;o&&"{}"!==JSON.stringify(o)||(o={_id:i.neq("___")});const l=n.command.aggregate;try{let e=await n.collection(a).aggregate().match(o).group({_id:null,num:l.max("$"+r)}).end();return e.data&&e.data[0]?e.data[0].num:null}catch(e){return console.error(e),null}},min:async function(e,t){let{db:n,_:i}=t,{dbName:a,fieldName:r,whereJson:o}=e;o&&"{}"!==JSON.stringify(o)||(o={_id:i.neq("___")});const l=n.command.aggregate;try{let e=await n.collection(a).aggregate().match(o).group({_id:null,num:l.min("$"+r)}).end();return e.data&&e.data[0]?e.data[0].num:null}catch(e){return console.error(e),null}},sample:async function(e,t){let{db:n,_:i}=t,{dbName:a,whereJson:r,size:o}=e;r&&"{}"!==JSON.stringify(r)||(r={_id:i.neq("___")});n.command.aggregate;try{return(await n.collection(a).aggregate().match(r).sample({size:o}).end()).data}catch(e){return console.error(e),null}},updateById:async function(e,t){let{db:n,_:i}=t,{dbName:a,id:r,dataJson:o}=e,l=0,s=await n.collection(a).doc(r).update(o);return s?l=s.updated:(console.error(s.errMsg),l=0),l},selects:async function(e,t){let{db:n,_:i,vk:a}=t,{dbName:r,foreignKey:o="_id",whereJson:l={},pageIndex:s=1,pageSize:d=10,getCount:u=!1,sortArr:c=[],fieldJson:f={},foreignDB:g=[]}=e;"{}"===JSON.stringify(l)&&(l={_id:i.neq("___")}),-1==d&&(s=1,d=999999999,u=!1);let p=0,y=!1;if(u){p=(await n.collection(r).where(l).count()).total,s<Math.ceil(p/d)&&(y=!0)}let m={};const h=i.aggregate;let w=n.collection(r).aggregate();if(l&&"{}"!==JSON.stringify(l)&&(w=w.match(l)),f&&"{}"!==JSON.stringify(f)&&(w=w.project(f)),c&&"[]"!==JSON.stringify(c)){let e={};for(let t in c){let n=c[t],i=n.name,a=n.type;a=null==a||""==a||"asc"==a?1:-1,e[i]=a}w=w.sort(e)}w=w.skip((s-1)*d).limit(d);for(let e in g){let t,{dbName:n,foreignKey:a,as:r,limit:l,whereJson:s,fieldJson:d,sortArr:u}=g[e];r||(r=n),t="object"==typeof o?o[e]:o;let c=[h.eq(["$"+a,"$$foreignKey"+t])],f=h.pipeline().match(i.expr(h.and(c)));if(s&&"{}"!==JSON.stringify(s)&&(f=f.match(s)),u&&"[]"!==JSON.stringify(u)){let e={};for(let t in u){let n=u[t],i=n.name,a=n.type;a=null==a||""==a||"asc"==a?1:-1,e[i]=a}f=f.sort(e)}l&&(f=f.limit(l)),d&&"{}"!==JSON.stringify(d)&&(f=f.project(d)),f=f.done();let p={};p["foreignKey"+t]="$"+t;let y={from:n,let:p,pipeline:f,as:r};w=w.lookup(y)}w=await w.end();let _=w.data;for(let e in _)for(let t in g){let{as:n,limit:i}=g[t];1===i&&(_[e][n]&&_[e][n].length>0?_[e][n]=_[e][n][0]:_[e][n]={})}return u?(m.hasMore=y,m.total=p):(m.total=_?_.length:0,m.hasMore=p>=d),m.rows=_,m.code=0,m.key=1,m},addWhereJson:function(e,t,n={}){let{vk:i,db:a,_:r}=t,{formData:o,columns:l}=e;for(let e in l){let t,a=l[e],{key:s,mode:d,defaultValue:u,type:c=""}=a,f=s;if(i.pubfn.isNotNull(a.fieldName)&&(f=a.fieldName),t=i.pubfn.isNotNull(a.value)?a.value:o[s],i.pubfn.isNull(t)&&i.pubfn.isNotNull(u)&&(t=u),i.pubfn.isNull(d)&&(d=["address","province","city","area"].indexOf(c)>-1?"address":"[object Array]"===Object.prototype.toString.call(t)&&t.length>=2?"[]":"="),i.pubfn.isNotNull(t))if("custom"===d);else if("%%"===d)try{n[f]=new RegExp(t)}catch(e){}else if("%*"===d)try{n[f]=new RegExp("^"+t)}catch(e){}else if("*%"===d)try{n[f]=new RegExp(t+"$")}catch(e){}else if(">"===d)n[f]=r.gt(t);else if(">="===d)n[f]=r.gte(t);else if("<"===d)n[f]=r.lt(t);else if("<="===d)n[f]=r.lte(t);else if("in"===d)n[f]=r.in(t);else if("nin"===d)n[f]=r.nin(t);else if("!="===d)n[f]=r.neq(t);else if("[]"===d)n[f]=r.gte(t[0]).lte(t[1]);else if("[)"===d)n[f]=r.gte(t[0]).lt(t[1]);else if("(]"===d)n[f]=r.gt(t[0]).lte(t[1]);else if("()"===d)n[f]=r.gt(t[0]).lt(t[1]);else if("address"===d){let e={};t.province&&t.province.code&&(e["province.code"]=t.province.code),t.city&&t.city.code&&(e["city.code"]=t.city.code),t.area&&t.area.code&&(e["area.code"]=t.area.code),n[f]=e}else n[f]=t}return n}},m=y,h=async(e={})=>{"[object object]"==Object.prototype.toString.call(e.content)&&(e.content=JSON.stringify(e.content)),void 0===e.dataType&&(e.dataType="json"),"default"==e.dataType&&delete e.dataType,e.useContent&&(e.content=JSON.stringify(e.data)),e.method||(e.method="POST"),e.data&&(e.headers||(e.headers={"content-type":"application/json; charset=UTF-8"}));var t=await uniCloud.httpclient.request(e.url,e);return t&&t.data?t.data:t},w={formValidateItem:function(e,t,n){let i={code:0,msg:"ok"};for(let a in n){let r=n[a];if(void 0===e[t]&&r.required){i={type:"undefined",code:-1,msg:"字段："+t+" 名称错误，请检查！",key:t,value:e[t]};break}if(r.required&&(null==e[t]||null==e[t]||""===e[t]||0==e[t].length)){i={type:"required",code:-1,msg:r.message,key:t,value:e[t]};break}if(r.type){if(Object.prototype.toString.call(e[t]).toLowerCase()!==`[object ${r.type}]`){i={type:"type",code:-1,msg:r.message,key:t,value:e[t]};break}}if(r.len&&e[t].length!=r.len){i={type:"len",code:-1,msg:r.message,key:t,value:e[t]};break}if(r.min)if(r.type&&"number"==r.type){if(e[t]<r.min){i={type:"min",code:-1,msg:r.message,key:t,value:e[t]};break}}else if(e[t].length<r.min){i={type:"min",code:-1,msg:r.message,key:t,value:e[t]};break}if(r.max)if(r.type&&"number"==r.type){if(e[t]>r.max){i={type:"max",code:-1,msg:r.message,key:t,value:e[t]};break}}else if(e[t].length>r.max){i={type:"max",code:-1,msg:r.message,key:t,value:e[t]};break}if("function"==typeof r.validator){let n=r.validator(r,e[t],(function(e){return e}));if(void 0!==n&&!0!==n){i={type:"validator",code:-1,msg:r.message,key:t,value:e[t]};break}}}return i}};function _(e){return JSON.parse(JSON.stringify(e))}var b={};function x(e){let t=[];for(let n=0;n<e.length;n++)-1==t.indexOf(e[n])&&t.push(e[n]);return t}b.treeToArray=function(e,t){let n=_(e);return b.treeToArrayFn(n,t)},b.treeToArrayFn=function(e,t={},n=[],i){let{id:a="_id",parent_id:r="parent_id",children:o="children",deleteChildren:l=!0}=t;for(let s in e){let d=e[s];i&&(d[r]=i),n.push(d),d[o]&&d[o].length>0&&(n=b.treeToArrayFn(d[o],t,n,d[a])),l&&delete d[o]}return n},b.arrayToTree=function(e,t){let n=_(e),{id:i="_id",parent_id:a="parent_id",children:r="children",deleteParentId:o=!0,need_field:l}=t,s=[],d={};for(let e=0;e<n.length;e++)d[n[e][i]]=n[e];for(let e=0;e<n.length;e++){let t=n[e];if(l){l=x(l.concat([i,a,r]));for(let e in t)-1===l.indexOf(e)&&delete t[e]}let u=d[t[a]];u?(u[r]||(u[r]=[]),o&&delete t[a],u[r].push(t)):s.push(t)}return s};var N=b,k={timeFormat:function(e,t="yyyy-MM-dd hh:mm:ss",n=8){if(!e)return"";let i;"number"==typeof e?(10==e.toString().length&&(e*=1e3),i=new Date(e)):i=e;const a=60*i.getTimezoneOffset()*1e3+60*n*60*1e3,r=i.getTime()+a;i=new Date(r);let o={"M+":i.getMonth()+1,"d+":i.getDate(),"h+":i.getHours(),"m+":i.getMinutes(),"s+":i.getSeconds(),"q+":Math.floor((i.getMonth()+3)/3),S:i.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(i.getFullYear()+"").substr(4-RegExp.$1.length)));for(let e in o)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?o[e]:("00"+o[e]).substr((""+o[e]).length)));return t},getFullTime:function(e,t=0,n=8){if(!e)return"";"number"==typeof e&&(e=new Date(e));const i=60*e.getTimezoneOffset()*1e3+60*n*60*1e3,a=e.getTime()+i;let r=(e=new Date(a)).getFullYear()+"",o=e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1,l=e.getDate()<10?"0"+e.getDate():e.getDate(),s=e.getHours()<10?"0"+e.getHours():e.getHours(),d=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),u=e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds();return 2===t?{YYYY:Number(r),MM:Number(o),DD:Number(l),hh:Number(s),mm:Number(d),ss:Number(u),year:Number(r),month:Number(o),day:Number(l),hour:Number(s),minute:Number(d),second:Number(u)}:1===t?r+""+o+l+s+d+u:r+"-"+o+"-"+l+" "+s+":"+d+":"+u},getWeekStartAndEnd:function(e=0,t=new Date,n=8){let i={};const a=60*t.getTimezoneOffset()*1e3+60*n*60*1e3,r=t.getTime()+a,o=new Date(r);let l=o.getDay();o.getDate();t=new Date(t.getTime()+6048e5*e);let s=0!=l?l-1:6,d=new Date(t.getTime()-864e5*s),u=new Date(d.getTime()+5184e5),c=k.getFullTime(d,2),f=k.getFullTime(u,2);return i.weekStart=new Date(`${c.year}/${c.month}/${c.day}`).getTime()-a,i.weekEnd=new Date(`${f.year}/${f.month}/${f.day}`).getTime()+86399999-a,i},getCommonTime:function(e=new Date,t=8){let n={};const i=60*e.getTimezoneOffset()*1e3+60*t*60*1e3,{year:a,month:r,day:o,hour:l,minute:s,second:d}=k.getFullTime(e,2);n.now={year:a,month:r,day:o,hour:l,minute:s,second:d};let u=new Date(a,r,0).getDate(),c=new Date(a,12,0).getDate();n.todayStart=new Date(`${a}/${r}/${o}`).getTime()-i,n.today12End=new Date(`${a}/${r}/${o}`).getTime()+43199999-i,n.todayEnd=new Date(`${a}/${r}/${o}`).getTime()+86399999-i,n.monthStart=new Date(`${a}/${r}/1`).getTime()-i,n.monthEnd=new Date(`${a}/${r}/${u}`).getTime()+86399999-i,n.yearStart=new Date(a+"/1/1").getTime()-i,n.yearEnd=new Date(`${a}/12/${c}`).getTime()+86399999-i;let f=a,g=r-1;0===g&&(g=12,f=a-1);let p=new Date(f,g,0).getDate();n.lastMonthStart=new Date(`${f}/${g}/1`).getTime()-i,n.lastMonthEnd=new Date(`${f}/${g}/${p}`).getTime()+86399999-i;let y=k.getWeekStartAndEnd(0,e);n.weekStart=y.weekStart,n.weekEnd=y.weekEnd,n.months=[],n.months[0]={monthStart:n.monthStart,monthEnd:n.monthEnd};for(let e=1;e<=12;e++){let t=new Date(a,e,0).getDate(),r=new Date(`${a}/${e}/1`).getTime()-i,o=new Date(`${a}/${e}/${t}`).getTime()+86399999-i;n.months[e]={monthStart:r,monthEnd:o}}return n},getMonthStartAndEnd:function(e,t=8){let n={startTime:null,endTime:null},{year:i,month:a}=e;if(i>0&&a>0){const e=60*(new Date).getTimezoneOffset()*1e3+60*t*60*1e3;let r=new Date(i,a,0).getDate();n.startTime=new Date(`${i}/${a}/1`).getTime()-e,n.endTime=new Date(`${i}/${a}/${r}`).getTime()+86399999-e}return n}},S=k,O={formValidate:function(e={}){let t={code:0,msg:"ok"},{data:n,rules:i}=e;if(i)for(let e in i){let a=i[e];if(t=w.formValidateItem(n,e,a),0!=t.code)break}return t}};O.treeUtil=N,O.timeUtil=S,O.timeFormat=O.timeUtil.timeFormat,O.getFullTime=O.timeUtil.getFullTime,O.getWeekStartAndEnd=O.timeUtil.getWeekStartAndEnd,O.getCommonTime=O.timeUtil.getCommonTime,O.getMonthStartAndEnd=O.timeUtil.getMonthStartAndEnd,O.validator=function(e){return function(t,n,i){let a=O.test(n,e);return"function"!=typeof i||!a&&n?i(!1):void i()}},O.test=function(e,t){switch(t){case"mobile":return new RegExp(/^1[3|4|5|6|7|8|9][0-9]{9}$/).test(e);case"tel":return new RegExp(/^(0\d{2,3}-\d{7,8})(-\d{1,4})?$/).test(e);case"card":return new RegExp(/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/).test(e);case"mobileCode":return new RegExp(/^[0-9]{6}$/).test(e);case"username":return new RegExp(/^[a-zA-Z]([-_a-zA-Z0-9]{5,17})$/).test(e);case"pwd":return new RegExp(/^([a-zA-Z0-9_]){6,18}$/).test(e);case"payPwd":return new RegExp(/^[0-9]{6}$/).test(e);case"postal":return new RegExp(/[1-9]\d{5}(?!\d)/).test(e);case"QQ":return new RegExp(/^[1-9][0-9]{4,9}$/).test(e);case"email":return new RegExp(/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/).test(e);case"money":return new RegExp(/^\d*(?:\.\d{0,2})?$/).test(e);case"URL":return new RegExp(/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/).test(e);case"IP":return new RegExp(/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/).test(e);case"date":return new RegExp(/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])$/).test(e);case"time":return new RegExp(/^(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/).test(e);case"dateTime":return new RegExp(/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])\s+(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/).test(e);case"number":return new RegExp(/^[0-9]*$/).test(e);case"english":return new RegExp(/^[a-zA-Z]+$/).test(e);case"chinese":return new RegExp(/^[\\u4E00-\\u9FA5]+$/).test(e);case"lower":return new RegExp(/^[a-z]+$/).test(e);case"upper":return new RegExp(/^[A-Z]+$/).test(e);case"HTML":return new RegExp(/<("[^"]*"|'[^']*'|[^'">])*>/).test(e);default:return!0}},O.checkStr=O.test,O.priceFilter=function(e){return"string"==typeof e&&(e=parseFloat(e)),(e/100).toFixed(2)},O.objectAssign=function(e,t){return Object.assign(e,t)},O.copyObject=function(e){return JSON.parse(JSON.stringify(e))},O.formAssign=function(e,t){let n=O.copyObject(e);return O.objectAssign(n,t)},O.arr_concat=function(e,t,n){n||(n="id");var i=e.concat(t),a=[];if(-1!=n){var r=[];for(var o in i)-1==r.indexOf(i[o][n])&&(r.push(i[o][n]),a.push(i[o]))}else a=i;return a},O.getData=function(e,t,n){var i=JSON.parse(JSON.stringify(e));t=t.replace(/\s+/g,"")+".";for(var a="",r=0;r<t.length;r++){var o=t.charAt(r);"."!=o&&"["!=o&&"]"!=o?a+=o:i&&(""!=a&&(i=i[a]),a="")}return void 0===i&&O.isNotNull(n)&&(i=n),i},O.setData=function(e,t,n){const i=t.match(/([\w$]+)|\[(:\d)\]/g);for(let t=0;t<i.length-1;t++){e=e[i[t]]}e[i[i.length-1]]=n},O.isNull=function(e){let t=!1;return void 0!==e&&"[object Null]"!=Object.prototype.toString.call(e)&&""!==e&&"{}"!=JSON.stringify(e)&&"[]"!=JSON.stringify(e)&&void 0!==JSON.stringify(e)||(t=!0),t},O.isNotNull=function(e){return!O.isNull(e)},O.isNullOne=function(...e){let t=!1;for(let n=0;n<e.length;n++){let i=e[n];if(O.isNull(i)){t=!0;break}}return t},O.isNullAll=function(...e){let t=!0;for(let n=0;n<e.length;n++){let i=e[n];if(O.isNotNull(i)){t=!1;break}}return t},O.isNotNullAll=function(...e){return!O.isNullOne(...e)},O.getListItem=function(e,t,n){let i;for(let a=0;a<e.length;a++)if(O.isNotNull(n)&&e[a][t]===n){i=e[a];break}return i},O.getListIndex=function(e,t,n){let i=-1;for(let a=0;a<e.length;a++)if(O.isNotNull(n)&&e[a][t]===n){i=a;break}return i},O.getListItemIndex=function(e,t,n){let i,a={},r=-1;for(let a=0;a<e.length;a++)if(O.isNotNull(n)&&e[a][t]===n){r=a,i=e[a];break}return a={item:i,index:r},a},O.arrayToJson=function(e,t){let n={};for(let i in e){let a=e[i];n[a[t]]=a}return n},O.listToJson=O.arrayToJson,O.random=function(e,t){let n="",i="123456789";O.isNotNull(t)&&("a-z,0-9"==t?t="abcdefghijklmnopqrstuvwxyz0123456789":"A-Z,0-9"==t?t="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789":"a-z,A-Z,0-9"!=t&&"A-Z,a-z,0-9"!=t||(t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"),i=t);for(let t=0;t<e;t++){n+=i[Math.floor(Math.random()*i.length)]}return n},O.stringIdToNumberId=function(e,t){let n="";for(let i=0;i<t;i++)if(e.length>i){n+="0123456789"[e[i].charCodeAt()%10]}else n="0"+n;return n},O.hidden=function(e,t,n){let i=e.length-t-n,a="";for(let e=0;e<i;e++)a+="*";return e.substring(0,t)+a+e.substring(e.length-n)},O.checkArrayIntersection=function(e=[],t=[]){let n=!1;for(let i=0;i<t.length;i++)e.indexOf(t[i])>-1&&(n=!0);return n},O.calcFreights=function(e,t){let{first_weight:n,first_weight_price:i,continuous_weight:a,continuous_weight_price:r,max_weight:o=1e8}=e,l=0,s=0,d=o,u=!1,c=0;for(;t>0;)u?(c++,t-=a,d-=a):(u=!0,s++,d=o,t-=n,d-=n),d<=0&&(u=!1);return l=s*i+r*c,l},O.getNewObject=function(e,t){let n=O.copyObject(e),i={};if(t&&t.length>0)for(let e in t){let a=t[e];O.isNotNull(n[a])&&(i[a]=n[a])}else i=n;return i},O.deleteObjectKeys=function(e,t=[]){var n={};if(e)for(let i in e)-1==t.indexOf(i)&&(n[i]=e[i]);return n},O.arrayToTree=O.treeUtil.arrayToTree,O.treeToArray=O.treeUtil.treeToArray,O.wildcardTest=function(e,t){let n=new RegExp("\\*"),i=t.replace(n,"(.*)");return new RegExp("^"+i+"$").test(e)},O.urlStringToJson=function(e){var t={};if(""!=e&&null!=e&&null!=e)for(var n=e.split("&"),i=0;i<n.length;i++){var a=n[i].split("="),r=a[0],o=a[1];t[r]=o}return t},O.getQueryStringParameters=function(e){let t={};if(e.httpMethod){if(console.log("event.path:",e.path),e.body){let n=e.body;e.isBase64Encoded&&(n=Buffer.from(n,"base64").toString("utf-8")),"string"==typeof n&&(n=JSON.parse(n)),t=n}else if(e.queryStringParameters){let n=e.queryStringParameters;"string"==typeof n.data&&(n.data=JSON.parse(n.data)),t=n}}else t=JSON.parse(JSON.stringify(e));return t.data||(t.data={}),t.url=t.$url||"",t},O.stringToFormData=function(e){e||(e="");for(var t=e.split("Content-Disposition: form-data;"),n={},i=0;i<t.length;i++){var a=t[i];let e='name="';var r=a.indexOf(e)+e.length;if(r>-1){var o=a.indexOf('"',r),l=a.substring(r,o);if(o>r){var s=a.indexOf("---",o),d=a.substring(o+1,s).trim();n[l]=d}}}return n};var T=O;var J={addAsyncTasks:async(e={},t)=>{let{vk:n,db:i,_:a}=t,{type:r,title:o,out_trade_no:l,user_order_success:s}=e,d={};return d=await n.baseDao.add({dbName:"opendb-async-tasks",dataJson:{status:0,type:r,title:o,out_trade_no:l,user_order_success:s}},t),d},addPayOrders:async(e={},t)=>{let{vk:n,db:i,_:a}=t,{pay_type:r,out_trade_no:o,openid:l,total_fee:s,appid:d,original_data:u,wxpay_info:c,alipay_info:f}=e,g={};return g=await n.baseDao.add({dbName:"uni-pay-orders",dataJson:{pay_type:r,out_trade_no:o,openid:l,total_fee:s,appid:d,original_data:u,wxpay_info:c,alipay_info:f}},t),g},findPayOrdersByOutTradeNo:async(e="___",t)=>{let{vk:n,db:i,_:a}=t,r={};return r=await n.baseDao.findByWhereJson({dbName:"uni-pay-orders",whereJson:{out_trade_no:e}},t),r}},v=J,A={};A.payDao=v,A.pay=async(e={},t)=>{let{uniPay:n,config:i,vk:a,db:r,_:o}=t,{data:l={},userInfo:s,provider:d,originalParam:u}=e,{outTradeNo:c,subject:f="",body:g="",totalFee:p}=l;const{wxConfigMp:y,wxConfigApp:m,wxConfigH5:h,aliConfigMp:w,aliConfigApp:_,aliConfigH5:b,notifyUrl:x,alipay_app_to_h5:N}=i["uni-pay"];let k,S,O,T=d+"_"+u.context.PLATFORM;N&&"alipay_app-plus"==T&&(T="alipay_h5");var J=x+"/"+T;switch(T){case"wxpay_mp-weixin":k=n.initWeixin(y),S=s.wx_openid["mp-weixin"],O="JSAPI";break;case"wxpay_app-plus":k=n.initWeixin(m),O="APP";break;case"wxpay_h5":k=n.initWeixin(h),O="NATIVE";break;case"alipay_mp-alipay":k=n.initAlipay(w),S=s.ali_openid;break;case"alipay_app-plus":k=n.initAlipay(_),O="APP";break;case"alipay_h5":k=n.initAlipay(b),O="NATIVE";break;default:return{code:-1,msg:"参数错误",value:d+"_"+u.context.PLATFORM}}let v;try{S&&(l.openid=S),l.notifyUrl=J,l.tradeType=O,"alipay"===d&&void 0===l.extendParams&&(l.extendParams={sysServiceProviderId:"2088731216435275"}),v=await k.getOrderInfo(l)}catch(e){return console.log("error: ",e.message),{code:-3,msg:"获取支付信息失败，请稍后再试。"+e.message}}return{code:0,msg:"ok",outTradeNo:c,orderInfo:v}},A.payNotify=async function(e){let{event:t,context:n,vk:i,orderPaySuccess:a}=e,{config:r,uniPay:o,db:l,customUtil:s}=i.config,d={vk:i,config:r,uniPay:o,db:l,customUtil:s,_:l.command};const{wxConfigMp:u,wxConfigApp:c,wxConfigH5:f,aliConfigMp:g,aliConfigApp:p,aliConfigH5:y,alipay_app_to_h5:m}=r["uni-pay"];(new Date).getTime();let h,w=t.path.substring(1);switch(m&&"alipay_app-plus"==w&&(w="alipay_h5"),w){case"wxpay_mp-weixin":h=o.initWeixin(u);break;case"wxpay_app-plus":h=o.initWeixin(c);break;case"wxpay_h5":h=o.initWeixin(f);break;case"alipay_mp-alipay":h=o.initAlipay(g);break;case"alipay_app-plus":h=o.initAlipay(p);break;case"alipay_h5":h=o.initAlipay(y);break;default:return console.log("---------参数错误---------"),{code:-1,msg:"参数错误"}}let _=await h.verifyPaymentNotify(t);if(!_)return console.log("---------!验证未通过!---------"),{};let b,x,{outTradeNo:N,totalFee:k,transactionId:S,resultCode:O,openid:T,appId:J}=_;0==w.indexOf("wxpay_")?b=_:0==w.indexOf("alipay_")&&(x=_);let A=!1;return"function"==typeof a&&(A=await a({util:d,data:_})),"SUCCESS"==O&&(await v.addAsyncTasks({type:1001,title:`订单【${N}】付款成功`,out_trade_no:N,user_order_success:A},d),await v.addPayOrders({pay_type:w,out_trade_no:N,openid:T,total_fee:k,appid:J,original_data:t.body,wxpay_info:b,alipay_info:x},d)),0==w.indexOf("wxpay_")?{mpserverlessComposedResponse:!0,statusCode:200,headers:{"content-type":"text/xml"},body:"<xml><return_code><![CDATA[SUCCESS]]></return_code><return_msg><![CDATA[OK]]></return_msg></xml>"}:(w.indexOf("alipay_"),"SUCCESS")},A.payQuery=async(e={},t)=>{let{uniPay:n,config:i,vk:a,db:r,_:o}=t,{data:l={}}=e,{outTradeNo:s}=l,d={code:-1,msg:""};const{wxConfigMp:u,wxConfigApp:c,wxConfigH5:f,aliConfigMp:g,aliConfigApp:p,aliConfigH5:y,notifyUrl:m}=i["uni-pay"];if(!s)return{code:-1,msg:"订单号不能为空"};let h=await v.findPayOrdersByOutTradeNo(s,t);if(!h)return{code:-2,msg:"订单不存在或订单未支付!"};let w;switch(h.pay_type){case"wxpay_mp-weixin":w=n.initWeixin(u);break;case"wxpay_app-plus":w=n.initWeixin(c);break;case"wxpay_h5":w=n.initWeixin(f);break;case"alipay_mp-alipay":w=n.initAlipay(g);break;case"alipay_app-plus":w=n.initAlipay(p);break;case"alipay_h5":w=n.initAlipay(y);break;default:return{code:-1,msg:"参数错误"}}let _=await w.orderQuery({outTradeNo:s});if("SUCCESS"===_.tradeState||"FINISHED"===_.tradeState)d={code:0,msg:"支付成功",orderPaid:!0};else{let e=_.tradeStateDesc||"未支付或已退款";e.indexOf("订单发生过退款")>-1&&(e="订单已退款"),d={code:-1,msg:e,orderPaid:!1}}return d},A.refund=async(e={},t)=>{let{uniPay:n,config:i,vk:a,db:r,_:o}=t,{data:l={},originalParam:s,orderRefundSuccess:d}=e,{outTradeNo:u}=l,c={code:-1,msg:""};const{wxConfigMp:f,wxConfigApp:g,wxConfigH5:p,aliConfigMp:y,aliConfigApp:m,aliConfigH5:h,notifyUrl:w}=i["uni-pay"];let _=u;if(!u)return{code:-1,msg:"订单号不能为空"};let b=await v.findPayOrdersByOutTradeNo(u,t);if(!b)return{code:-2,msg:"订单不存在或订单未支付!"};let x=b.total_fee,N=x;const k=b.pay_type;let S;switch(k){case"wxpay_mp-weixin":S=n.initWeixin(f);break;case"wxpay_app-plus":S=n.initWeixin(g);break;case"wxpay_h5":S=n.initWeixin(p);break;case"alipay_mp-alipay":S=n.initAlipay(y);break;case"alipay_app-plus":S=n.initAlipay(m);break;case"alipay_h5":S=n.initAlipay(h);break;default:return{code:-1,msg:"参数错误,暂不支持"+k}}let O=!1;return"function"==typeof d&&(O=await d({payOrder:b})),await v.addAsyncTasks({type:1011,title:`订单【${u}】退款成功`,out_trade_no:u,user_order_success:O},t),console.log(`---- ${u} -- ${_} -- ${x} -- ${N}`),c=await S.refund({outTradeNo:u,outRefundNo:_,totalFee:x,refundFee:N}),c.outTradeNo?(c.code=0,c.msg="退款成功"):(c.code=-1,c.msg="退款失败"),c},A.refundQuery=async(e={},t)=>{let{uniPay:n,config:i,vk:a,db:r,_:o}=t,{data:l={}}=e,{outTradeNo:s}=l,d={code:-1,msg:""};const{wxConfigMp:u,wxConfigApp:c,wxConfigH5:f,aliConfigMp:g,aliConfigApp:p,aliConfigH5:y,notifyUrl:m}=i["uni-pay"];if(!s)return{code:-1,msg:"订单号不能为空"};let h=await v.findPayOrdersByOutTradeNo(s,t);if(!h)return{code:-2,msg:"订单不存在或订单未支付!"};let w,_;switch(h.pay_type){case"wxpay_mp-weixin":w=n.initWeixin(u);break;case"wxpay_app-plus":w=n.initWeixin(c);break;case"wxpay_h5":w=n.initWeixin(f);break;case"alipay_mp-alipay":w=n.initAlipay(g);break;case"alipay_app-plus":w=n.initAlipay(p);break;case"alipay_h5":w=n.initAlipay(y);break;default:return{code:-1,msg:"参数错误"}}let b={};try{_=await w.refundQuery({outTradeNo:s,outRefundNo:s})}catch(e){return{code:-1,msg:"查询失败,请稍后再试!",err:e,refundQueryJson:b,queryResult:_}}if(_.refundFee>0){let e="退款成功";for(let t in _.refundList){let n=_.refundList[t];e+=`${t+1}、 ${n.refundSuccessTime}: \r\n退款到 ${n.refundRecvAccout};\r\n`}d={code:0,msg:e,queryResult:_}}else d={code:-1,msg:"未退款",queryResult:_};return d};var $=A,E={},D={};E.get=function(e){let t,n=D[e];if(n){let{value:i,expired:a}=n;E.isExpired(e)?delete D[e]:t=i}return t},E.set=function(e,t,n=0){let i={value:t,expired:n>0?(new Date).getTime()+1e3*n:0};D[e]=i},E.del=function(e){delete D[e]},E.clear=function(e){if(e)for(let t in D)0==t.indexOf(e)&&delete D[t];else D={}},E.isExpired=function(e){let t=!0,n=D[e];return n&&(0==n.expired||n.expired>(new Date).getTime())&&(t=!1),t},E.getAll=function(e){let t={};if(e)for(let n in D)0==n.indexOf(e)&&(t[e]=D[e]);else t=D;for(let e in t)E.isExpired(e)&&(delete t[e],delete D[e]);return t};var C=E,M={};M.router=l,M.md5=p,M.baseDao=m,M.request=h,M.pubfn=T,M.payUtil=$,M.temporaryCache=C,M.requireCache={},M.require=function(e){if(M.requireCache&&M.requireCache[e])return M.requireCache[e];{const t=M.config.requireFn(M.config.baseDir+"/"+e);return M.requireCache[e]=t,t}},M.config={},M.init=function(e){M.config.config=e.config,M.config.uniID=e.uniID,M.config.db=e.db,M.config.pubFun=e.pubFun,M.config.middlewareService=e.middlewareService,M.config.customUtil=e.customUtil,M.config.uniPay=e.uniPay,M.config.baseDir=e.baseDir,M.config.requireFn=e.requireFn,M.daoCenter=e.daoCenter},M.getQueryStringParameters=function(e){let t={};if(e.httpMethod){if(e.body){let n=e.body;e.isBase64Encoded&&(n=Buffer.from(n,"base64").toString("utf-8")),"string"==typeof n&&(n=JSON.parse(n)),t=n}else if(e.queryStringParameters){let n=e.queryStringParameters;"string"==typeof n.data&&(n.data=JSON.parse(n.data)),t=n}}else t=JSON.parse(JSON.stringify(e));return t.data||(t.data={}),t.uniIdToken||(t.uniIdToken=t.uni_id_token),t.url=t.$url||"",t};var I=M;module.exports=I;
