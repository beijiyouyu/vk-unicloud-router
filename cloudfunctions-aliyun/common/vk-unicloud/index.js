"use strict";var e,t=(e=require("@alicloud/pop-core"))&&"object"==typeof e&&"default"in e?e.default:e;var n={main:async e=>{let{uniID:t}=e.util,n={code:-1,msg:""},a=await t.checkToken(e.uniIdToken);if(a.code&&a.code>0)return a;let i=a.userInfo;return delete i.token,delete i.password,n.uid=a.uid,n.userInfo=i,a.token&&(n.token=a.token,n.tokenExpired=a.tokenExpired),n.code=0,n.msg="ok",n}},a=[{id:"pub",regExp:"/pub/",description:"pub函数为所有人都可以访问的函数",index:100,main:async function(e){let t={};return e.data.need_user_info&&(t=await n.main(e)),t.code=0,t.msg="ok",t}},{id:"kh",regExp:"/kh/",description:"kh函数为必须登录后才能访问的函数(客户端用户)",index:200,main:n.main},{id:"sys",regExp:"/sys/",description:"sys函数为后端管理人员才能访问的函数(商家后台工作人员)",index:300,main:{main:async e=>{let{url:t,util:a}=e,{uniID:i,config:r,pubFun:o,vk:l,db:s,_:d}=a,c={code:-1,msg:""};const u=n;if(c=await u.main(e),0!==c.code)return c;if(!c.userInfo.allow_login_background)return{code:403,msg:"您无权限登录后台"};if(l.pubfn.isNotNull(c.userInfo.role)&&c.userInfo.role.indexOf("admin")>-1)return{code:0,msg:"ok"};let g=await l.baseDao.select({dbName:"uni-id-roles",whereJson:{role_id:d.in(c.userInfo.role),enable:!0},fieldJson:{permission:!0}},e.util),f=[];for(let e in g.rows){let t=g.rows[e].permission;t&&t.length>0&&(f=f.concat(t))}return 0==f.length||await l.baseDao.count({dbName:"uni-id-permissions",whereJson:{permission_id:d.in(f),enable:!0,url:t}},e.util)<=0?{code:403,msg:"权限不足"}:(c.code=0,c.msg="ok",c)}}.main}],i=async(e,t)=>{let n={code:403,msg:"access denied",filterStack:[]},{url:i}=e,r=[];if(t){let e=[...a,...t];e.sort((function(e,t){return e.index-t.index})),r=e.filter((t,n,a)=>{var i=[];return e.forEach((e,t)=>{i.push(e.id)}),i.indexOf(t.id)===n})}else r=a;for(let t in r){let a=r[t];if(new RegExp(a.regExp).test(i)){e.filterResponse=n;let t=await a.main(e);if(t.filterId=a.id,n.filterStack.push(t),0!==t.code){n=t;break}n=Object.assign(n,t)}}return n};process.env.TZ="Asia/Shanghai";var r=async function(e){let t,{event:n,context:a,vk:r}=e,{config:o,uniID:l,uniPay:s,db:d,customFilterService:c,pubFun:u,customUtil:g}=r.config,f={event:n,context:a},p=r.getQueryStringParameters(n),{url:y,data:m,uniIdToken:w}=p,_={url:y,data:m,uniIdToken:w,util:{vk:r,config:o,pubFun:u,uniID:l,uniPay:s,db:d,customUtil:g,_:d.command},originalParam:f},h=await i(_,c);if(0!==h.code)return h;h.uid&&(m.uid=h.uid),_.filterResponse=h;try{t=r.require("service/"+y)}catch(e){return e&&"MODULE_NOT_FOUND"==e.code?{code:404,msg:`云函数 ${y} 不存在!`,err:e}:{code:500,msg:`云函数 ${y} 编译异常!`,err:e}}return await async function(e={}){let{res:t,serviceParam:n,serviceMain:a}=e;t.uid&&(n.uid=t.uid);t.userInfo&&(n.userInfo=t.userInfo);let i=await a.main(n);t.token&&"object"==typeof i&&(i.vk_uni_token={token:t.token,tokenExpired:t.tokenExpired});return i}({res:h,serviceParam:_,serviceMain:t})};function o(e,t,n,a,i,r){return u((o=u(u(t,e),u(a,r)))<<(l=i)|o>>>32-l,n);var o,l}function l(e,t,n,a,i,r,l){return o(t&n|~t&a,e,t,i,r,l)}function s(e,t,n,a,i,r,l){return o(t&a|n&~a,e,t,i,r,l)}function d(e,t,n,a,i,r,l){return o(t^n^a,e,t,i,r,l)}function c(e,t,n,a,i,r,l){return o(n^(t|~a),e,t,i,r,l)}function u(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}var g,f=function(e){return function(e){for(var t="",n=0;n<4*e.length;n++)t+="0123456789abcdef".charAt(e[n>>2]>>n%4*8+4&15)+"0123456789abcdef".charAt(e[n>>2]>>n%4*8&15);return t}(function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,a=-271733879,i=-1732584194,r=271733878,o=0;o<e.length;o+=16){var g=n,f=a,p=i,y=r;n=l(n,a,i,r,e[o+0],7,-680876936),r=l(r,n,a,i,e[o+1],12,-389564586),i=l(i,r,n,a,e[o+2],17,606105819),a=l(a,i,r,n,e[o+3],22,-1044525330),n=l(n,a,i,r,e[o+4],7,-176418897),r=l(r,n,a,i,e[o+5],12,1200080426),i=l(i,r,n,a,e[o+6],17,-1473231341),a=l(a,i,r,n,e[o+7],22,-45705983),n=l(n,a,i,r,e[o+8],7,1770035416),r=l(r,n,a,i,e[o+9],12,-1958414417),i=l(i,r,n,a,e[o+10],17,-42063),a=l(a,i,r,n,e[o+11],22,-1990404162),n=l(n,a,i,r,e[o+12],7,1804603682),r=l(r,n,a,i,e[o+13],12,-40341101),i=l(i,r,n,a,e[o+14],17,-1502002290),a=l(a,i,r,n,e[o+15],22,1236535329),n=s(n,a,i,r,e[o+1],5,-165796510),r=s(r,n,a,i,e[o+6],9,-1069501632),i=s(i,r,n,a,e[o+11],14,643717713),a=s(a,i,r,n,e[o+0],20,-373897302),n=s(n,a,i,r,e[o+5],5,-701558691),r=s(r,n,a,i,e[o+10],9,38016083),i=s(i,r,n,a,e[o+15],14,-660478335),a=s(a,i,r,n,e[o+4],20,-405537848),n=s(n,a,i,r,e[o+9],5,568446438),r=s(r,n,a,i,e[o+14],9,-1019803690),i=s(i,r,n,a,e[o+3],14,-187363961),a=s(a,i,r,n,e[o+8],20,1163531501),n=s(n,a,i,r,e[o+13],5,-1444681467),r=s(r,n,a,i,e[o+2],9,-51403784),i=s(i,r,n,a,e[o+7],14,1735328473),a=s(a,i,r,n,e[o+12],20,-1926607734),n=d(n,a,i,r,e[o+5],4,-378558),r=d(r,n,a,i,e[o+8],11,-2022574463),i=d(i,r,n,a,e[o+11],16,1839030562),a=d(a,i,r,n,e[o+14],23,-35309556),n=d(n,a,i,r,e[o+1],4,-1530992060),r=d(r,n,a,i,e[o+4],11,1272893353),i=d(i,r,n,a,e[o+7],16,-155497632),a=d(a,i,r,n,e[o+10],23,-1094730640),n=d(n,a,i,r,e[o+13],4,681279174),r=d(r,n,a,i,e[o+0],11,-358537222),i=d(i,r,n,a,e[o+3],16,-722521979),a=d(a,i,r,n,e[o+6],23,76029189),n=d(n,a,i,r,e[o+9],4,-640364487),r=d(r,n,a,i,e[o+12],11,-421815835),i=d(i,r,n,a,e[o+15],16,530742520),a=d(a,i,r,n,e[o+2],23,-995338651),n=c(n,a,i,r,e[o+0],6,-198630844),r=c(r,n,a,i,e[o+7],10,1126891415),i=c(i,r,n,a,e[o+14],15,-1416354905),a=c(a,i,r,n,e[o+5],21,-57434055),n=c(n,a,i,r,e[o+12],6,1700485571),r=c(r,n,a,i,e[o+3],10,-1894986606),i=c(i,r,n,a,e[o+10],15,-1051523),a=c(a,i,r,n,e[o+1],21,-2054922799),n=c(n,a,i,r,e[o+8],6,1873313359),r=c(r,n,a,i,e[o+15],10,-30611744),i=c(i,r,n,a,e[o+6],15,-1560198380),a=c(a,i,r,n,e[o+13],21,1309151649),n=c(n,a,i,r,e[o+4],6,-145523070),r=c(r,n,a,i,e[o+11],10,-1120210379),i=c(i,r,n,a,e[o+2],15,718787259),a=c(a,i,r,n,e[o+9],21,-343485551),n=u(n,g),a=u(a,f),i=u(i,p),r=u(r,y)}return Array(n,a,i,r)}(function(e){for(var t=Array(),n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t}(e),8*e.length))},p={add:async function(e,t){let{db:n,_:a}=t,{dbName:i,dataJson:r}=e;if(!r._add_time){let e=new Date;r._add_time=e.getTime();let t={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"};r._add_time_str=e.toLocaleString("zh-CN",t)}let o=await n.collection(i).add(r);return o.id?o.id:null},adds:async function(e,t){let{db:n,_:a}=t,{dbName:i,dataJson:r}=e,o=new Date,l=o.getTime(),s=o.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});for(let e in r)r[e]._add_time||(r[e]._add_time=l,r[e]._add_time_str=s);let d=await n.collection(i).add(r);return d.id?d.id:null},del:async function(e,t){let{db:n,_:a}=t,{dbName:i,whereJson:r}=e,o=0;if(r&&"{}"!==JSON.stringify(r)){let e=await n.collection(i).where(r).remove();e?o=e.deleted:(console.error(e.errMsg),o=-1)}else console.error("whereJson条件不能为空");return o},update:async function(e,t){let{db:n,_:a}=t,{dbName:i,whereJson:r,dataJson:o}=e,l=0;if(r&&"{}"!==JSON.stringify(r)){let e=await n.collection(i).where(r).update(o);e?l=e.updated:(console.error(e.errMsg),l=-1)}else console.error("whereJson条件不能为空");return l},select:async function(e,t){let{db:n,_:a}=t,{dbName:i,whereJson:r,pageSize:o=10}=e;if(r&&"{}"!==JSON.stringify(r)||(r={_id:a.neq("___")}),o<=0&&(o=999999999),o>100)return await p.selectAll(e,t);let l=await p.getSelectData(e,t),{result:s,hasMore:d,total:c,getCount:u,pageIndex:g}=l;return s=s.skip((g-1)*o).limit(o),s.get().then(e=>{let t={};return u?(t.hasMore=d,t.total=c):(t.total=e.data?e.data.length:0,t.hasMore=t.total>=o),t.rows=e.data,t.code=0,t.key=1,t.pageIndex=g,t.pageSize=o,t})},findById:async function(e,t){let{db:n,_:a}=t,{dbName:i,id:r,fieldJson:o}=e;try{let e=n.collection(i).doc(r);return o&&(e=e.field(o)),(await e.get()).data[0]}catch(e){return console.error(e),null}},findByWhereJson:async function(e,t){let{db:n,_:a}=t,{dbName:i,whereJson:r,fieldJson:o}=e;try{if(r&&"{}"!==JSON.stringify(r)){let e=n.collection(i).where(r);o&&(e=e.field(o));let t=await e.limit(1).get();if(t.data&&t.data.length>0)return t.data[0]}else console.error("whereJson条件不能为空")}catch(e){console.error(e)}return null},count:async function(e,t){let{db:n,_:a}=t,{dbName:i,whereJson:r}=e;r&&"{}"!==JSON.stringify(r)||(r={_id:a.neq("___")});try{return(await n.collection(i).where(r).count()).total}catch(e){return console.error(e),null}},select2:async function(e,t){let{foreignKeyType:n="many-to-one"}=e;return"many-to-one"===n?await p.select2_ManyToOne(e,t):"one-to-many"===n?await p.select2_OneToMany(e,t):(console.error("不支持的foreignKeyType"),{})},count2_ManyToOne:async function(e,t){let{db:n,_:a,vk:i}=t,{dbName:r,dbName2:o,foreignKey:l="_id",foreignKey2:s="_id",whereJson:d={},whereJson2:c={},pageIndex:u=1,pageSize:g=10,getCount:f=!1,sortArr:p={},fieldJson:y={},fieldJson2:m={},as:w}=e;w||(w=o),"{}"===JSON.stringify(d)&&(d={_id:a.neq("___")});a.aggregate;let _=n.collection(r).aggregate();if(d&&"{}"!==JSON.stringify(d)&&(_=_.match(d)),y&&"{}"!==JSON.stringify(y)&&(_=_.project(y)),p&&"{}"!==JSON.stringify(p)){let e={};for(let t in p){let n=p[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}_=_.sort(e)}let h={from:o,localField:l,foreignField:s,as:w};if(_=_.lookup(h),m&&"{}"!==JSON.stringify(m)){let e={};for(let t in m)e[w+"."+t]=m[t];_=_.project(e)}if(c&&"{}"!==JSON.stringify(c)){let e={};for(let t in c)e[w+"."+t]=c[t];_=_.match(e)}let b=await _.count("total").end();try{return b.data[0].total}catch(e){return console.log(e),0}},select2_ManyToOne:async function(e,t){let{db:n,_:a,vk:i}=t,{dbName:r,dbName2:o,foreignKey:l="_id",foreignKey2:s="_id",whereJson:d={},whereJson2:c={},pageIndex:u=1,pageSize:g=10,getCount:f=!1,sortArr:p=[],fieldJson:y={},fieldJson2:m={},as:w,whereJsonPub:_={}}=e;w||(w=o),"{}"===JSON.stringify(d)&&(d={_id:a.neq("___")}),-1==g&&(u=1,g=999999999,f=!1);let h=0,b=!1;if(f){h=(await n.collection(r).where(d).count()).total,u<Math.ceil(h/g)&&(b=!0)}let x={};const N=a.aggregate;let S=n.collection(r).aggregate();if(d&&"{}"!==JSON.stringify(d)&&(S=S.match(d)),y&&"{}"!==JSON.stringify(y)&&(S=S.project(y)),p&&"[]"!==JSON.stringify(p)){let e={};for(let t in p){let n=p[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}S=S.sort(e)}S=S.skip((u-1)*g).limit(g);let k=N.pipeline().match(a.expr(N.and([N.eq(["$"+s,"$$foreignKey"+l])])));c&&"{}"!==JSON.stringify(c)&&(k=k.match(c)),m&&"{}"!==JSON.stringify(m)&&(k=k.project(m)),k=k.done();let O={};O["foreignKey"+l]="$"+l;let J={from:o,let:O,pipeline:k,as:w};S=S.lookup(J),_&&"{}"!==JSON.stringify(_)&&(S=S.match(_)),S=await S.end();let v=S.data;for(let e in v)v[e][w]&&v[e][w].length>0?v[e][w]=v[e][w][0]:v[e][w]={};return f?(x.hasMore=b,x.total=h):(x.total=v?v.length:0,x.hasMore=h>=g),x.rows=v,x.code=0,x.key=1,x},select2_OneToMany:async function(e,t){let{db:n,_:a,vk:i}=t,{dbName:r,dbName2:o,foreignKey:l="_id",foreignKey2:s="_id",whereJson:d={},whereJson2:c={},pageIndex:u=1,pageSize:g=10,getCount:f=!1,sortArr:p=[],sortArr2:y=[],fieldJson:m={},fieldJson2:w={},as:_}=e;_||(_=o),"{}"===JSON.stringify(d)&&(d={_id:a.neq("___")}),-1==g&&(u=1,g=999999999,f=!1);let h=0,b=!1;if(f){h=(await n.collection(r).where(d).count()).total,u<Math.ceil(h/g)&&(b=!0)}let x={};const N=a.aggregate;let S=n.collection(r).aggregate();if(d&&"{}"!==JSON.stringify(d)&&(S=S.match(d)),m&&"{}"!==JSON.stringify(m)&&(S=S.project(m)),p&&"[]"!==JSON.stringify(p)){let e={};for(let t in p){let n=p[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}S=S.sort(e)}S=S.skip((u-1)*g).limit(g);let k=N.pipeline().match(a.expr(N.and([N.eq(["$"+s,"$$foreignKey"+l])])));if(c&&"{}"!==JSON.stringify(c)&&(k=k.match(c)),y&&"[]"!==JSON.stringify(y)){let e={};for(let t in y){let n=y[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}k=k.sort(e)}w&&"{}"!==JSON.stringify(w)&&(k=k.project(w)),k=k.done();let O={};O["foreignKey"+l]="$"+l;let J={from:o,let:O,pipeline:k,as:_};S=S.lookup(J),S=await S.end();let v=S.data;return f?(x.hasMore=b,x.total=h):(x.total=v?v.length:0,x.hasMore=h>=g),x.rows=v,x.code=0,x.key=1,x},getSelectData:async function(e,t){let{db:n,_:a}=t,{dbName:i,whereJson:r,pageIndex:o=1,pageSize:l=10,getCount:s=!1}=e;r&&"{}"!==JSON.stringify(r)||(r={_id:a.neq("___")}),l<0&&(o=1,l=999999999,s=!0);let d=e.sortArr,c=e.fieldJson,u=0,g=!1;if(s){u=(await n.collection(i).where(r).count()).total,o<Math.ceil(u/l)&&(g=!0)}let f=n.collection(i);if(c&&(f=f.field(c)),r&&(f=f.where(r)),d)for(let e in d){let t=d[e],n=t.name,a=t.type;null!=a&&""!=a||(a="asc"),f=f.orderBy(n,a)}return{result:f,dbName:i,whereJson:r,pageIndex:o,pageSize:l,getCount:s,sortArr:d,fieldJson:c,total:u,hasMore:g}},selectAll:async function(e,t){let{db:n,_:a,vk:i,config:r}=t,o=(e.dbName,{}),l=500;i.pubfn.getData(r,"vk.db.unicloud")&&(l=i.pubfn.getData(r,"vk.db.unicloud.max_limit"));let s=await p.getSelectData(e,t),{result:d,hasMore:c,total:u,getCount:g,pageIndex:f,pageSize:y}=s;y>0&&!u&&!g&&(u=y);let m={};if(g&&0===u)m={data:[]};else{let t=u;y<u&&(t=y);let n=Math.ceil(t/l),a=[],i=(f-1)*y,r=i+y;for(let e=0;e<n;e++){let t=i+e*l,n=l;t+l>r&&(n=r-t);let o=d.skip(t).limit(n).get();a.push(o)}try{m=(await Promise.all(a)).reduce((e,t)=>({data:e.data.concat(t.data),errMsg:e.errMsg}))}catch(t){console.error("selectAll-异常",e,t),m={data:[]}}}return o.rows=m.data,o.key=1,o.code=0,o.hasMore=c,o.pageIndex=f,o.pageSize=y,o.total=g?u:m.data?m.data.length:0,o},sum:async function(e,t){let{db:n,_:a}=t,{dbName:i,fieldName:r,whereJson:o}=e;o&&"{}"!==JSON.stringify(o)||(o={_id:a.neq("___")});const l=n.command.aggregate;try{return(await n.collection(i).aggregate().match(o).group({_id:null,num:l.sum("$"+r)}).end()).data[0].num}catch(e){return console.error(e),null}},avg:async function(e,t){let{db:n,_:a}=t,{dbName:i,fieldName:r,whereJson:o}=e;o&&"{}"!==JSON.stringify(o)||(o={_id:a.neq("___")});const l=n.command.aggregate;try{return(await n.collection(i).aggregate().match(o).group({_id:null,num:l.avg("$"+r)}).end()).data[0].num}catch(e){return console.error(e),null}},max:async function(e,t){let{db:n,_:a}=t,{dbName:i,fieldName:r,whereJson:o}=e;o&&"{}"!==JSON.stringify(o)||(o={_id:a.neq("___")});const l=n.command.aggregate;try{return(await n.collection(i).aggregate().match(o).group({_id:null,num:l.max("$"+r)}).end()).data[0].num}catch(e){return console.error(e),null}},min:async function(e,t){let{db:n,_:a}=t,{dbName:i,fieldName:r,whereJson:o}=e;o&&"{}"!==JSON.stringify(o)||(o={_id:a.neq("___")});const l=n.command.aggregate;try{return(await n.collection(i).aggregate().match(o).group({_id:null,num:l.min("$"+r)}).end()).data[0].num}catch(e){return console.error(e),null}},selects:async function(e,t){let{db:n,_:a,vk:i}=t,{dbName:r,foreignKey:o="_id",whereJson:l={},pageIndex:s=1,pageSize:d=10,getCount:c=!1,sortArr:u=[],fieldJson:g={},foreignDB:f=[]}=e;"{}"===JSON.stringify(l)&&(l={_id:a.neq("___")}),-1==d&&(s=1,d=999999999,c=!1);let p=0,y=!1;if(c){p=(await n.collection(r).where(l).count()).total,s<Math.ceil(p/d)&&(y=!0)}let m={};const w=a.aggregate;let _=n.collection(r).aggregate();if(l&&"{}"!==JSON.stringify(l)&&(_=_.match(l)),g&&"{}"!==JSON.stringify(g)&&(_=_.project(g)),u&&"[]"!==JSON.stringify(u)){let e={};for(let t in u){let n=u[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}_=_.sort(e)}_=_.skip((s-1)*d).limit(d);for(let e in f){let{dbName:t,foreignKey:n,as:i,limit:r,whereJson:l,fieldJson:s,sortArr:d}=f[e];i||(i=t);let c=w.pipeline().match(a.expr(w.and([w.eq(["$"+n,"$$foreignKey"+o])])));if(l&&"{}"!==JSON.stringify(l)&&(c=c.match(l)),d&&"[]"!==JSON.stringify(d)){let e={};for(let t in d){let n=d[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}c=c.sort(e)}r&&(c=c.limit(r)),s&&"{}"!==JSON.stringify(s)&&(c=c.project(s)),c=c.done();let u={};u["foreignKey"+o]="$"+o;let g={from:t,let:u,pipeline:c,as:i};_=_.lookup(g)}_=await _.end();let h=_.data;for(let e in h)for(let t in f){let{as:n,limit:a}=f[t];1===a&&(h[e][n]&&h[e][n].length>0?h[e][n]=h[e][n][0]:h[e][n]={})}return c?(m.hasMore=y,m.total=p):(m.total=h?h.length:0,m.hasMore=p>=d),m.rows=h,m.code=0,m.key=1,m}},y=p,m=async(e={})=>{"[object object]"==Object.prototype.toString.call(e.content)&&(e.content=JSON.stringify(e.content)),void 0===e.dataType&&(e.dataType="json"),"default"==e.dataType&&delete e.dataType,e.useContent&&(e.content=JSON.stringify(e.data)),e.method||(e.method="POST"),e.data&&(e.headers||(e.headers={"content-type":"application/json; charset=UTF-8"}));var t=await uniCloud.httpclient.request(e.url,e);return t&&t.data?t.data:t},w={formValidateItem:function(e,t,n){let a={code:0,msg:"ok"};for(let i in n){let r=n[i];if(null==e[t]){a={type:"undefined",code:-1,msg:"字段："+t+" 名称错误，请检查！",key:t,value:e[t]};break}if(r.required&&(null==e[t]||null==e[t]||""===e[t]||0==e[t].length)){a={type:"required",code:-1,msg:r.message,key:t,value:e[t]};break}if(r.type&&["string","number","boolean"].indexOf(r.type)>-1&&typeof e[t]!=r.type){a={type:"type",code:-1,msg:r.message,key:t,value:e[t]};break}if(r.len&&e[t].length!=r.len){a={type:"len",code:-1,msg:r.message,key:t,value:e[t]};break}if(r.min)if(r.type&&"number"==r.type){if(e[t]<r.min){a={type:"min",code:-1,msg:r.message,key:t,value:e[t]};break}}else if(e[t].length<r.min){a={type:"min",code:-1,msg:r.message,key:t,value:e[t]};break}if(r.max)if(r.type&&"number"==r.type){if(e[t]>r.max){a={type:"max",code:-1,msg:r.message,key:t,value:e[t]};break}}else if(e[t].length>r.max){a={type:"max",code:-1,msg:r.message,key:t,value:e[t]};break}}return a}},_={formValidate:function(e={}){let t={code:0,msg:"ok"},{data:n,rules:a}=e;if(a)for(let e in a){let i=a[e];if(t=w.formValidateItem(n,e,i),0!=t.code)break}return t},urlStringToJson:function(e){var t={};if(""!=e&&null!=e&&null!=e)for(var n=e.split("&"),a=0;a<n.length;a++){var i=n[a].split("="),r=i[0],o=i[1];t[r]=o}return t},getQueryStringParameters:function(e){let t={};if(e.httpMethod){if(console.log("event.path:",e.path),e.body){let n=e.body;e.isBase64Encoded&&(n=Buffer.from(n,"base64").toString("utf-8")),"string"==typeof n&&(n=JSON.parse(n)),t=n}else if(e.queryStringParameters){let n=e.queryStringParameters;"string"==typeof n.data&&(n.data=JSON.parse(n.data)),t=n}}else t=JSON.parse(JSON.stringify(e));return t.data||(t.data={}),t.url=t.$url||"",t},deleteObjectKeys:function(e,t=[]){var n={};if(e)for(let a in e)-1==t.indexOf(a)&&(n[a]=e[a]);return n},stringToFormData:function(e){e||(e="");for(var t=e.split("Content-Disposition: form-data;"),n={},a=0;a<t.length;a++){var i=t[a];let e='name="';var r=i.indexOf(e)+e.length;if(r>-1){var o=i.indexOf('"',r),l=i.substring(r,o);if(o>r){var s=i.indexOf("---",o),d=i.substring(o+1,s).trim();n[l]=d}}}return n},getFullTime:function(e,t=0){if("number"==typeof e)e=new Date(e);else if("object"==typeof e){let t="",n={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"};return t=e.toLocaleString("zh-CN",n),t=t.replace(new RegExp(/[^\d\.]/,"g"),""),t}let n=e.getFullYear()+"",a=e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1,i=e.getDate()<10?"0"+e.getDate():e.getDate(),r=e.getHours()<10?"0"+e.getHours():e.getHours(),o=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),l=e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds();return 1==t?n+""+a+i+r+o+l:n+"-"+a+"-"+i+" "+r+":"+o+":"+l},checkStr:function(e,t){switch(t){case"mobile":return new RegExp(/^1[3|4|5|6|7|8|9][0-9]{9}$/).test(e);case"tel":return new RegExp(/^(0\d{2,3}-\d{7,8})(-\d{1,4})?$/).test(e);case"card":return new RegExp(/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/).test(e);case"mobileCode":return new RegExp(/^[0-9]{6}$/).test(e);case"username":return new RegExp(/^[a-zA-Z]([-_a-zA-Z0-9]{5,17})$/).test(e);case"pwd":return new RegExp(/^([a-zA-Z0-9_]){6,18}$/).test(e);case"payPwd":return new RegExp(/^[0-9]{6}$/).test(e);case"postal":return new RegExp(/[1-9]\d{5}(?!\d)/).test(e);case"QQ":return new RegExp(/^[1-9][0-9]{4,9}$/).test(e);case"email":return new RegExp(/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/).test(e);case"money":return new RegExp(/^\d*(?:\.\d{0,2})?$/).test(e);case"URL":return new RegExp(/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/).test(e);case"IP":return new RegExp(/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/).test(e);case"date":return new RegExp(/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])$/).test(e);case"time":return new RegExp(/^(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/).test(e);case"dateTime":return new RegExp(/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])\s+(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/).test(e);case"number":return new RegExp(/^[0-9]*$/).test(e);case"english":return new RegExp(/^[a-zA-Z]+$/).test(e);case"chinese":return new RegExp(/^[\\u4E00-\\u9FA5]+$/).test(e);case"lower":return new RegExp(/^[a-z]+$/).test(e);case"upper":return new RegExp(/^[A-Z]+$/).test(e);case"HTML":return new RegExp(/<("[^"]*"|'[^']*'|[^'">])*>/).test(e);default:return!0}},priceFilter:function(e){return"string"==typeof e&&(e=parseFloat(e)),(e/100).toFixed(2)},objectAssign:function(e,t){return Object.assign(e,t)},copyObject:function(e){return JSON.parse(JSON.stringify(e))},toTimeLong:function(e){if(!e)return"";e=(e=e.substring(0,19)).replace(new RegExp(/-/,"g"),"/");var t=new Date(e).getTime();return isNaN(t)&&(t=""),t},arr_concat:function(e,t,n){n||(n="id");var a=e.concat(t),i=[];if(-1!=n){var r=[];for(var o in a)-1==r.indexOf(a[o][n])&&(r.push(a[o][n]),i.push(a[o]))}else i=a;return i},getData:function(e,t){var n=JSON.parse(JSON.stringify(e));t=t.replace(/\s+/g,"")+".";for(var a="",i=0;i<t.length;i++){var r=t.charAt(i);"."!=r&&"["!=r&&"]"!=r?a+=r:n&&(""!=a&&(n=n[a]),a="")}return n},setData:function(e,t,n){const a=t.match(/([\w$]+)|\[(:\d)\]/g);for(let t=0;t<a.length-1;t++){e=e[a[t]]}e[a[a.length-1]]=n},isNull:function(e){let t=!1;return void 0!==e&&"[object Null]"!=Object.prototype.toString.call(e)&&"{}"!=JSON.stringify(e)&&"[]"!=JSON.stringify(e)&&""!==e&&void 0!==JSON.stringify(e)||(t=!0),t},isNotNull:function(e){return!_.isNull(e)},isNullOne:function(...e){let t=!1;for(let n=0;n<e.length;n++){let a=e[n];if(_.isNull(a)){t=!0;break}}return t},isNullAll:function(...e){let t=!0;for(let n=0;n<e.length;n++){let a=e[n];if(_.isNotNull(a)){t=!1;break}}return t},isNotNullAll:function(...e){return!_.isNullOne(...e)},getListItem:function(e,t,n){let a;for(let i in e)if(e[i][t]===n){a=e[i];break}return a},listToJson:function(e,t){let n={};for(let a in e){let i=e[a];n[i[t]]=i}return n},random:function(e,t){let n="",a="123456789";_.isNotNull(t)&&("a-z,0-9"==t?t="abcdefghijklmnopqrstuvwxyz0123456789":"A-Z,0-9"==t?t="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789":"a-z,A-Z,0-9"!=t&&"A-Z,a-z,0-9"!=t||(t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"),a=t);for(let t=0;t<e;t++){n+=a[Math.floor(Math.random()*a.length)]}return n},stringIdToNumberId:function(e,t){let n="";for(let a=0;a<t;a++)if(e.length>a){n+="0123456789"[e[a].charCodeAt()%10]}else n="0"+n;return n},calcFreights:function(e,t){let{first_weight:n,first_weight_price:a,continuous_weight:i,continuous_weight_price:r,max_weight:o=1e8}=e,l=0,s=0,d=o,c=!1,u=0;for(;t>0;)c?(u++,t-=i,d-=i):(c=!0,s++,d=o,t-=n,d-=n),d<=0&&(c=!1);return l=s*a+r*u,l},checkArrayIntersection:function(e=[],t=[]){let n=!1;for(let a=0;a<t.length;a++)e.indexOf(t[a])>-1&&(n=!0);return n},getWeekStartAndEnd:function(e){let t={},n=new Date;n=new Date(n.getTime()+6048e5*e);let a=n.getDay(),i=(n.getDate(),0!=a?a-1:6),r=new Date(n.getTime()-864e5*i),o=new Date(r.getTime()+5184e5);return r=new Date(new Date(r.toLocaleDateString()).getTime()),o=new Date(new Date(o.toLocaleDateString()).getTime()+86399999),t.weekStart=r,t.weekEnd=o,t},getCommonTime:function(e=new Date){let t={};const n=e.getFullYear(),a=e.getMonth()+1;e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds();let i=new Date(n,a,0).getDate(),r=new Date(n,12,0).getDate();t.todayStart=new Date(new Date((new Date).toLocaleDateString()).getTime()),t.todayEnd=new Date(new Date((new Date).toLocaleDateString()).getTime()+86399999),t.monthStart=new Date(new Date(`${n}/${a}/1`).getTime()),t.monthEnd=new Date(new Date(`${n}/${a}/${i}`).getTime()+86399999),t.yearStart=new Date(new Date(n+"/1/1").getTime()),t.yearEnd=new Date(new Date(`${n}/12/${r}`).getTime()+86399999);let o=_.getWeekStartAndEnd(0);return t.weekStart=o.weekStart,t.weekEnd=o.weekEnd,t},getNewObject:function(e,t){let n={};if(t&&t.length>0)for(let a in t){let i=t[a];_.isNotNull(e[i])&&(n[i]=e[i])}else n=_.copyObject(e);return n}},h=_;try{g=t}catch(e){}var b={sendSmsByAliyun:async function(e,t){let{config:n,data:a,requestOption:i={method:"POST"}}=e;if(n&&"{}"!=JSON.stringify(n)||(n=t.vk.pubfn.getData(t.config,"vk.service.sms.aliyun")),!n||"{}"==JSON.stringify(n))return{code:-1,msg:"阿里云短信配置错误,请检查!"};var r=new g(n);a.SignName||(a.SignName=n.SignName),"object"==typeof a.TemplateParam&&(a.TemplateParam=JSON.stringify(a.TemplateParam));let o=await r.request("SendSms",a,i);return"OK"!=o.Code?{code:-1,msg:o.Message}:{code:0,msg:""}},sendSmsVerifyCode:async function(e,t){let{mobile:n,code:a,provider:i}=e,r=t.vk.pubfn.getData(t.config,"vk.service.sms."+i);return r&&"{}"!=JSON.stringify(r)?"aliyun"==i?await t.vk.smsUtil.sendSmsByAliyun({config:r,data:{PhoneNumbers:n,TemplateCode:r.TemplateCode.verifyCode,TemplateParam:{code:a}}},t):{code:-1,msg:"provider错误，请检查！"}:{code:-1,msg:"短信配置错误，请检查！"}}},x=b;var N={addAsyncTasks:async(e={},t)=>{let{vk:n,db:a,_:i}=t,{type:r,title:o,out_trade_no:l,user_order_success:s}=e,d={};return d=await n.baseDao.add({dbName:"uni-pay-async-tasks",dataJson:{status:0,type:r,title:o,out_trade_no:l,user_order_success:s}},t),d},addPayOrders:async(e={},t)=>{let{vk:n,db:a,_:i}=t,{pay_type:r,out_trade_no:o,openid:l,total_fee:s,appid:d,original_data:c,wxpay_info:u,alipay_info:g}=e,f={};return f=await n.baseDao.add({dbName:"uni-pay-orders",dataJson:{pay_type:r,out_trade_no:o,openid:l,total_fee:s,appid:d,original_data:c,wxpay_info:u,alipay_info:g}},t),f},findPayOrdersByOutTradeNo:async(e="___",t)=>{let{vk:n,db:a,_:i}=t,r={};return r=await n.baseDao.findByWhereJson({dbName:"uni-pay-orders",whereJson:{out_trade_no:e}},t),r}},S=N,k={pay:async(e={},t)=>{let{uniPay:n,config:a,vk:i,db:r,_:o}=t,{data:l={},userInfo:s,provider:d,originalParam:c}=e,{outTradeNo:u,subject:g="",body:f="",totalFee:p}=l;const{wxConfigMp:y,wxConfigApp:m,wxConfigH5:w,aliConfigMp:_,aliConfigApp:h,aliConfigH5:b,notifyUrl:x,alipay_app_to_h5:N}=a["uni-pay"];let S,k,O,J=d+"_"+c.context.PLATFORM;N&&"alipay_app-plus"==J&&(J="alipay_h5");var v=x+"/"+J;switch(J){case"wxpay_mp-weixin":S=n.initWeixin(y),k=s.wx_openid["mp-weixin"],O="JSAPI";break;case"wxpay_app-plus":S=n.initWeixin(m),O="APP";break;case"wxpay_h5":S=n.initWeixin(w),O="NATIVE";break;case"alipay_mp-alipay":S=n.initAlipay(_),k=s.ali_openid;break;case"alipay_app-plus":S=n.initAlipay(h),O="APP";break;case"alipay_h5":S=n.initAlipay(b),O="NATIVE";break;default:return{code:-1,msg:"参数错误",value:d+"_"+c.context.PLATFORM}}let T;try{k&&(l.openid=k),l.notifyUrl=v,l.tradeType=O,"alipay"===d&&void 0===l.extendParams&&(l.extendParams={sysServiceProviderId:"2088731216435275"}),T=await S.getOrderInfo(l)}catch(e){return console.log("error: ",e.message),{code:-3,msg:"获取支付信息失败，请稍后再试。"+e.message}}return{code:0,msg:"ok",outTradeNo:u,orderInfo:T}},payNotify:async function(e){let{event:t,context:n,vk:a,orderPaySuccess:i}=e,{config:r,uniPay:o,db:l,customFilterService:s,customUtil:d}=a.config,c={vk:a,config:r,uniPay:o,db:l,customUtil:d,_:l.command};const{wxConfigMp:u,wxConfigApp:g,wxConfigH5:f,aliConfigMp:p,aliConfigApp:y,aliConfigH5:m,alipay_app_to_h5:w}=r["uni-pay"];(new Date).getTime();let _,h=t.path.substring(1);switch(w&&"alipay_app-plus"==h&&(h="alipay_h5"),h){case"wxpay_mp-weixin":_=o.initWeixin(u);break;case"wxpay_app-plus":_=o.initWeixin(g);break;case"wxpay_h5":_=o.initWeixin(f);break;case"alipay_mp-alipay":_=o.initAlipay(p);break;case"alipay_app-plus":_=o.initAlipay(y);break;case"alipay_h5":_=o.initAlipay(m);break;default:return console.log("---------参数错误---------"),{code:-1,msg:"参数错误"}}let b=await _.verifyPaymentNotify(t);if(!b)return console.log("---------!验证未通过!---------"),{};let x,N,{outTradeNo:k,totalFee:O,transactionId:J,resultCode:v,openid:T,appId:A}=b;0==h.indexOf("wxpay_")?x=b:0==h.indexOf("alipay_")&&(N=b);let D=!1;return"function"==typeof i&&(D=await i({util:c,data:b})),"SUCCESS"==v&&(await S.addAsyncTasks({type:1001,title:`订单【${k}】付款成功`,out_trade_no:k,user_order_success:D},c),await S.addPayOrders({pay_type:h,out_trade_no:k,openid:T,total_fee:O,appid:A,original_data:t.body,wxpay_info:x,alipay_info:N},c)),0==h.indexOf("wxpay_")?{mpserverlessComposedResponse:!0,statusCode:200,headers:{"content-type":"text/xml"},body:"<xml><return_code><![CDATA[SUCCESS]]></return_code><return_msg><![CDATA[OK]]></return_msg></xml>"}:(h.indexOf("alipay_"),"SUCCESS")},payQuery:async(e={},t)=>{let{uniPay:n,config:a,vk:i,db:r,_:o}=t,{data:l={}}=e,{outTradeNo:s}=l,d={code:-1,msg:""};const{wxConfigMp:c,wxConfigApp:u,wxConfigH5:g,aliConfigMp:f,aliConfigApp:p,aliConfigH5:y,notifyUrl:m}=a["uni-pay"];if(!s)return{code:-1,msg:"订单号不能为空"};let w=await S.findPayOrdersByOutTradeNo(s,t);if(!w)return{code:-2,msg:"订单不存在或订单未支付!"};let _;switch(w.pay_type){case"wxpay_mp-weixin":_=n.initWeixin(c);break;case"wxpay_app-plus":_=n.initWeixin(u);break;case"wxpay_h5":_=n.initWeixin(g);break;case"alipay_mp-alipay":_=n.initAlipay(f);break;case"alipay_app-plus":_=n.initAlipay(p);break;case"alipay_h5":_=n.initAlipay(y);break;default:return{code:-1,msg:"参数错误"}}let h=await _.orderQuery({outTradeNo:s});if("SUCCESS"===h.tradeState||"FINISHED"===h.tradeState)d={code:0,msg:"支付成功",orderPaid:!0};else{let e=h.tradeStateDesc||"未支付或已退款";e.indexOf("订单发生过退款")>-1&&(e="订单已退款"),d={code:-1,msg:e,orderPaid:!1}}return d},refund:async(e={},t)=>{let{uniPay:n,config:a,vk:i,db:r,_:o}=t,{data:l={},originalParam:s,orderRefundSuccess:d}=e,{outTradeNo:c}=l,u={code:-1,msg:""};const{wxConfigMp:g,wxConfigApp:f,wxConfigH5:p,aliConfigMp:y,aliConfigApp:m,aliConfigH5:w,notifyUrl:_}=a["uni-pay"];let h=c;if(!c)return{code:-1,msg:"订单号不能为空"};let b=await S.findPayOrdersByOutTradeNo(c,t);if(!b)return{code:-2,msg:"订单不存在或订单未支付!"};let x=b.total_fee,N=x;const k=b.pay_type;let O;switch(k){case"wxpay_mp-weixin":O=n.initWeixin(g);break;case"wxpay_app-plus":O=n.initWeixin(f);break;case"wxpay_h5":O=n.initWeixin(p);break;case"alipay_mp-alipay":O=n.initAlipay(y);break;case"alipay_app-plus":O=n.initAlipay(m);break;case"alipay_h5":O=n.initAlipay(w);break;default:return{code:-1,msg:"参数错误,暂不支持"+k}}let J=!1;return"function"==typeof d&&(J=await d({payOrder:b})),await S.addAsyncTasks({type:1011,title:`订单【${c}】退款成功`,out_trade_no:c,user_order_success:J},t),console.log(`---- ${c} -- ${h} -- ${x} -- ${N}`),u=await O.refund({outTradeNo:c,outRefundNo:h,totalFee:x,refundFee:N}),u.outTradeNo?(u.code=0,u.msg="退款成功"):(u.code=-1,u.msg="退款失败"),u},refundQuery:async(e={},t)=>{let{uniPay:n,config:a,vk:i,db:r,_:o}=t,{data:l={}}=e,{outTradeNo:s}=l,d={code:-1,msg:""};const{wxConfigMp:c,wxConfigApp:u,wxConfigH5:g,aliConfigMp:f,aliConfigApp:p,aliConfigH5:y,notifyUrl:m}=a["uni-pay"];if(!s)return{code:-1,msg:"订单号不能为空"};let w=await S.findPayOrdersByOutTradeNo(s,t);if(!w)return{code:-2,msg:"订单不存在或订单未支付!"};let _,h;switch(w.pay_type){case"wxpay_mp-weixin":_=n.initWeixin(c);break;case"wxpay_app-plus":_=n.initWeixin(u);break;case"wxpay_h5":_=n.initWeixin(g);break;case"alipay_mp-alipay":_=n.initAlipay(f);break;case"alipay_app-plus":_=n.initAlipay(p);break;case"alipay_h5":_=n.initAlipay(y);break;default:return{code:-1,msg:"参数错误"}}let b={};try{h=await _.refundQuery({outTradeNo:s,outRefundNo:s})}catch(e){return{code:-1,msg:"查询失败,请稍后再试!",err:e,refundQueryJson:b,queryResult:h}}if(h.refundFee>0){let e="退款成功";for(let t in h.refundList){let n=h.refundList[t];e+=`${t+1}、 ${n.refundSuccessTime}: \r\n退款到 ${n.refundRecvAccout};\r\n`}d={code:0,msg:e,queryResult:h}}else d={code:-1,msg:"未退款",queryResult:h};return d}},O=k,J={},v={};J.get=function(e){let t,n=v[e];if(n){let{value:a,expired:i}=n;J.isExpired(e)?delete v[e]:t=a}return t},J.set=function(e,t,n=0){let a={value:t,expired:n>0?(new Date).getTime()+1e3*n:0};v[e]=a},J.del=function(e){delete v[e]},J.clear=function(e){if(e)for(let t in v)0==t.indexOf(e)&&delete v[t];else v={}},J.isExpired=function(e){let t=!0,n=v[e];return n&&(0==n.expired||n.expired>(new Date).getTime())&&(t=!1),t},J.getAll=function(e){let t={};if(e)for(let n in v)0==n.indexOf(e)&&(t[e]=v[e]);else t=v;for(let e in t)J.isExpired(e)&&(delete t[e],delete v[e]);return t};var T=J,A={};A.router=r,A.md5=f,A.baseDao=y,A.request=m,A.pubfn=h,A.smsUtil=x,A.payUtil=O,A.temporaryCache=T,A.requireCache={},A.require=function(e){if(A.requireCache&&A.requireCache[e])return A.requireCache[e];{const t=function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}();return A.requireCache[e]=t,t}},A.config={},A.init=function(e){A.config.config=e.config,A.config.uniID=e.uniID,A.config.db=e.db,A.config.pubFun=e.pubFun,A.config.customFilterService=e.customFilterService,A.config.customUtil=e.customUtil,A.config.uniPay=e.uniPay},A.getQueryStringParameters=function(e){let t={};if(e.httpMethod){if(e.body){let n=e.body;e.isBase64Encoded&&(n=Buffer.from(n,"base64").toString("utf-8")),"string"==typeof n&&(n=JSON.parse(n)),t=n}else if(e.queryStringParameters){let n=e.queryStringParameters;"string"==typeof n.data&&(n.data=JSON.parse(n.data)),t=n}}else t=JSON.parse(JSON.stringify(e));return t.data||(t.data={}),t.uniIdToken||(t.uniIdToken=t.uni_id_token),t.url=t.$url||"",t};var D=A;module.exports=D;
