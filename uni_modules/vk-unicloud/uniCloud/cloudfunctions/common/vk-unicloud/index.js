"use strict";var e={main:async e=>{let{url:t,data:n={},util:a}=e,{uniID:i}=a,{need_user_info:r=!0}=n,o={code:-1,msg:""},s=t.indexOf("/sys/")>-1,l=await i.checkToken(e.uniIdToken,{needPermission:s,needUserInfo:r});if(l.code&&l.code>0)return l;if(l.userInfo){let e=l.userInfo;e.permission=l.permission,delete e.token,delete e.password,o.userInfo=e}return o.uid=l.uid,l.token&&(o.token=l.token,o.tokenExpired=l.tokenExpired),o.code=0,o.msg="ok",o}};async function t(e={},t){let{vk:n,db:a,_:i}=t,{whereJson:r={},fieldJson:o={},justNeedID:s=!1}=e;s&&(o={permission_id:!0}),r.enable=!0;let l=[],d=await n.baseDao.select({dbName:"uni-id-permissions",pageIndex:1,pageSize:500,fieldJson:o,whereJson:r});if(s)for(let e=0;e<d.rows.length;e++){let t=d.rows[e];l.push(t.permission_id)}else l=d.rows;return l}var n=[{id:"pub",regExp:"/pub/",description:"pub函数为所有人都可以访问的函数",index:100,mode:"onActionExecuting",main:async function(t){let n={};return t.data.need_user_info&&(n=await e.main(t)),n.code=0,n.msg="ok",n}},{id:"kh",regExp:"/kh/",description:"kh函数为必须登录后才能访问的函数(客户端用户)",index:200,mode:"onActionExecuting",main:e.main},{id:"sys",regExp:"/sys/",description:"sys函数为后端管理人员才能访问的函数(商家后台工作人员)",index:300,mode:"onActionExecuting",main:{main:async n=>{let{url:a,util:i}=n,{uniID:r,config:o,pubFun:s,vk:l,db:d,_:c}=i,u={code:-1,msg:""};const p=e;if(u=await p.main(n),0!==u.code)return u;if(u.userInfo.role||(u.userInfo.role=[]),u.userInfo.role.includes("admin"))return u;if(!u.userInfo.allow_login_background)return{code:403,msg:"您无权限登录后台"};let f=[];if(u.userInfo.role.includes("admin-lv3")){let e=await t({whereJson:{level:c.in([1,2,3])},justNeedID:!0},i);l.pubfn.isNotNull(e)&&(f=f.concat(e))}if(u.userInfo.role.includes("admin-lv2")){let e=await t({whereJson:{level:c.in([1,2])},justNeedID:!0},i);l.pubfn.isNotNull(e)&&(f=f.concat(e))}if(u.userInfo.role.includes("admin-lv1")){let e=await t({whereJson:{level:c.in([1])},justNeedID:!0},i);l.pubfn.isNotNull(e)&&(f=f.concat(e))}if(u.userInfo.role.includes("query-all")){let e=await t({whereJson:{curd_category:4,level:c.neq(4)},justNeedID:!0},i);l.pubfn.isNotNull(e)&&(f=f.concat(e))}let g=await async function(e,t){let{vk:n,db:a,_:i}=t,{role:r}=e;if(n.pubfn.isNull(r))return[];return(await n.baseDao.select({dbName:"uni-id-roles",whereJson:{role_id:i.in(r),enable:!0},fieldJson:{permission:!0}})).rows}({role:u.userInfo.role},i);for(let e in g){let{permission:t}=g[e];l.pubfn.isNotNull(t)&&(f=f.concat(t))}if(0==f.length)return{code:403,msg:"权限不足"};f=[...new Set(f)];let m=await t({whereJson:{permission_id:c.in(f),match_mode:c.in([1,2])}},i),y=!1;for(let e=0;e<m.length;e++){let t=m[e];if(1===t.match_mode){if(l.pubfn.wildcardTest(a,t.url)){y=!0;break}}else if(2===t.match_mode&&l.pubfn.regExpTest(a,t.url)){y=!0;break}}if(!y){await async function(e,t){let{vk:n,db:a,_:i}=t,{myPermission:r,url:o}=e;if(n.pubfn.isNull(r))return!1;return await n.baseDao.count({dbName:"uni-id-permissions",whereJson:{enable:!0,permission_id:i.in(r),url:o,match_mode:i.nin([1,2])}})>0}({myPermission:f,url:a},i)&&(y=!0)}return y?(u.code=0,u.msg="ok",u):{code:403,msg:"权限不足"}}}.main}];var a=function(e){let t=[];if(e){let a=[...n,...e];a.sort((function(e,t){return e.index-t.index})),t=a.filter((e,t,n)=>{var i=[];return a.forEach((e,t)=>{i.push(e.id)}),i.indexOf(e.id)===t})}else t=n;return t},i={regExpTest:function(e,t){let n=!1;if("string"==typeof e){new RegExp(e).test(t)&&(n=!0)}else if("object"==typeof e)for(let a=0;a<e.length;a++){if(new RegExp(e[a]).test(t)){n=!0;break}}return n}},r=i,o=async(e,t)=>{let n={code:403,msg:"access denied",filterStack:[]},{url:i}=e;const o=a(t);for(let t in o){let a=o[t],{mode:s="onActionExecuting",enable:l=!0}=a;if("onActionExecuting"===s&&(l&&r.regExpTest(a.regExp,i))){e.filterResponse=n;let t=await a.main(e);if(t.filterId=a.id,n.filterStack.push(t),0!==t.code){n=t;break}n=Object.assign(n,t)}}return n},s=async(e,t,n)=>{let{url:i}=e;const o=a(t);for(let t in o){let a=o[t],{mode:s="onActionExecuting",enable:l=!0}=a;if("onActionExecuted"===s&&(l&&r.regExpTest(a.regExp,i))){let t=await a.main(e,n);if(t){if(0!==t.code){n=t;break}n=Object.assign(n,t)}}}return n};function l(e={}){let{code:t,msg:n,err:a={}}=e;return console.error(n,a),{code:t,msg:n,err:{message:a.message,stack:a.stack,code:a.code}}}process.env.TZ="Asia/Shanghai";var d=async function(e){let{event:t,context:n,vk:a}=e,{config:i,uniID:r,uniPay:d,db:c,middlewareService:u,pubFun:p,customUtil:f}=a.config;const g=r;if(a.pubfn.getData(i,"vk.system.serviceShutdown"))return{code:405,msg:a.pubfn.getData(i,"vk.system.serviceShutdownDescription")};let m,y,h={event:t,context:n},b=function(e){let t={};if(e.httpMethod){if(e.body){let n=e.body;e.isBase64Encoded&&(n=Buffer.from(n,"base64").toString("utf-8")),"string"==typeof n&&(n=JSON.parse(n)),t=n}else if(e.queryStringParameters){let n=e.queryStringParameters;"string"==typeof n.data&&(n.data=JSON.parse(n.data)),t=n}}else t=JSON.parse(JSON.stringify(e));t.data||(t.data={});t.uniIdToken||(t.uniIdToken=t.uni_id_token);return t.url=t.$url||"",t}(t),{url:w,data:_,uniIdToken:k}=b,x={url:w,data:_,uniIdToken:k,util:{vk:a,config:i,pubFun:p,uniID:g,uniPay:d,db:c,customUtil:f,_:c.command},originalParam:h},N=await o(x,u);if(0!==N.code)return N;N.uid&&(_.uid=N.uid),x.filterResponse=N;try{m=a.require("service/"+w)}catch(e){e||(e={});let{code:t,message:n=""}=e;return"MODULE_NOT_FOUND"==t&&n.indexOf("service/")>-1?l({code:404,msg:`云函数 ${w} 不存在!`,err:e}):"MODULE_NOT_FOUND"==t&&n.indexOf("Cannot find module")>-1?l({code:500,msg:n,err:e}):l({code:500,msg:`云函数 ${w} 编译异常!`,err:e})}try{y=await async function(e={}){let{res:t,serviceParam:n,serviceMain:a}=e;t.uid&&(n.uid=t.uid);t.userInfo&&(n.userInfo=t.userInfo);let i=await a.main(n);t.token&&"object"==typeof i&&(i.vk_uni_token={token:t.token,tokenExpired:t.tokenExpired});return i}({res:N,serviceParam:x,serviceMain:m})}catch(e){e||(e={});let{code:t,message:n=""}=e;return"InternalServerError"==t&&n.indexOf("_id_ dup key")>-1?l({code:500,msg:"vk.baseDao.add : _id不能重复添加",err:e}):0===n.indexOf("msg:")?l({code:501,msg:n.substring(4),err:e}):l({code:500,msg:`云函数 ${w} 运行异常!`,err:e})}try{y=await s(x,u,y)}catch(e){return l({code:500,msg:`云函数 ${w} 的中间件运行异常!`,err:e})}return y};function c(e,t,n,a,i,r){return m((o=m(m(t,e),m(a,r)))<<(s=i)|o>>>32-s,n);var o,s}function u(e,t,n,a,i,r,o){return c(t&n|~t&a,e,t,i,r,o)}function p(e,t,n,a,i,r,o){return c(t&a|n&~a,e,t,i,r,o)}function f(e,t,n,a,i,r,o){return c(t^n^a,e,t,i,r,o)}function g(e,t,n,a,i,r,o){return c(n^(t|~a),e,t,i,r,o)}function m(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}var y=function(e){return function(e){for(var t="",n=0;n<4*e.length;n++)t+="0123456789abcdef".charAt(e[n>>2]>>n%4*8+4&15)+"0123456789abcdef".charAt(e[n>>2]>>n%4*8&15);return t}(function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,a=-271733879,i=-1732584194,r=271733878,o=0;o<e.length;o+=16){var s=n,l=a,d=i,c=r;n=u(n,a,i,r,e[o+0],7,-680876936),r=u(r,n,a,i,e[o+1],12,-389564586),i=u(i,r,n,a,e[o+2],17,606105819),a=u(a,i,r,n,e[o+3],22,-1044525330),n=u(n,a,i,r,e[o+4],7,-176418897),r=u(r,n,a,i,e[o+5],12,1200080426),i=u(i,r,n,a,e[o+6],17,-1473231341),a=u(a,i,r,n,e[o+7],22,-45705983),n=u(n,a,i,r,e[o+8],7,1770035416),r=u(r,n,a,i,e[o+9],12,-1958414417),i=u(i,r,n,a,e[o+10],17,-42063),a=u(a,i,r,n,e[o+11],22,-1990404162),n=u(n,a,i,r,e[o+12],7,1804603682),r=u(r,n,a,i,e[o+13],12,-40341101),i=u(i,r,n,a,e[o+14],17,-1502002290),a=u(a,i,r,n,e[o+15],22,1236535329),n=p(n,a,i,r,e[o+1],5,-165796510),r=p(r,n,a,i,e[o+6],9,-1069501632),i=p(i,r,n,a,e[o+11],14,643717713),a=p(a,i,r,n,e[o+0],20,-373897302),n=p(n,a,i,r,e[o+5],5,-701558691),r=p(r,n,a,i,e[o+10],9,38016083),i=p(i,r,n,a,e[o+15],14,-660478335),a=p(a,i,r,n,e[o+4],20,-405537848),n=p(n,a,i,r,e[o+9],5,568446438),r=p(r,n,a,i,e[o+14],9,-1019803690),i=p(i,r,n,a,e[o+3],14,-187363961),a=p(a,i,r,n,e[o+8],20,1163531501),n=p(n,a,i,r,e[o+13],5,-1444681467),r=p(r,n,a,i,e[o+2],9,-51403784),i=p(i,r,n,a,e[o+7],14,1735328473),a=p(a,i,r,n,e[o+12],20,-1926607734),n=f(n,a,i,r,e[o+5],4,-378558),r=f(r,n,a,i,e[o+8],11,-2022574463),i=f(i,r,n,a,e[o+11],16,1839030562),a=f(a,i,r,n,e[o+14],23,-35309556),n=f(n,a,i,r,e[o+1],4,-1530992060),r=f(r,n,a,i,e[o+4],11,1272893353),i=f(i,r,n,a,e[o+7],16,-155497632),a=f(a,i,r,n,e[o+10],23,-1094730640),n=f(n,a,i,r,e[o+13],4,681279174),r=f(r,n,a,i,e[o+0],11,-358537222),i=f(i,r,n,a,e[o+3],16,-722521979),a=f(a,i,r,n,e[o+6],23,76029189),n=f(n,a,i,r,e[o+9],4,-640364487),r=f(r,n,a,i,e[o+12],11,-421815835),i=f(i,r,n,a,e[o+15],16,530742520),a=f(a,i,r,n,e[o+2],23,-995338651),n=g(n,a,i,r,e[o+0],6,-198630844),r=g(r,n,a,i,e[o+7],10,1126891415),i=g(i,r,n,a,e[o+14],15,-1416354905),a=g(a,i,r,n,e[o+5],21,-57434055),n=g(n,a,i,r,e[o+12],6,1700485571),r=g(r,n,a,i,e[o+3],10,-1894986606),i=g(i,r,n,a,e[o+10],15,-1051523),a=g(a,i,r,n,e[o+1],21,-2054922799),n=g(n,a,i,r,e[o+8],6,1873313359),r=g(r,n,a,i,e[o+15],10,-30611744),i=g(i,r,n,a,e[o+6],15,-1560198380),a=g(a,i,r,n,e[o+13],21,1309151649),n=g(n,a,i,r,e[o+4],6,-145523070),r=g(r,n,a,i,e[o+11],10,-1120210379),i=g(i,r,n,a,e[o+2],15,718787259),a=g(a,i,r,n,e[o+9],21,-343485551),n=m(n,s),a=m(a,l),i=m(i,d),r=m(r,c)}return Array(n,a,i,r)}(function(e){for(var t=Array(),n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t}(e),8*e.length))},h={},b={init:function(e){h=e},add:async function(e){let{db:t,_:n,vk:a,config:i}=h,{dbName:r,dataJson:o,db:s,cancelAddTime:l}=e,d=s||t;if(!o._add_time){let e=a.pubfn.getData(i,"vk.db.unicloud.cancelAddTime");if(void 0===l&&e&&(l=e),!l){let e=new Date;o._add_time=e.getTime();let t={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"};o._add_time_str=e.toLocaleString("zh-CN",t)}}let c=await d.collection(r).add(o);return c.id?c.id:null},adds:async function(e){let{db:t,_:n,vk:a,config:i}=h,{dbName:r,dataJson:o,cancelAddTime:s}=e,l=a.pubfn.getData(i,"vk.db.unicloud.cancelAddTime");if(void 0===s&&l&&(s=l),!s){let e=new Date,t=e.getTime(),n={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"},a=e.toLocaleString("zh-CN",n);for(let e in o)o[e]._add_time||(o[e]._add_time=t,o[e]._add_time_str=a)}let d=await t.collection(r).add(o);return d.id?d.id:null},del:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,whereJson:r}=e,o=0;if(a.pubfn.isNotNull(r)){let e=await t.collection(i).where(r).remove();e?o=e.deleted:(console.error(e.errMsg),o=-1)}else console.error("whereJson条件不能为空");return o},delete:async function(e){return await b.del(e)},remove:async function(e){return await b.del(e)},deleteById:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,id:r,db:o}=e,s=o||t,l=0;if(a.pubfn.isNull(r))throw new Error("deleteById的id不能为空,且必须是字符串");let d=await s.collection(i).doc(r).remove();return d?l=d.deleted:(console.error(d.errMsg),l=0),l},update:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,whereJson:r,dataJson:o}=e,s=0;if(a.pubfn.isNotNull(r)){let e=await t.collection(i).where(r).update(o);e?s=e.updated:(console.error(e.errMsg),s=-1)}else console.error("whereJson条件不能为空");return s},updateById:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,id:r,dataJson:o,getUpdateData:s,db:l}=e,d=l||t,c=0;if(a.pubfn.isNull(r))throw new Error("updateById的id不能为空,且必须是字符串");let u=await d.collection(i).doc(r).update(o);return s?u?await b.findById({db:d,dbName:i,id:r}):null:(u?c=u.updated:(console.error(u.errMsg),c=0),c)},select:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,whereJson:r,pageSize:o=10}=e;if(a.pubfn.isNull(r)&&(r={_id:n.neq("___")}),o<=0&&(o=999999999),o>100)return await b.selectAll(e);let s=await b.getSelectData(e),{result:l,hasMore:d,total:c,getCount:u,pageIndex:p}=s;return l=l.skip((p-1)*o).limit(o),l.get().then(e=>{let t={};return u?(t.hasMore=d,t.total=c):(t.total=e.data?e.data.length:0,t.hasMore=t.total>=o),t.rows=e.data,t.code=0,t.key=1,t.pageIndex=p,t.pageSize=o,t})},findById:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,id:r,fieldJson:o,db:s}=e,l=s||t;try{let e=l.collection(i).doc(r);o&&(e=e.field(o));let t=await e.get();return"[object Array]"===Object.prototype.toString.call(t.data)?t.data[0]:t.data}catch(e){return console.error(e),null}},findByWhereJson:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,whereJson:r,fieldJson:o,sortArr:s}=e;try{if(a.pubfn.isNotNull(r)){let e=t.collection(i).where(r);if(s)for(let t in s){let n=s[t],a=n.name,i=n.type;null!=i&&""!=i||(i="asc"),e=e.orderBy(a,i)}o&&(e=e.field(o));let n=await e.limit(1).get();if(n.data&&n.data.length>0)return n.data[0]}else console.error("whereJson条件不能为空")}catch(e){console.error(e)}return null},count:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,whereJson:r}=e;a.pubfn.isNull(r)&&(r={_id:n.neq("___")});try{return(await t.collection(i).where(r).count()).total}catch(e){return console.error(e),null}},getSelectData:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,whereJson:r,pageIndex:o=1,pageSize:s=10,getCount:l=!1}=e;a.pubfn.isNull(r)&&(r={_id:n.neq("___")}),s<0&&(o=1,s=999999999,l=!0);let d=e.sortArr,c=e.fieldJson,u=0,p=!1;if(l){u=(await t.collection(i).where(r).count()).total,o<Math.ceil(u/s)&&(p=!0)}let f=t.collection(i);if(c&&(f=f.field(c)),r&&(f=f.where(r)),d)for(let e in d){let t=d[e],n=t.name,a=t.type;null!=a&&""!=a||(a="asc"),f=f.orderBy(n,a)}return{result:f,dbName:i,whereJson:r,pageIndex:o,pageSize:s,getCount:l,sortArr:d,fieldJson:c,total:u,hasMore:p}},selectAll:async function(e){let{db:t,_:n,vk:a,config:i}=h,r=(e.dbName,{}),o=500;a.pubfn.getData(i,"vk.db.unicloud.maxLimit")&&(o=a.pubfn.getData(i,"vk.db.unicloud.maxLimit"),o<=0&&(o=500),o>1e3&&(o=1e3));let s=await b.getSelectData(e),{result:l,hasMore:d,total:c,getCount:u,pageIndex:p,pageSize:f}=s;f>0&&!c&&!u&&(c=f);let g={};if(u&&0===c)g={data:[]};else{let t=c;f<c&&(t=f);let n=Math.ceil(t/o),a=[],i=(p-1)*f,r=i+f;for(let e=0;e<n;e++){let t=i+e*o,n=o;t+o>r&&(n=r-t);let s=l.skip(t).limit(n).get();a.push(s)}try{g=(await Promise.all(a)).reduce((e,t)=>({data:e.data.concat(t.data),errMsg:e.errMsg}))}catch(t){console.error("selectAll-异常",e,t),g={data:[]}}}return r.rows=g.data,r.key=1,r.code=0,r.hasMore=d,r.pageIndex=p,r.pageSize=f,r.total=u?c:g.data?g.data.length:0,r},sum:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,fieldName:r,whereJson:o}=e;a.pubfn.isNull(o)&&(o={_id:n.neq("___")});const s=t.command.aggregate;try{let e=await t.collection(i).aggregate().match(o).group({_id:null,num:s.sum("$"+r)}).end();return e.data&&e.data[0]?e.data[0].num:0}catch(e){return console.error(e),null}},avg:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,fieldName:r,whereJson:o}=e;a.pubfn.isNull(o)&&(o={_id:n.neq("___")});const s=t.command.aggregate;try{let e=await t.collection(i).aggregate().match(o).group({_id:null,num:s.avg("$"+r)}).end();return e.data&&e.data[0]?e.data[0].num:null}catch(e){return console.error(e),null}},max:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,fieldName:r,whereJson:o}=e;a.pubfn.isNull(o)&&(o={_id:n.neq("___")});const s=t.command.aggregate;try{let e=await t.collection(i).aggregate().match(o).group({_id:null,num:s.max("$"+r)}).end();return e.data&&e.data[0]?e.data[0].num:null}catch(e){return console.error(e),null}},min:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,fieldName:r,whereJson:o}=e;a.pubfn.isNull(o)&&(o={_id:n.neq("___")});const s=t.command.aggregate;try{let e=await t.collection(i).aggregate().match(o).group({_id:null,num:s.min("$"+r)}).end();return e.data&&e.data[0]?e.data[0].num:null}catch(e){return console.error(e),null}},sample:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,whereJson:r,size:o}=e;a.pubfn.isNull(r)&&(r={_id:n.neq("___")});t.command.aggregate;try{return(await t.collection(i).aggregate().match(r).sample({size:o}).end()).data}catch(e){return console.error(e),null}},selects:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,foreignKey:r="_id",whereJson:o={},pageIndex:s=1,pageSize:l=10,getCount:d=!1,sortArr:c=[],fieldJson:u={},foreignDB:p=[],lastWhereJson:f}=e;a.pubfn.isNull(o)&&(o={_id:n.neq("___")}),-1==l&&(s=1,l=999999999,d=!1);let g=0,m=!1;if(d){g=(await t.collection(i).where(o).count()).total,s<Math.ceil(g/l)&&(m=!0)}let y={};n.aggregate;let w=t.collection(i).aggregate();if(a.pubfn.isNotNull(o)){let e;for(let t in o)"object"==typeof o[t]&&"geoNear"===o[t].operator&&(e=a.pubfn.copyObject(o[t]),e.keyName=t,e.limit=s*l,delete o[t]);w=a.pubfn.isNotNull(e)?w.geoNear({near:new t.Geo.Point(e.$geoNear.geometry.coordinates[0],e.$geoNear.geometry.coordinates[1]),spherical:!0,limit:e.limit,maxDistance:e.$geoNear.maxDistance,minDistance:e.$geoNear.minDistance,query:o,distanceMultiplier:e.$geoNear.distanceMultiplier,distanceField:e.$geoNear.distanceField||"distance",includeLocs:e.keyName,key:e.keyName}):w.match(o)}if(a.pubfn.isNotNull(u)&&(w=w.project(u)),a.pubfn.isNotNull(c)){let e={};for(let t in c){let n=c[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}w=w.sort(e)}w=w.skip((s-1)*l).limit(l),w=b.addForeignDB({foreignDB:p,foreignKey:r,result:w}),a.pubfn.isNotNull(f)&&(w=w.match(f)),w=await w.end();let _=w.data;return _=b.listToObjectByLimit1({list:_,foreignDB:p}),d?(y.hasMore=m,y.total=g):(y.total=_?_.length:0,y.hasMore=g>=l),y.rows=_,y.code=0,y.key=1,y},listToObjectByLimit1:function(e){let{db:t,_:n,vk:a}=h,{list:i,foreignDB:r}=e;for(let e in i)for(let t in r){let{as:n,limit:o,foreignDB:s}=r[t];a.pubfn.isNotNull(s)&&(i[e][n]=b.listToObjectByLimit1({list:i[e][n],foreignDB:s})),1===o&&(i[e][n]&&i[e][n].length>0?i[e][n]=i[e][n][0]:i[e][n]={})}return i},addForeignDB:function(e){let{db:t,_:n,vk:a}=h,{foreignDB:i,foreignKey:r,result:o}=e;const s=n.aggregate;for(let e in i){let t,{dbName:l,foreignKey:d,localKey:c,as:u,limit:p,whereJson:f,fieldJson:g,sortArr:m,foreignDB:y}=i[e];u||(u=l),t=a.pubfn.isNotNull(c)?c:"object"==typeof r?r[e]:r;let h=[s.eq(["$"+d,"$$foreignKey"+t])],w=s.pipeline().match(n.expr(s.and(h)));if(a.pubfn.isNotNull(f)&&(w=w.match(f)),a.pubfn.isNotNull(m)){let e={};for(let t in m){let n=m[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}w=w.sort(e)}p&&(w=w.limit(p)),a.pubfn.isNotNull(g)&&(w=w.project(g)),a.pubfn.isNotNull(y)&&(w=b.addForeignDB({foreignDB:y,result:w})),w=w.done();let _={};_["foreignKey"+t]="$"+t;let k={from:l,let:_,pipeline:w,as:u};o=o.lookup(k)}return o},addWhereJson:function(e,t={}){let{vk:n,db:a,_:i}=h,{formData:r,columns:o}=e;for(let e in o){let a,s=o[e],{key:l,mode:d,defaultValue:c,type:u=""}=s,p=l;if(n.pubfn.isNotNull(s.fieldName)&&(p=s.fieldName),a=n.pubfn.isNotNull(s.value)?s.value:r[l],n.pubfn.isNull(a)&&n.pubfn.isNotNull(c)&&(a=c),n.pubfn.isNull(d)&&(d=["address","province","city","area"].indexOf(u)>-1?"address":"[object Array]"===Object.prototype.toString.call(a)&&a.length>=2?"[]":"="),n.pubfn.isNotNull(a))if("custom"===d);else if("%%"===d)try{t[p]=new RegExp(a)}catch(e){}else if("%*"===d)try{t[p]=new RegExp("^"+a)}catch(e){}else if("*%"===d)try{t[p]=new RegExp(a+"$")}catch(e){}else if(">"===d)t[p]=i.gt(a);else if(">="===d)t[p]=i.gte(a);else if("<"===d)t[p]=i.lt(a);else if("<="===d)t[p]=i.lte(a);else if("in"===d)t[p]=i.in(a);else if("nin"===d)t[p]=i.nin(a);else if("!="===d)t[p]=i.neq(a);else if("[]"===d)t[p]=i.gte(a[0]).lte(a[1]);else if("[)"===d)t[p]=i.gte(a[0]).lt(a[1]);else if("(]"===d)t[p]=i.gt(a[0]).lte(a[1]);else if("()"===d)t[p]=i.gt(a[0]).lt(a[1]);else if("address"===d){let e={};a.province&&a.province.code&&(e["province.code"]=a.province.code),a.city&&a.city.code&&(e["city.code"]=a.city.code),a.area&&a.area.code&&(e["area.code"]=a.area.code),t[p]=e}else t[p]=a}return t},getTableData:async function(e){let{vk:t,db:n,_:a}=h,{dbName:i,data:r,whereJson:o,fieldJson:s,sortArr:l,foreignKey:d,foreignDB:c,lastWhereJson:u}=e,{pageIndex:p,pageSize:f,pagination:g,sortRule:m,formData:y,columns:w}=r;g&&(p=g.pageIndex,f=g.pageSize);let _={},k={},x=[];return t.pubfn.isNotNull(l)?x=l:x.push({name:"_add_time",type:"desc"}),t.pubfn.isNotNull(m)&&(x=m),k=b.addWhereJson(r),t.pubfn.isNotNull(o)&&t.pubfn.objectAssign(k,o),t.pubfn.isNotNull(s)&&t.pubfn.objectAssign(_,s),t.pubfn.isNull(c)?await t.baseDao.select({dbName:i,getCount:!0,pageIndex:p,pageSize:f,fieldJson:_,whereJson:k,sortArr:x}):await t.baseDao.selects({dbName:i,foreignKey:d,getCount:!0,pageIndex:p,pageSize:f,whereJson:k,fieldJson:_,sortArr:x,foreignDB:c,lastWhereJson:u})},startTransaction:async function(e){let{vk:t,db:n,_:a}=h;return await n.startTransaction()},rollbackTransaction:async function(e){let{db:t,msg:n="【异常】操作失败",tips:a="事务已回滚。",err:i}=e,r={code:-1,msg:n,tips:a};await t.rollback();let o={message:i.message,stack:i.stack};try{o.body=JSON.parse(i.message),"object"==typeof o.body&&void 0!==o.body.code&&(o.body.msg,1)&&(r.msg=o.body.msg)}catch(e){}return console.error("transaction error",i),console.error("transaction errJson",o),r.err=o,r},group:async function(e){let{db:t,_:n,vk:a}=h,{dbName:i,whereJson:r,groupJson:o,sortArr:s,pageIndex:l=1,pageSize:d=10,getCount:c=!1,lookupJson:u}=e;d<=0&&(d=999999999);n.aggregate;let p,f=t.collection(i).aggregate();if(a.pubfn.isNotNull(r)&&(f=f.match(r)),a.pubfn.isNotNull(o)&&(f=f.group(o)),a.pubfn.isNotNull(s)){let e={};for(let t in s){let n=s[t],a=n.name,i=n.type;i=null==i||""==i||"asc"==i?1:-1,e[a]=i}f=f.sort(e)}f=f.skip((l-1)*d).limit(d),a.pubfn.isNotNull(u)&&(p=u.returnObject,delete u.returnObject,f=f.lookup(u)),f=await f.end();let g,m=f.data;if(p)for(let e in m)m[e][u.as]=m[e][u.as][0];let y=!1;if(c){let e=t.collection(i).aggregate();a.pubfn.isNotNull(r)&&(e=e.match(r)),a.pubfn.isNotNull(o)&&(e=e.group(o));let n=await e.count("total").end();g=n.data[0]?n.data[0].total:0,l<Math.ceil(g/d)&&(y=!0)}else g=m?m.length:0,y=g>=d;return{hasMore:y,total:g,rows:m,code:0,key:1,pageIndex:l,pageSize:d}}},w=b,_=async(e={})=>{"[object object]"===Object.prototype.toString.call(e.content)&&(e.content=JSON.stringify(e.content)),void 0===e.dataType&&(e.dataType="json"),"default"!=e.dataType&&""!==e.dataType||delete e.dataType,e.useContent&&(e.content=JSON.stringify(e.data)),e.method||(e.method="POST"),void 0===e.headers&&void 0!==e.header&&(e.headers=e.header),e.data&&(e.headers||(e.headers={"content-type":"application/json; charset=UTF-8"}));let t=await uniCloud.httpclient.request(e.url,e);return t&&t.data?t.data:t},k={formValidateItem:function(e,t,n){let a={code:0,msg:"ok"};for(let i in n){let r=n[i];if(void 0===e[t]&&r.required){a={type:"undefined",code:-1,msg:"字段："+t+" 名称错误，请检查！",key:t,value:e[t]};break}if(r.required&&(null==e[t]||null==e[t]||""===e[t]||0==e[t].length)){a={type:"required",code:-1,msg:r.message,key:t,value:e[t]};break}if(r.type){if(Object.prototype.toString.call(e[t]).toLowerCase()!==`[object ${r.type}]`){a={type:"type",code:-1,msg:r.message,key:t,value:e[t]};break}}if(r.len&&e[t].length!=r.len){a={type:"len",code:-1,msg:r.message,key:t,value:e[t]};break}if(r.min)if(r.type&&"number"==r.type){if(e[t]<r.min){a={type:"min",code:-1,msg:r.message,key:t,value:e[t]};break}}else if(e[t].length<r.min){a={type:"min",code:-1,msg:r.message,key:t,value:e[t]};break}if(r.max)if(r.type&&"number"==r.type){if(e[t]>r.max){a={type:"max",code:-1,msg:r.message,key:t,value:e[t]};break}}else if(e[t].length>r.max){a={type:"max",code:-1,msg:r.message,key:t,value:e[t]};break}if("function"==typeof r.validator){let n=r.validator(r,e[t],(function(e){return e}));if(void 0!==n&&!0!==n){a={type:"validator",code:-1,msg:r.message,key:t,value:e[t]};break}}}return a}};function x(e){return JSON.parse(JSON.stringify(e))}var N={};function v(e){let t=[];for(let n=0;n<e.length;n++)-1==t.indexOf(e[n])&&t.push(e[n]);return t}N.treeToArray=function(e,t){let n=x(e);return N.treeToArrayFn(n,t)},N.treeToArrayFn=function(e,t={},n=[],a){let{id:i="_id",parent_id:r="parent_id",children:o="children",deleteChildren:s=!0}=t;for(let l in e){let d=e[l];a&&(d[r]=a),n.push(d),d[o]&&d[o].length>0&&(n=N.treeToArrayFn(d[o],t,n,d[i])),s&&delete d[o]}return n},N.arrayToTree=function(e,t){let n=x(e),{id:a="_id",parent_id:i="parent_id",children:r="children",deleteParentId:o=!1,need_field:s}=t,l=[],d={};for(let e=0;e<n.length;e++)d[n[e][a]]=n[e];for(let e=0;e<n.length;e++){let t=n[e];if(s){s=v(s.concat([a,i,r]));for(let e in t)-1===s.indexOf(e)&&delete t[e]}let c=d[t[i]];c?(c[r]||(c[r]=[]),o&&delete t[i],c[r].push(t)):l.push(t)}return l};var D=N,T={timeFormat:function(e,t="yyyy-MM-dd hh:mm:ss",n=8){if(!e)return"";let a;"number"==typeof e?(10==e.toString().length&&(e*=1e3),a=new Date(e)):a=e;const i=60*a.getTimezoneOffset()*1e3+60*n*60*1e3,r=a.getTime()+i;a=new Date(r);let o={"M+":a.getMonth()+1,"d+":a.getDate(),"h+":a.getHours(),"m+":a.getMinutes(),"s+":a.getSeconds(),"q+":Math.floor((a.getMonth()+3)/3),S:a.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(a.getFullYear()+"").substr(4-RegExp.$1.length)));for(let e in o)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?o[e]:("00"+o[e]).substr((""+o[e]).length)));return t},getFullTime:function(e,t=0,n=8){if(!e)return"";"number"==typeof e&&(e=new Date(e));const a=60*e.getTimezoneOffset()*1e3+60*n*60*1e3,i=e.getTime()+a;let r=(e=new Date(i)).getFullYear()+"",o=e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1,s=e.getDate()<10?"0"+e.getDate():e.getDate(),l=e.getHours()<10?"0"+e.getHours():e.getHours(),d=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),c=e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds();return 2===t?{YYYY:Number(r),MM:Number(o),DD:Number(s),hh:Number(l),mm:Number(d),ss:Number(c),year:Number(r),month:Number(o),day:Number(s),hour:Number(l),minute:Number(d),second:Number(c)}:1===t?r+""+o+s+l+d+c:r+"-"+o+"-"+s+" "+l+":"+d+":"+c},getWeekStartAndEnd:function(e=0,t=new Date,n=8){let a={};const i=60*t.getTimezoneOffset()*1e3+60*n*60*1e3,r=t.getTime()+i,o=new Date(r);let s=o.getDay();o.getDate();t=new Date(t.getTime()+6048e5*e);let l=0!=s?s-1:6,d=new Date(t.getTime()-864e5*l),c=new Date(d.getTime()+5184e5),u=T.getFullTime(d,2),p=T.getFullTime(c,2);return a.weekStart=new Date(`${u.year}/${u.month}/${u.day}`).getTime()-i,a.weekEnd=new Date(`${p.year}/${p.month}/${p.day}`).getTime()+86399999-i,a},getCommonTime:function(e=new Date,t=8){let n={};const a=60*e.getTimezoneOffset()*1e3+60*t*60*1e3,{year:i,month:r,day:o,hour:s,minute:l,second:d}=T.getFullTime(e,2);n.now={year:i,month:r,day:o,hour:s,minute:l,second:d};let c=new Date(i,r,0).getDate(),u=new Date(i,12,0).getDate();n.todayStart=new Date(`${i}/${r}/${o}`).getTime()-a,n.today12End=new Date(`${i}/${r}/${o}`).getTime()+43199999-a,n.todayEnd=new Date(`${i}/${r}/${o}`).getTime()+86399999-a,n.monthStart=new Date(`${i}/${r}/1`).getTime()-a,n.monthEnd=new Date(`${i}/${r}/${c}`).getTime()+86399999-a,n.yearStart=new Date(i+"/1/1").getTime()-a,n.yearEnd=new Date(`${i}/12/${u}`).getTime()+86399999-a;let p=i,f=r-1;0===f&&(f=12,p=i-1);let g=new Date(p,f,0).getDate();n.lastMonthStart=new Date(`${p}/${f}/1`).getTime()-a,n.lastMonthEnd=new Date(`${p}/${f}/${g}`).getTime()+86399999-a;let m=T.getWeekStartAndEnd(0,e);n.weekStart=m.weekStart,n.weekEnd=m.weekEnd,n.months=[],n.months[0]={monthStart:n.monthStart,monthEnd:n.monthEnd};for(let e=1;e<=12;e++){let t=new Date(i,e,0).getDate(),r=new Date(`${i}/${e}/1`).getTime()-a,o=new Date(`${i}/${e}/${t}`).getTime()+86399999-a;n.months[e]={monthStart:r,monthEnd:o}}return n},getMonthStartAndEnd:function(e,t=8){let n={startTime:null,endTime:null},{year:a,month:i}=e;if(a>0&&i>0){const e=60*(new Date).getTimezoneOffset()*1e3+60*t*60*1e3;let r=new Date(a,i,0).getDate();n.startTime=new Date(`${a}/${i}/1`).getTime()-e,n.endTime=new Date(`${a}/${i}/${r}`).getTime()+86399999-e}return n},isLeapYear:function(e){if(void 0===e){let{now:t}=T.getCommonTime();e=t.year}else if("object"==typeof e){let{now:t}=T.getCommonTime(e);e=t.year}return e%4==0&&e%100!=0||e%400==0},isQingming:function(e=new Date){let{now:t}=T.getCommonTime(e),{year:n,month:a,day:i}=t,r=!1;return T.isLeapYear(n)||T.isLeapYear(n-1)?4===a&&4===i&&(r=!0):4===a&&5===i&&(r=!0),r}},A=T,S={formValidate:function(e={}){let t={code:0,msg:"ok"},{data:n,rules:a}=e;if(a)for(let e in a){let i=a[e];if(t=k.formValidateItem(n,e,i),0!=t.code)break}return t}};S.treeUtil=D,S.timeUtil=A,S.timeFormat=S.timeUtil.timeFormat,S.getFullTime=S.timeUtil.getFullTime,S.getWeekStartAndEnd=S.timeUtil.getWeekStartAndEnd,S.getCommonTime=S.timeUtil.getCommonTime,S.getMonthStartAndEnd=S.timeUtil.getMonthStartAndEnd,S.validator=function(e){return function(t,n,a){let i=S.test(n,e);return"function"!=typeof a||!i&&n?a(!1):void a()}},S.test=function(e,t){switch(t){case"mobile":return new RegExp(/^1[3|4|5|6|7|8|9][0-9]{9}$/).test(e);case"tel":return new RegExp(/^(0\d{2,3}-\d{7,8})(-\d{1,4})?$/).test(e);case"card":return new RegExp(/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/).test(e);case"mobileCode":return new RegExp(/^[0-9]{6}$/).test(e);case"username":return new RegExp(/^[a-zA-Z]([-_a-zA-Z0-9]{5,17})$/).test(e);case"pwd":return new RegExp(/^([a-zA-Z0-9_]){6,18}$/).test(e);case"payPwd":return new RegExp(/^[0-9]{6}$/).test(e);case"postal":return new RegExp(/[1-9]\d{5}(?!\d)/).test(e);case"QQ":return new RegExp(/^[1-9][0-9]{4,9}$/).test(e);case"email":return new RegExp(/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/).test(e);case"money":return new RegExp(/^\d*(?:\.\d{0,2})?$/).test(e);case"URL":return new RegExp(/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/).test(e);case"IP":return new RegExp(/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/).test(e);case"date":return new RegExp(/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])$/).test(e);case"time":return new RegExp(/^(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/).test(e);case"dateTime":return new RegExp(/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])\s+(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/).test(e);case"number":return new RegExp(/^[0-9]*$/).test(e);case"english":return new RegExp(/^[a-zA-Z]+$/).test(e);case"chinese":return new RegExp(/^[\\u4E00-\\u9FA5]+$/).test(e);case"lower":return new RegExp(/^[a-z]+$/).test(e);case"upper":return new RegExp(/^[A-Z]+$/).test(e);case"HTML":return new RegExp(/<("[^"]*"|'[^']*'|[^'">])*>/).test(e);default:return!0}},S.checkStr=S.test,S.priceFilter=function(e){return"string"==typeof e&&(e=parseFloat(e)),(e/100).toFixed(2)},S.objectAssign=function(e,t){return Object.assign(e,t)},S.copyObject=function(e){return JSON.parse(JSON.stringify(e))},S.formAssign=function(e,t){let n=S.copyObject(e);return S.objectAssign(n,t)},S.arr_concat=function(e,t,n){n||(n="id");var a=e.concat(t),i=[];if(-1!=n){var r=[];for(var o in a)-1==r.indexOf(a[o][n])&&(r.push(a[o][n]),i.push(a[o]))}else i=a;return i},S.getData=function(e,t,n){var a=JSON.parse(JSON.stringify(e));t=t.replace(/\s+/g,"")+".";for(var i="",r=0;r<t.length;r++){var o=t.charAt(r);"."!=o&&"["!=o&&"]"!=o?i+=o:a&&(""!=i&&(a=a[i]),i="")}return void 0===a&&S.isNotNull(n)&&(a=n),a},S.setData=function(e,t,n){let a=new RegExp("([\\w$]+)|\\[(:\\d)\\]","g");const i=t.match(a);for(let t=0;t<i.length-1;t++){let n=i[t];"object"!=typeof e[n]&&(e[n]={}),e=e[n]}e[i[i.length-1]]=n},S.isNull=function(e){let t=!1;return void 0!==e&&"[object Null]"!=Object.prototype.toString.call(e)&&""!==e&&"{}"!=JSON.stringify(e)&&"[]"!=JSON.stringify(e)&&void 0!==JSON.stringify(e)||(t=!0),t},S.isNotNull=function(e){return!S.isNull(e)},S.isNullOne=function(...e){let t=!1;for(let n=0;n<e.length;n++){let a=e[n];if(S.isNull(a)){t=!0;break}}return t},S.isNullOneByObject=function(e){let t;for(let n in e){let a=e[n];if(S.isNull(a)){t=n;break}}return t},S.isNullAll=function(...e){let t=!0;for(let n=0;n<e.length;n++){let a=e[n];if(S.isNotNull(a)){t=!1;break}}return t},S.isNotNullAll=function(...e){return!S.isNullOne(...e)},S.getListItem=function(e,t,n){let a;for(let i=0;i<e.length;i++)if(S.isNotNull(n)&&e[i][t]===n){a=e[i];break}return a},S.getListIndex=function(e,t,n){let a=-1;for(let i=0;i<e.length;i++)if(S.isNotNull(n)&&e[i][t]===n){a=i;break}return a},S.getListItemIndex=function(e,t,n){let a,i={},r=-1;for(let i=0;i<e.length;i++)if(S.isNotNull(n)&&e[i][t]===n){r=i,a=e[i];break}return i={item:a,index:r},i},S.arrayToJson=function(e,t){let n={};for(let a in e){let i=e[a];n[i[t]]=i}return n},S.listToJson=S.arrayToJson,S.random=function(e,t){let n="",a="123456789";S.isNotNull(t)&&("a-z,0-9"==t?t="abcdefghijklmnopqrstuvwxyz0123456789":"A-Z,0-9"==t?t="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789":"a-z,A-Z,0-9"!=t&&"A-Z,a-z,0-9"!=t||(t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"),a=t);for(let t=0;t<e;t++){n+=a[Math.floor(Math.random()*a.length)]}return n},S.stringIdToNumberId=function(e,t){let n="",a=e.split("").reverse().join("");for(let e=0;e<t;e++)if(a.length>e){n+="0123456789"[a[e].charCodeAt()%10]}else n="0"+n;return n},S.hidden=function(e,t,n){let a=e.length-t-n,i="";for(let e=0;e<a;e++)i+="*";return e.substring(0,t)+i+e.substring(e.length-n)},S.checkArrayIntersection=function(e=[],t=[]){let n=!1;for(let a=0;a<t.length;a++)e.indexOf(t[a])>-1&&(n=!0);return n},S.calcFreights=function(e,t){let{first_weight:n,first_weight_price:a,continuous_weight:i,continuous_weight_price:r,max_weight:o=1e8}=e,s=0,l=0,d=o,c=!1,u=0;for(;t>0;)c?(u++,t-=i,d-=i):(c=!0,l++,d=o,t-=n,d-=n),d<=0&&(c=!1);return s=l*a+r*u,s},S.getNewObject=function(e,t){let n=S.copyObject(e),a={};if(t&&t.length>0)for(let e in t){let i=t[e];S.isNotNull(n[i])&&(a[i]=n[i])}else a=n;return a},S.deleteObjectKeys=function(e,t=[]){var n={};if(e)for(let a in e)-1==t.indexOf(a)&&(n[a]=e[a]);return n},S.arrayToTree=S.treeUtil.arrayToTree,S.treeToArray=S.treeUtil.treeToArray,S.wildcardTestOne=function(e,t){if(!t)return!1;let n=t.replace(new RegExp("\\*"),"(.*)"),a=0!==t.indexOf("*")?"^":"",i="*"!==t[t.length-1]?"$":"";return new RegExp(a+n+i).test(e)},S.wildcardTest=function(e,t){let n=0;if("string"==typeof t)S.wildcardTestOne(e,t)&&n++;else if("object"==typeof t)for(let a=0;a<t.length;a++){let i=t[a];S.wildcardTestOne(e,i)&&n++}return n},S.regExpTestOne=function(e,t){if(!t)return!1;return new RegExp(t).test(e)},S.regExpTest=function(e,t){let n=0;if("string"==typeof t)S.regExpTestOne(e,t)&&n++;else if("object"==typeof t)for(let a=0;a<t.length;a++){let i=t[a];S.regExpTestOne(e,i)&&n++}return n},S.createOrderNo=function(e=""){return e+S.getFullTime(new Date,1)+S.random(16)},S.dateDiff=function(e){if(!e)return"";"number"==typeof e&&(e=new Date(e));var t=864e5,n=36e5,a=(new Date).getTime()-e.getTime(),i=Math.floor(a/t),r=Math.floor(a%t/n),o=Math.floor(a%t%n/6e4),s=Math.round(a%t%n%6e4/1e3),l="1 秒前";return i>0?l=i+"天前":r>0?l=r+"小时前":o>0?l=o+"分钟前":s>0&&(l=s+"秒前"),l},S.urlStringToJson=function(e){var t={};if(""!=e&&null!=e&&null!=e)for(var n=e.split("&"),a=0;a<n.length;a++){var i=n[a].split("="),r=i[0],o=i[1];t[r]=o}return t},S.getQueryStringParameters=function(e){let t={};if(e.httpMethod){if(console.log("event.path:",e.path),e.body){let n=e.body;e.isBase64Encoded&&(n=Buffer.from(n,"base64").toString("utf-8")),"string"==typeof n&&(n=JSON.parse(n)),t=n}else if(e.queryStringParameters){let n=e.queryStringParameters;"string"==typeof n.data&&(n.data=JSON.parse(n.data)),t=n}}else t=JSON.parse(JSON.stringify(e));return t.data||(t.data={}),t.url=t.$url||"",t},S.stringToFormData=function(e){e||(e="");for(var t=e.split("Content-Disposition: form-data;"),n={},a=0;a<t.length;a++){var i=t[a];let e='name="';var r=i.indexOf(e)+e.length;if(r>-1){var o=i.indexOf('"',r),s=i.substring(r,o);if(o>r){var l=i.indexOf("---",o),d=i.substring(o+1,l).trim();n[s]=d}}}return n};var I=S;var O={addAsyncTasks:async(e={},t)=>{let{vk:n,db:a,_:i}=t,{type:r,title:o,out_trade_no:s,user_order_success:l}=e,d={};return d=await n.baseDao.add({dbName:"uni-pay-async-tasks",dataJson:{status:0,type:r,title:o,out_trade_no:s,user_order_success:l}},t),d},addPayOrders:async(e={},t)=>{let{vk:n,db:a,_:i}=t,{pay_type:r,out_trade_no:o,openid:s,total_fee:l,appid:d,original_data:c,wxpay_info:u,alipay_info:p}=e,f={};return f=await n.baseDao.add({dbName:"uni-pay-orders",dataJson:{pay_type:r,out_trade_no:o,openid:s,total_fee:l,appid:d,original_data:c,wxpay_info:u,alipay_info:p}},t),f},findPayOrdersByOutTradeNo:async(e="___",t)=>{let{vk:n,db:a,_:i}=t,r={};return r=await n.baseDao.findByWhereJson({dbName:"uni-pay-orders",whereJson:{out_trade_no:e}},t),r}},$=O,E={};E.payDao=$,E.pay=async(e={},t)=>{let{uniPay:n,config:a,vk:i,db:r,_:o}=t,{data:s={},userInfo:l,provider:d,originalParam:c}=e,{outTradeNo:u,subject:p="",body:f="",totalFee:g}=s;const{wxConfigMp:m,wxConfigApp:y,wxConfigH5:h,aliConfigMp:b,aliConfigApp:w,aliConfigH5:_,notifyUrl:k,alipay_app_to_h5:x}=a["uni-pay"];let N,v,D,T=d+"_"+c.context.PLATFORM;x&&"alipay_app-plus"==T&&(T="alipay_h5");var A=k+"/"+T;switch(T){case"wxpay_mp-weixin":N=n.initWeixin(m),v=l.wx_openid["mp-weixin"],D="JSAPI";break;case"wxpay_app-plus":N=n.initWeixin(y),D="APP";break;case"wxpay_h5":N=n.initWeixin(h),D="NATIVE";break;case"alipay_mp-alipay":N=n.initAlipay(b),v=l.ali_openid;break;case"alipay_app-plus":N=n.initAlipay(w),D="APP";break;case"alipay_h5":N=n.initAlipay(_),D="NATIVE";break;default:return{code:-1,msg:"参数错误",value:d+"_"+c.context.PLATFORM}}let S;try{v&&(s.openid=v),s.notifyUrl=A,s.tradeType=D,"alipay"===d&&void 0===s.extendParams&&(s.extendParams={sysServiceProviderId:"2088731216435275"}),S=await N.getOrderInfo(s)}catch(e){return console.log("error: ",e.message),{code:-3,msg:"获取支付信息失败，请稍后再试。"+e.message}}return{code:0,msg:"ok",outTradeNo:u,orderInfo:S}},E.payNotify=async function(e){let{event:t,context:n,vk:a,orderPaySuccess:i}=e,{config:r,uniPay:o,db:s,customUtil:l}=a.config,d={vk:a,config:r,uniPay:o,db:s,customUtil:l,_:s.command};const{wxConfigMp:c,wxConfigApp:u,wxConfigH5:p,aliConfigMp:f,aliConfigApp:g,aliConfigH5:m,alipay_app_to_h5:y}=r["uni-pay"];(new Date).getTime();let h,b=t.path.substring(1);switch(y&&"alipay_app-plus"==b&&(b="alipay_h5"),b){case"wxpay_mp-weixin":h=o.initWeixin(c);break;case"wxpay_app-plus":h=o.initWeixin(u);break;case"wxpay_h5":h=o.initWeixin(p);break;case"alipay_mp-alipay":h=o.initAlipay(f);break;case"alipay_app-plus":h=o.initAlipay(g);break;case"alipay_h5":h=o.initAlipay(m);break;default:return console.log("---------参数错误---------"),{code:-1,msg:"参数错误"}}let w=await h.verifyPaymentNotify(t);if(!w)return console.log("---------!验证未通过!---------"),{};let _,k,{outTradeNo:x,totalFee:N,transactionId:v,resultCode:D,openid:T,appId:A}=w;0==b.indexOf("wxpay_")?_=w:0==b.indexOf("alipay_")&&(k=w);let S=!1;return"function"==typeof i&&(S=await i({util:d,data:w})),"SUCCESS"==D&&(await $.addAsyncTasks({type:1001,title:`订单【${x}】付款成功`,out_trade_no:x,user_order_success:S},d),await $.addPayOrders({pay_type:b,out_trade_no:x,openid:T,total_fee:N,appid:A,original_data:t.body,wxpay_info:_,alipay_info:k},d)),0==b.indexOf("wxpay_")?{mpserverlessComposedResponse:!0,statusCode:200,headers:{"content-type":"text/xml"},body:"<xml><return_code><![CDATA[SUCCESS]]></return_code><return_msg><![CDATA[OK]]></return_msg></xml>"}:(b.indexOf("alipay_"),"SUCCESS")},E.payQuery=async(e={},t)=>{let{uniPay:n,config:a,vk:i,db:r,_:o}=t,{data:s={}}=e,{outTradeNo:l}=s,d={code:-1,msg:""};const{wxConfigMp:c,wxConfigApp:u,wxConfigH5:p,aliConfigMp:f,aliConfigApp:g,aliConfigH5:m,notifyUrl:y}=a["uni-pay"];if(!l)return{code:-1,msg:"订单号不能为空"};let h=await $.findPayOrdersByOutTradeNo(l,t);if(!h)return{code:-2,msg:"订单不存在或订单未支付!"};let b;switch(h.pay_type){case"wxpay_mp-weixin":b=n.initWeixin(c);break;case"wxpay_app-plus":b=n.initWeixin(u);break;case"wxpay_h5":b=n.initWeixin(p);break;case"alipay_mp-alipay":b=n.initAlipay(f);break;case"alipay_app-plus":b=n.initAlipay(g);break;case"alipay_h5":b=n.initAlipay(m);break;default:return{code:-1,msg:"参数错误"}}let w=await b.orderQuery({outTradeNo:l});if("SUCCESS"===w.tradeState||"FINISHED"===w.tradeState)d={code:0,msg:"支付成功",orderPaid:!0};else{let e=w.tradeStateDesc||"未支付或已退款";e.indexOf("订单发生过退款")>-1&&(e="订单已退款"),d={code:-1,msg:e,orderPaid:!1}}return d},E.refund=async(e={},t)=>{let{uniPay:n,config:a,vk:i,db:r,_:o}=t,{data:s={},originalParam:l,orderRefundSuccess:d}=e,{outTradeNo:c}=s,u={code:-1,msg:""};const{wxConfigMp:p,wxConfigApp:f,wxConfigH5:g,aliConfigMp:m,aliConfigApp:y,aliConfigH5:h,notifyUrl:b}=a["uni-pay"];let w=c;if(!c)return{code:-1,msg:"订单号不能为空"};let _=await $.findPayOrdersByOutTradeNo(c,t);if(!_)return{code:-2,msg:"订单不存在或订单未支付!"};let k=_.total_fee,x=k;const N=_.pay_type;let v;switch(N){case"wxpay_mp-weixin":v=n.initWeixin(p);break;case"wxpay_app-plus":v=n.initWeixin(f);break;case"wxpay_h5":v=n.initWeixin(g);break;case"alipay_mp-alipay":v=n.initAlipay(m);break;case"alipay_app-plus":v=n.initAlipay(y);break;case"alipay_h5":v=n.initAlipay(h);break;default:return{code:-1,msg:"参数错误,暂不支持"+N}}let D=!1;return"function"==typeof d&&(D=await d({payOrder:_})),await $.addAsyncTasks({type:1002,title:`订单【${c}】退款成功`,out_trade_no:c,user_order_success:D},t),console.log(`---- ${c} -- ${w} -- ${k} -- ${x}`),u=await v.refund({outTradeNo:c,outRefundNo:w,totalFee:k,refundFee:x}),u.outTradeNo?(u.code=0,u.msg="退款成功"):(u.code=-1,u.msg="退款失败"),u},E.refundQuery=async(e={},t)=>{let{uniPay:n,config:a,vk:i,db:r,_:o}=t,{data:s={}}=e,{outTradeNo:l}=s,d={code:-1,msg:""};const{wxConfigMp:c,wxConfigApp:u,wxConfigH5:p,aliConfigMp:f,aliConfigApp:g,aliConfigH5:m,notifyUrl:y}=a["uni-pay"];if(!l)return{code:-1,msg:"订单号不能为空"};let h=await $.findPayOrdersByOutTradeNo(l,t);if(!h)return{code:-2,msg:"订单不存在或订单未支付!"};let b,w;switch(h.pay_type){case"wxpay_mp-weixin":b=n.initWeixin(c);break;case"wxpay_app-plus":b=n.initWeixin(u);break;case"wxpay_h5":b=n.initWeixin(p);break;case"alipay_mp-alipay":b=n.initAlipay(f);break;case"alipay_app-plus":b=n.initAlipay(g);break;case"alipay_h5":b=n.initAlipay(m);break;default:return{code:-1,msg:"参数错误"}}let _={};try{w=await b.refundQuery({outTradeNo:l,outRefundNo:l})}catch(e){return{code:-1,msg:"查询失败,请稍后再试!",err:e,refundQueryJson:_,queryResult:w}}if(w.refundFee>0){let e="退款成功";for(let t in w.refundList){let n=w.refundList[t];e+=`${t+1}、 ${n.refundSuccessTime}: \r\n退款到 ${n.refundRecvAccout};\r\n`}d={code:0,msg:e,queryResult:w}}else d={code:-1,msg:"未退款",queryResult:w};return d};var C=E,J={},B={};J.get=function(e){let t,n=B[e];if(n){let{value:a,expired:i}=n;J.isExpired(e)?delete B[e]:t=a}return t},J.set=function(e,t,n=0){let a={value:t,expired:n>0?(new Date).getTime()+1e3*n:0};B[e]=a},J.del=function(e){delete B[e]},J.clear=function(e){if(e)for(let t in B)0==t.indexOf(e)&&delete B[t];else B={}},J.isExpired=function(e){let t=!0,n=B[e];return n&&(0==n.expired||n.expired>(new Date).getTime())&&(t=!1),t},J.getAll=function(e){let t={};if(e)for(let n in B)0==n.indexOf(e)&&(t[e]=B[e]);else t=B;for(let e in t)J.isExpired(e)&&(delete t[e],delete B[e]);return t};var M=J,q={},P={};q.init=function(e){P=e.vk.system.globalDataDao},q.get=async function(e){let t;try{let n=await P.find(e);if(n){let{value:a,expired_at:i}=n;q.isExpired(n)?await q.del(e):t=a}}catch(e){return}return t},q.set=async function(e,t,n=0){let a;e&&void 0!==e.key&&void 0!==e.value?(a=e.key,t=e.value,n=e.second):a=e;let i={code:0,msg:"ok"};try{if(!a)return{code:-1,msg:"key值不能为空"};let e=n>0?(new Date).getTime()+1e3*n:0;i=await P.set({key:a,value:t,expired_at:e})}catch(e){return{code:-1,msg:"异常"}}return i},q.del=async function(e){await P.del(e)},q.clear=async function(e){if(e)return await P.deleteByWhere({key:new RegExp("^"+e)})},q.list=async function(e){return await P.list(e)},q.count=async function(e){return await P.count(e)},q.isExpired=function(e){let t=!0;return e&&(!e.expired_at||0==e.expired_at||e.expired_at>(new Date).getTime())&&(t=!1),t},q.inc=async function(e,t=1,n=0){let a;e&&void 0!==e.key&&void 0!==e.value?(a=e.key,t=e.value,n=e.second):a=e;let i={code:0,msg:"ok"};try{if(!a)return{code:-1,msg:"key值不能为空"};let e=n>0?(new Date).getTime()+1e3*n:0;i=await P.inc({key:a,value:t,expired_at:e})}catch(e){return{code:-1,msg:"异常",err:e}}return i},q.deleteExpired=async function(){await P.deleteExpired()};var R=q,j={},F={};function U(e){return e.code=e.errcode,e.msg=e.errmsg,e}j.init=function(e){F=e},j.decrypt={},j.decrypt.getPhoneNumber=async function(e={}){let{appid:t,encryptedData:n,iv:a,sessionKey:i}=e;e.appId&&(t=e.appId);let r,{vk:o,config:s,crypto:l,uniID:d}=F,c={code:0,msg:"ok"},u=o.pubfn.isNullOneByObject({encryptedData:n,iv:a,sessionKey:i});if(u)return{code:-1,msg:u+"不能为空"};if(t)r=t;else try{if(r=s.uni["mp-weixin"].oauth.weixin.appid,o.pubfn.isNull(r))return{code:-1,msg:"请先配置微信小程序APPID"}}catch(e){return{code:-1,msg:"请先配置微信小程序APPID"}}return c.data=j.decrypt.decryptData({appid:r,encryptedData:n,iv:a,sessionKey:i}),c.phone=c.data.phoneNumber,c.mobile=c.data.phoneNumber,c},j.decrypt.decryptData=function(e={}){let t,{appid:n,encryptedData:a,iv:i,sessionKey:r}=e,{vk:o,crypto:s}=F,l=new Buffer(r,"base64"),d=new Buffer(a,"base64"),c=new Buffer(i,"base64");try{let e=s.createDecipheriv("aes-128-cbc",l,c);e.setAutoPadding(!0),t=e.update(d,"binary","utf8"),t+=e.final("utf8"),t=JSON.parse(t)}catch(e){throw new Error(e)}return t.watermark.appid!==n?{code:-1,msg:"appid不一致"}:t},j.auth={},j.auth.getAppidInfo=function(e={}){let{appid:t,appsecret:n}=e,{vk:a,config:i}=F;if(t){if(!n){let e=a.pubfn.getData(i,"vk.oauth.weixin.list")||[],r=a.pubfn.getListItem(e,"appid",t)||{};t=r.appid,n=r.appsecret}}else{let e=a.pubfn.getData(i,"uni.mp-weixin.oauth.weixin")||{};t=e.appid,n=e.appsecret}if(a.pubfn.isNullOne(t,n))throw new Error("请先配置微信小程序appid和appsecret");return{appid:t,appsecret:n}},j.auth.getAccessTokenFn=async function(e={}){let{appid:t,appsecret:n}=j.auth.getAppidInfo(e),{vk:a,config:i}=F,r=await a.request({url:`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${t}&secret=${n}`,method:"GET"});return r.errcode?(console.error("getAccessToken失败：",r),{code:r.errcode,msg:r.errmsg,err:r}):{code:0,msg:"ok",access_token:r.access_token,expires_in:r.expires_in}},j.auth.getAccessToken=async function(e={}){let t,{appid:n,appsecret:a}=j.auth.getAppidInfo(e),{cache:i=!0}=e,{vk:r}=F,o="mp-weixin-"+n;if(i&&(t=await r.globalDataCache.get(o)),r.pubfn.isNull(t)){let n=await j.auth.getAccessTokenFn(e);0===n.code&&(t=n.access_token,await r.globalDataCache.set(o,t,240),await r.globalDataCache.deleteExpired())}return t},j.auth.code2Session=async function(e={}){let{appid:t,appsecret:n}=j.auth.getAppidInfo(e),{js_code:a}=e,{vk:i}=F,r=await i.request({url:`https://api.weixin.qq.com/sns/jscode2session?appid=${t}&secret=${n}&js_code=${a}&grant_type=authorization_code`,method:"GET"});return r.errcode?(console.error("code2Session失败：",r),{code:r.errcode,msg:r.errmsg,err:r}):{code:0,msg:"ok",session_key:r.session_key,openid:r.openid,unionid:r.unionid}},j.wxacode={},j.wxacode.getUnlimited=async function(e={}){let t,{vk:n}=F,{access_token:a,scene:i,page:r,width:o,auto_color:s,line_color:l,is_hyaline:d}=e;if(t=a||await j.auth.getAccessToken(e),!t)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};let c=await n.request({url:"https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token="+t,method:"POST",data:{scene:i,page:r,width:o,auto_color:s,line_color:l,is_hyaline:d},dataType:"default",useContent:!0,headers:{encoding:null}});return c.length<500?{code:-1,msg:"生成小程序码失败，请重试！"}:Buffer.isBuffer(c)?c:{code:c.errcode,msg:c.errmsg,err:c}},j.urlscheme={},j.urlscheme.generate=async function(e={}){let{vk:t}=F,{jump_wxa:n={},is_expire:a,expire_time:i}=e,{path:r,query:o}=n,s=await j.auth.getAccessToken(e);if(!s)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};i>0&&(i=(new Date).getTime()/1e3+i);let l=await t.request({url:"https://api.weixin.qq.com/wxa/generatescheme?access_token="+s,method:"POST",data:{jump_wxa:{path:r,query:o},is_expire:a,expire_time:i},useContent:!0});switch(l=U(l),l.code){case 40001:l.msg="access_token错误";break;case 40165:l.msg="小程序页面不存在!"}return l},j.security={},j.security.msgSecCheck=async function(e={}){let{vk:t}=F,{content:n}=e,a=await j.auth.getAccessToken(e);if(!a)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};let i=await t.request({url:"https://api.weixin.qq.com/wxa/msg_sec_check?access_token="+a,method:"POST",data:{content:n}});switch(i=U(i),i.code){case 40001:i.msg="access_token错误";break;case 87014:i.msg="内容含有违法违规内容，请检查!"}return i},j.security.imgSecCheck=async function(e={}){let{vk:t}=F,{dataBuffer:n,formData:a,base64:i}=e,r=await j.auth.getAccessToken(e);if(!r)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};i&&!n&&(n=new Buffer(i,"base64")),n&&!a&&(a=new t.formDataUtil.FormData,a.append("media",n,{filename:Date.now()+".png",contentType:"image/png"}));let o=await t.request({url:"https://api.weixin.qq.com/wxa/img_sec_check?access_token="+r,content:a.getBuffer(),headers:a.getHeaders()});switch(o=U(o),o.code){case 40001:o.msg="access_token错误";break;case 87014:o.msg="图片内容含有违法违规内容，请检查!";break;case 40006:o.msg="图片大小不能超过1M"}return o},j.subscribeMessage={},j.subscribeMessage.send=async function(e={}){let{vk:t}=F,{touser:n,template_id:a,page:i,data:r,miniprogram_state:o="formal",lang:s="zh_CN"}=e,l=await j.auth.getAccessToken(e);if(!l)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};let d=await t.request({url:"https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token="+l,method:"POST",data:{touser:n,template_id:a,page:i,data:r,miniprogram_state:o,lang:s}});switch(d=U(d),d.code){case 40003:d.msg="touser字段openid为空或者不正确";break;case 40037:d.msg="订阅模板id为空不正确";break;case 43101:d.msg="用户未订阅该消息";break;case 47003:d.msg="模板参数不准确，可能为空或者不满足规则，errmsg会提示具体是哪个字段出错";break;case 41030:d.msg="page路径不正确，需要保证在现网版本小程序中存在"}return d},j.livebroadcast={},j.livebroadcast.getLiveInfo=async function(e={}){let{vk:t}=F,{pageIndex:n=1,pageSize:a=100}=e,i=await j.auth.getAccessToken(e);if(!i)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};if(n<=0)return{code:-1,msg:"pageIndex必须是大于0的整数"};let r=(n-1)*a,o=a,s=await t.request({url:"https://api.weixin.qq.com/wxa/business/getliveinfo?access_token="+i,method:"POST",data:{start:r,limit:o},useContent:!0});switch(s=U(s),s.code){case 941e4:s.msg="直播间列表为空"}return s},j.app={},j.app.auth={},j.app.auth.getAppidInfo=function(e={}){let{appid:t,appsecret:n}=e,{vk:a,config:i}=F;if(t){if(!n){let e=a.pubfn.getData(i,"vk.oauth.weixin.list")||[],r=a.pubfn.getListItem(e,"appid",t)||{};t=r.appid,n=r.appsecret}}else{let e=a.pubfn.getData(i,"uni.app-plus.oauth.weixin")||{};t=e.appid,n=e.appsecret}if(a.pubfn.isNullOne(t,n))throw new Error("请先配置微信小程序appid和appsecret");return{appid:t,appsecret:n}},j.app.auth.getAccessToken=async function(e={}){let{appid:t,appsecret:n}=j.app.auth.getAppidInfo(e),{vk:a,config:i}=F,{code:r}=e,o=await a.request({url:`https://api.weixin.qq.com/sns/oauth2/access_token?appid=${t}&secret=${n}&code=${r}&grant_type=authorization_code`,method:"GET"});return o.errcode?(console.error("getAccessToken失败：",o),{code:o.errcode,msg:o.errmsg,err:o}):{...o,code:0,msg:"ok"}},j.app.auth.getUserInfo=async function(e={}){let{appid:t,appsecret:n}=j.app.auth.getAppidInfo(e),{vk:a,config:i}=F,{access_token:r,openid:o,lang:s="zh-CN"}=e;if(!r)return{code:-1,msg:"access_token不能为空"};let l=await a.request({url:`https://api.weixin.qq.com/sns/userinfo?access_token=${r}&openid=${o}$lang=${s}`,method:"GET"});return l.errcode?(console.error("getUserInfo失败：",l),{code:l.errcode,msg:l.errmsg,err:l}):{...l,code:0,msg:"ok",avatar:l.headimgurl,gender:l.sex}};var L=j,z={},W={};z.init=function(e){W=e},z.open={},z.open.auth={},z.open.auth.getAppidInfo=function(e={}){let{appid:t,appsecret:n}=e,{vk:a,config:i}=W;if(!t){let e=a.pubfn.getData(i,"vk.service.openapi.baidu")||{};t=e.appid,n=e.appsecret}if(a.pubfn.isNullOne(t,n))throw new Error("请在cloudfunctions/common/config/index.js中配置并检查百度开放平台的appid和appsecret是否正确，参数路径：vk.service.openapi.baidu");return{appid:t,appsecret:n}},z.open.auth.getAccessTokenFn=async function(e={}){let{appid:t,appsecret:n}=z.open.auth.getAppidInfo(e),{vk:a,config:i}=W,r=await a.request({url:`https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${t}&client_secret=${n}`,method:"GET"});return r.error_code?(console.error("getAccessToken失败：",r),{code:r.error_code,msg:r.error_msg,err:r}):{...r,code:0,msg:"ok"}},z.open.auth.getAccessToken=async function(e={}){let t,{appid:n,appsecret:a}=z.open.auth.getAppidInfo(e),{cache:i=!0}=e,{vk:r}=W,o="openapi-baidu-"+n;if(i&&(t=await r.globalDataCache.get(o)),r.pubfn.isNull(t)){let n=await z.open.auth.getAccessTokenFn(e);0===n.code&&(t=n.access_token,await r.globalDataCache.set(o,t,n.expires_in-3600),await r.globalDataCache.deleteExpired())}return t},z.open.ocr={},z.open.ocr.business_license=async function(e={}){let{image:t,url:n}=e;return await z.open.request({...e,action:"ocr/v1/business_license",actionVersion:"2.0",data:{image:t,url:n}})},z.open.ocr.idcard=async function(e={}){let{image:t,url:n,id_card_side:a,detect_risk:i,detect_photo:r}=e;return await z.open.request({...e,action:"ocr/v1/idcard",actionVersion:"2.0",data:{image:t,url:n,id_card_side:a,detect_risk:i,detect_photo:r}})},z.open.request=async function(e={}){let{vk:t}=W,n=await z.open.auth.getAccessToken(e);if(!n)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};let{action:a,actionVersion:i="2.0",header:r={"content-type":"application/x-www-form-urlencoded"},data:o}=e,s=await t.request({url:`https://aip.baidubce.com/rest/${i}/${a}?access_token=${n}`,method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},data:o});return s.error_code?{code:s.error_code,msg:s.error_msg,err:s}:{...s,code:0,msg:"ok"}};var H=z,K={};K.weixin=L,K.baidu=H,K.init=function(e){K.weixin.init(e),K.baidu.init(e)};var Q=K;const V=/^multipart\/.+?(?:;\s*boundary=(?:(?:"(.+)")|(?:([^\s]+))))$/i,Y=/Content-Disposition:\sform-data;\sname="(.+?)"(?:;\sfilename="(.+?)")?/i,Z=/Content-Type:\s(.+?)$/i;var G={FormData:class{constructor(){this._shouldUseCache=!1,this._cachedBuffer=null,this._lineBreak="\r\n",this._boundary="------FormDataBaseBoundary"+Math.random().toString(36).substring(2),this.dataList=[]}_addData(e){if(this._shouldUseCache=!1,0===this.dataList.length)return void this.dataList.push(e);const t=this.dataList[this.dataList.length-1];switch(`${Buffer.isBuffer(t)?"buffer":"other"}_${Buffer.isBuffer(e)?"buffer":"other"}`){case"buffer_buffer":this.dataList.push(this._lineBreak),this.dataList.push(e);break;case"buffer_other":this.dataList.push(this._lineBreak+e);break;case"other_buffer":this.dataList[this.dataList.length-1]=t+"\r\n",this.dataList.push(e);break;case"other_other":this.dataList[this.dataList.length-1]=t+"\r\n"+e}}append(e,t,n){this._addData("--"+this._boundary);let a=`Content-Disposition: form-data; name="${encodeURIComponent(e)}"`;if(Buffer.isBuffer(t)){if(!n.filename||!n.contentType)throw new Error("filename and contentType required");a+=`; filename="${encodeURIComponent(n.filename)}"`,this._addData(a),this._addData("Content-Type: "+n.contentType),this._addData(""),this._addData(t)}else this._addData(a),this._addData(""),this._addData(t)}getHeaders(e){const t={"Content-Type":"multipart/form-data; boundary="+this._boundary};return Object.assign(t,e)}getBuffer(){if(this._shouldUseCache)return this._cachedBuffer;this._shouldUseCache=!0;let e=Buffer.alloc(0);return this.dataList.forEach(t=>{e=Buffer.isBuffer(t)?Buffer.concat([e,t]):Buffer.concat([e,Buffer.from(""+t)])}),e=Buffer.concat([e,Buffer.from(`${this._lineBreak}--${this._boundary}--`)]),this._cachedBuffer=e,e}},formParser:e=>{const t=(e.headers["content-type"]||e.headers["Content-Type"]).match(V),n=t[1]||t[2],a=function(e,t){let n=0,a=0,i=[];for(;-1!==(a=e.indexOf(t,n));)i.push(e.slice(n,a)),n=a+t.length,a=e.indexOf(t,n);return i}(Buffer.from(e.body,"base64"),Buffer.from("--"+n)).map(e=>function(e){let t=e.indexOf("\r\n")+"\r\n".length,n=t,a=e.lastIndexOf("\r\n"),i=[];for(;-1!==(n=e.indexOf("\r\n",t));)if(i.push(e.slice(t,n)),t=n+"\r\n".length,0===i[i.length-1].length){i.push(e.slice(t,a));break}return i}(e).filter(e=>e.length>0)).filter(e=>2===e.length||3===e.length||4===e.length).map(e=>{const t={},n=e[0].toString().match(Y);switch(t.name=decodeURIComponent(n[1]),e.length){case 2:t.value=e[1].toString();break;case 3:t.filename=decodeURIComponent(n[2]),t.contentType=e[1].toString().match(Z)[1],t.fileContent=e[2];break;case 4:t.filename=decodeURIComponent(n[2]),t.contentType=e[1].toString().match(Z)[1],t.fileContent=e[3]}return t}),i={};return a.forEach(e=>{const t=e.name;delete e.name,i[t]=e.fileContent?e:e.value}),i}};const X="opendb-admin-menus";var ee={},te={};ee.init=function(e){te=e},ee.listMenuByRole=async(e={})=>{let{vk:t,db:n,_:a}=te,i={code:0,msg:"",menus:[],menuList:[]},{role:r}=e,o=[],s={enable:!0};if(!(r.indexOf("admin")>-1)){if(t.pubfn.isNull(r))return i;let e=await t.baseDao.select({dbName:"uni-id-roles",whereJson:{role_id:a.in(r),enable:!0},fieldJson:{menu:!0}});for(let n in e.rows){let{menu:a}=e.rows[n];t.pubfn.isNotNull(a)&&(o=o.concat(a))}if(0==o.length)return i;o=[...new Set(o)],s.menu_id=a.in(o)}let l=await t.baseDao.select({dbName:X,whereJson:s,sortArr:[{name:"sort",type:"asc"}]});return i.menus=t.pubfn.arrayToTree(l.rows,{id:"menu_id",parent_id:"parent_id",children:"children"}),i.menuList=l.rows,i},ee.roleBindPermission=async(e={})=>{let{vk:t,db:n,_:a}=te,i={code:0,msg:""},{role_id:r="___",permissionList:o=[],reset:s=!1}=e;if(!s){let e=await ee.findRoleById(r),{permission:t=[]}=e;o=t.concat(o),o=[...new Set(o)]}return i.num=await t.baseDao.update({dbName:"uni-id-roles",whereJson:{role_id:r},dataJson:{permission:a.set(o)}}),i},ee.roleBindMenu=async(e={})=>{let{vk:t,db:n,_:a}=te,i={code:0,msg:""},{role_id:r="___",menuList:o=[],reset:s=!1,addPermission:l=!1}=e,d=[],c=await ee.findRoleById(r),{menu:u=[],permission:p=[]}=c;if(s?d=ae(o,u):(o=u.concat(o),o=[...new Set(o)]),i.num=await t.baseDao.update({dbName:"uni-id-roles",whereJson:{role_id:r},dataJson:{menu:a.set(o)}}),l){let e=await ee.findMenuByIdsToPermission(o),n=[];if(s&&t.pubfn.isNotNull(d)){n=ae(e,await ee.findMenuByIdsToPermission(d))}p=p.concat(e),p=ae(n,p),p=[...new Set(p)],ee.roleBindPermission({role_id:r,permissionList:p,reset:!0})}return i},ee.menuBindPermission=async(e={})=>{let{vk:t,db:n,_:a}=te,i={code:0,msg:""},{menu_id:r="___",permissionList:o=[],reset:s=!1}=e;if(!s){let e=await ee.findMenuById(r),{permission:t=[]}=e;o=t.concat(o),o=[...new Set(o)]}return i.num=await t.baseDao.update({dbName:X,whereJson:{menu_id:r},dataJson:{permission:a.set(o)}}),i},ee.findRoleById=async(e="___")=>{let t,{vk:n,db:a,_:i}=te;return t=await n.baseDao.findByWhereJson({dbName:"uni-id-roles",whereJson:{role_id:e}}),t},ee.findPermissionById=async(e="___")=>{let t,{vk:n,db:a,_:i}=te;return t=await n.baseDao.findByWhereJson({dbName:"uni-id-permissions",whereJson:{permission_id:e}}),t},ee.findMenuById=async(e="___")=>{let t,{vk:n,db:a,_:i}=te;return t=await n.baseDao.findByWhereJson({dbName:X,whereJson:{menu_id:e}}),t},ee.findMenuByIds=async e=>{let t,{vk:n,db:a,_:i}=te;return n.pubfn.isNull(e)?[]:(t=(await n.baseDao.select({dbName:X,pageIndex:1,pageSize:500,whereJson:{menu_id:i.in(e)}})).rows,t)},ee.findMenuByIdsToPermission=async e=>{let{vk:t,db:n,_:a}=te,i=await ee.findMenuByIds(e);if(t.pubfn.isNull(i))return[];let r=[];for(let e in i){let n=i[e].permission;t.pubfn.isNotNull(n)&&(r=r.concat(n))}return r=[...new Set(r)],r};var ne=ee;function ae(e,t){let n=new Set(e);return t.filter(e=>!n.has(e))}const ie="opendb-global-data";var re={},oe={};re.init=function(e){oe=e},re.find=async e=>{let{vk:t,db:n,_:a}=oe,i={};return i=await t.baseDao.findById({dbName:ie,id:e}),i},re.del=async e=>{let{vk:t,db:n,_:a}=oe,i={};return i=await t.baseDao.deleteById({dbName:ie,id:e}),i},re.deleteByWhere=async e=>{let{vk:t,db:n,_:a}=oe,i={};return i=await t.baseDao.del({dbName:ie,whereJson:e}),i},re.deleteExpired=async e=>{let{vk:t,db:n,_:a}=oe,i={},r=(new Date).getTime();return i=await t.baseDao.del({dbName:ie,whereJson:{expired_at:a.gt(0).lte(r)}}),i},re.update=async e=>{let{vk:t,db:n,_:a}=oe,i={},{key:r,value:o,comment:s,expired_at:l}=e;return i=await t.baseDao.updateById({dbName:ie,id:r,dataJson:{value:a.set(o),comment:s,expired_at:l}}),i},re.add=async e=>{let{vk:t,db:n,_:a}=oe,i={},{key:r,value:o,comment:s,expired_at:l}=e;return i=await t.baseDao.add({dbName:ie,dataJson:{_id:r,key:r,value:o,comment:s,expired_at:l}}),i},re.count=async e=>{let{vk:t,db:n,_:a}=oe,i={};return i=await t.baseDao.count({dbName:ie,whereJson:e}),i},re.set=async e=>{let t={code:0,msg:"ok"};return await re.count({_id:e.key})>0?(t.num=await re.update(e),t.mode="update"):(t.id=await re.add(e),t.num=1,t.mode="add"),t},re.inc=async e=>{let{vk:t,db:n,_:a}=oe,{key:i,value:r,expired_at:o}=e,s={},l=await t.baseDao.updateById({dbName:ie,id:i,dataJson:{value:a.inc(r),expired_at:o}});if(0==l){0===await re.count({_id:i})&&(s.id=await re.add(e),s.num=1,s.mode="add")}else s.num=l,s.mode="update";return s},re.list=async e=>{let{vk:t,db:n,_:a}=oe,i={},{pageIndex:r,pageSize:o,whereJson:s,sortArr:l}=e;return i=await t.baseDao.select({dbName:ie,pageIndex:r,pageSize:o,whereJson:s,sortArr:l}),i};var se=re,le={};le.sysDao=ne,le.globalDataDao=se,le.init=function(e){let t=["sysDao","globalDataDao"];for(let n in t){let a=t[n];"function"==typeof le[a].init&&le[a].init(e)}};var de=le,ce={};ce.router=d,ce.md5=y,ce.baseDao=w,ce.request=_,ce.pubfn=I,ce.payUtil=C,ce.temporaryCache=M,ce.globalDataCache=R,ce.openapi=Q,ce.formDataUtil=G,ce.system=de,ce.requireCache={},ce.require=function(e){if(ce.requireCache&&ce.requireCache[e])return ce.requireCache[e];{const t=ce.config.requireFn(ce.config.baseDir+"/"+e);return ce.requireCache[e]=t,t}},ce.use=function(e,t){for(let n in e)e[n]&&"function"==typeof e[n].init&&e[n].init(t),ce[n]=e[n]},ce.config={},ce.init=function(e){ce.config.config=e.config,ce.config.uniID=e.uniID,ce.config.uniPay=e.uniPay,ce.config.db=e.db,ce.config._=e.db.command,ce.config.pubfn=ce.pubfn,ce.config.middlewareService=e.middlewareService,ce.config.pubFun=e.pubFun,ce.config.customUtil=e.customUtil,ce.config.baseDir=e.baseDir,ce.config.requireFn=e.requireFn,ce.config.crypto=e.crypto;const t={vk:ce,...ce.config};ce.use({daoCenter:e.daoCenter,baseDao:ce.baseDao,openapi:ce.openapi,globalDataCache:ce.globalDataCache,system:ce.system},t)};var ue=ce;module.exports=ue;
