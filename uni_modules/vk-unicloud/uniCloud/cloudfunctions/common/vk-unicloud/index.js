"use strict";var e={regExpTest:function(e,t){let n=!1;if("string"==typeof e){new RegExp(e).test(t)&&(n=!0)}else if("object"==typeof e)for(let r=0;r<e.length;r++){if(new RegExp(e[r]).test(t)){n=!0;break}}else"function"==typeof e&&(n=e(t));return n}},t=e,n={main:async e=>{let{url:t,data:n={},util:r}=e,{uniID:a}=r,{need_user_info:i}=n,o={code:-1,msg:""};void 0===i&&(i=-1==t.indexOf("."));let s=0==t.indexOf("admin/");s&&(i=!0);let l=t.indexOf("/sys/")>-1,c=await a.checkToken(e.uniIdToken,{needPermission:l,needUserInfo:i});if(c.code&&c.code>0)return c;if(c.userInfo){let e=c.userInfo;e.permission=c.permission,delete e.token,delete e.password,o.userInfo=e}if(o.uid=c.uid,c.token&&(o.token=c.token,o.tokenExpired=c.tokenExpired),s){if(!o.userInfo)return{code:403,msg:"need_user_info必须为true"};{let e=o.userInfo.role||[];if(!o.userInfo.allow_login_background&&!e.includes("admin"))return{code:403,msg:"您无权限登录后台"}}}return o.code=0,o.msg="ok",o}};async function r(e={},t){let{vk:n,db:r,_:a}=t,{whereJson:i={},fieldJson:o={},justNeedID:s=!1}=e;s&&(o={permission_id:!0}),i.enable=!0;let l=[],c=await n.baseDao.select({dbName:"uni-id-permissions",pageIndex:1,pageSize:500,fieldJson:o,whereJson:i});if(s)for(let e=0;e<c.rows.length;e++){let t=c.rows[e];l.push(t.permission_id)}else l=c.rows;return l}var a=[{id:"pub",regExp:function(e=""){return"pub"===i(e)},description:"pub函数为所有人都可以访问的函数",index:100,mode:"onActionExecuting",main:async function(e){let t={};return e.data.need_user_info&&(t=await n.main(e)),t.code=0,t.msg="ok",t}},{id:"kh",regExp:function(e=""){return"kh"===i(e)},description:"kh函数为必须登录后才能访问的函数(客户端用户)",index:200,mode:"onActionExecuting",main:n.main},{id:"sys",regExp:function(e=""){return"sys"===i(e)},description:"sys函数为后端管理人员才能访问的函数(商家后台工作人员)",index:300,mode:"onActionExecuting",main:{main:async e=>{let{url:t,util:a}=e,{uniID:i,config:o,pubFun:s,vk:l,db:c,_:d}=a,u={code:-1,msg:""};const f=n;if(u=await f.main(e),0!==u.code)return u;if(!u.userInfo)return{code:403,msg:"请去除need_user_info:false"};if(u.userInfo.role||(u.userInfo.role=[]),u.userInfo.role.includes("admin"))return u;if(!u.userInfo.allow_login_background)return{code:403,msg:"您无权限登录后台"};let p=[];if(u.userInfo.role.includes("admin-lv3")){let e=await r({whereJson:{level:d.in([1,2,3])},justNeedID:!0},a);l.pubfn.isNotNull(e)&&(p=p.concat(e))}if(u.userInfo.role.includes("admin-lv2")){let e=await r({whereJson:{level:d.in([1,2])},justNeedID:!0},a);l.pubfn.isNotNull(e)&&(p=p.concat(e))}if(u.userInfo.role.includes("admin-lv1")){let e=await r({whereJson:{level:d.in([1])},justNeedID:!0},a);l.pubfn.isNotNull(e)&&(p=p.concat(e))}if(u.userInfo.role.includes("query-all")){let e=await r({whereJson:{curd_category:4,level:d.neq(4)},justNeedID:!0},a);l.pubfn.isNotNull(e)&&(p=p.concat(e))}let g=await async function(e,t){let{vk:n,db:r,_:a}=t,{role:i}=e;if(n.pubfn.isNull(i))return[];return(await n.baseDao.select({dbName:"uni-id-roles",whereJson:{role_id:a.in(i),enable:!0},fieldJson:{permission:!0}})).rows}({role:u.userInfo.role},a);for(let e in g){let{permission:t}=g[e];l.pubfn.isNotNull(t)&&(p=p.concat(t))}if(0==p.length)return{code:403,msg:"权限不足"};p=[...new Set(p)];let m=await r({whereJson:{permission_id:d.in(p),match_mode:d.in([1,2])}},a),b=!1;for(let e=0;e<m.length;e++){let n=m[e];if(1===n.match_mode){if(l.pubfn.wildcardTest(t,n.url)){b=!0;break}}else if(2===n.match_mode&&l.pubfn.regExpTest(t,n.url)){b=!0;break}}if(!b){await async function(e,t){let{vk:n,db:r,_:a}=t,{myPermission:i,url:o}=e;if(n.pubfn.isNull(i))return!1;return await n.baseDao.count({dbName:"uni-id-permissions",whereJson:{enable:!0,permission_id:a.in(i),url:o,match_mode:a.nin([1,2])}})>0}({myPermission:p,url:t},a)&&(b=!0)}return b?(u.code=0,u.msg="ok",u):{code:403,msg:"权限不足"}}}.main},{id:"access_denied",regExp:function(e=""){return"access denied"===i(e)},description:"sys函数为后端管理人员才能访问的函数(商家后台工作人员)",index:100,mode:"onActionExecuting",main:function(){return{code:403,msg:"禁止访问私有函数！"}}}];function i(e=""){let t="";return e.indexOf("/sys/")>-1?t="sys":e.indexOf("/kh/")>-1?t="kh":e.indexOf("/pub/")>-1&&(t="pub"),e.indexOf("/sys.")>-1||e.indexOf("/sys_")>-1?t="sys":e.indexOf("/kh.")>-1||e.indexOf("/kh_")>-1?t="kh":(e.indexOf("/pub.")>-1||e.indexOf("/pub_")>-1)&&(t="pub"),e.indexOf(".sys_")>-1?t="sys":e.indexOf(".kh_")>-1?t="kh":e.indexOf(".pub_")>-1&&(t="pub"),""==t&&e.indexOf(".")>-1&&(t="kh"),e.indexOf("._")>-1&&(t="access denied"),t}var o={onActionExecuting:async(e={})=>{let{serviceParam:n,middlewareService:r=[]}=e,a={code:403,msg:"access denied",filterStack:[]},{url:i}=n;for(let e in r){let o=r[e],{mode:s="onActionExecuting",enable:l=!0}=o;if(l&&"onActionExecuting"===s&&t.regExpTest(o.regExp,i)){n.filterResponse=a;let e=await o.main(n);if(e.filterId=o.id,a.filterStack.push(e),0!==e.code){a=e;break}a=Object.assign(a,e)}}return a},onActionExecuted:async(e={})=>{let{serviceParam:n,middlewareService:r=[],serviceRes:a}=e,{url:i}=n;for(let e in r){let o=r[e],{mode:s,enable:l=!0}=o;if(l&&"onActionExecuted"===s&&t.regExpTest(o.regExp,i)){let e=await o.main(n,a);if(e){if(0!==e.code){a=e;break}a=Object.assign(a,e)}}}return a},onActionIntercepted:async(e={})=>{let{serviceParam:n,middlewareService:r=[],filterResponse:a}=e,{url:i}=n;for(let e in r){let o=r[e],{mode:s,enable:l=!0}=o;if(l&&"onActionIntercepted"===s&&t.regExpTest(o.regExp,i)){let e=await o.main(n,a);if(e){if(0!==e.code){a=e;break}a=Object.assign(a,e)}}}return a},onActionError:async(e={})=>{let{serviceParam:n,middlewareService:r=[],serviceRes:a}=e,{url:i}=n;for(let e in r){let o=r[e],{mode:s,enable:l=!0}=o;if(l&&"onActionError"===s&&t.regExpTest(o.regExp,i)){let e=await o.main(n,a);if(e){if(0!==e.code){a=e;break}a=Object.assign(a,e)}}}return a},getMiddleware:function(e){let t=[];if(e){let n=[...a,...e];n.sort((function(e,t){return e.index-t.index})),t=n.filter((e,t,r)=>{var a=[];return n.forEach((e,t)=>{a.push(e.id)}),a.indexOf(e.id)===t})}else t=a;return t}},s={filterService:o,getQueryStringParameters:function(e){let{event:t,vk:n}=e,r={};if(t.httpMethod){let{path:e=""}=t;if("/"===e[0]&&(e=e.substring(1)),e){let a,{urlrewrite:i={}}=n.getUnicloud(),{rule:o}=i,s=n.pubfn.getData(i,"config.accessOnlyInRule"),l=!1;if(o)for(let t in o){let r=o[t],i=n.pubfn.regExpExecToTemplate(e,t,r);if(i){l=!0;let t=i.split("?");e=t[0],a=n.pubfn.urlStringToJson(t[1]);break}}if(!l&&s)return{mpserverlessComposedResponse:!0,statusCode:403,code:403,headers:{"content-type":"application/json"},body:JSON.stringify({code:403,msg:"access denied"})};if(r={data:{}},n.pubfn.isNotNull(a)&&(r.data=Object.assign(r.data,a)),t.queryStringParameters){let e=t.queryStringParameters;"string"==typeof e&&(e=JSON.parse(e)),r.data=Object.assign(r.data,e)}if(t.body){let e=t.body,a=t.headers&&t.headers["content-type"]?t.headers["content-type"]:"";if(a.indexOf("multipart/form-data;")>-1)e=n.formDataUtil.formParser(t),r.data=Object.assign(r.data,e);else{t.isBase64Encoded&&(e=Buffer.from(e,"base64").toString("utf-8"));try{"string"==typeof e&&(e=JSON.parse(e)),r.data=Object.assign(r.data,e)}catch(e){}try{"string"==typeof e&&a.indexOf("x-www-form-urlencoded")>-1&&(e=n.pubfn.urlStringToJson(e),"object"==typeof e&&(e=n.pubfn.string2Number(e),r.data=Object.assign(r.data,e)))}catch(e){}}}r.$url||(r.data.$url?r.$url=r.data.$url:r.$url=e),r.data.uni_id_token&&(r.uni_id_token=r.data.uni_id_token,delete r.data.uni_id_token)}else{if(t.queryStringParameters){let e=t.queryStringParameters;"string"==typeof e.data&&(e.data=JSON.parse(e.data)),r=Object.assign(r,e)}if(t.body){let e=t.body;t.isBase64Encoded&&(e=Buffer.from(e,"base64").toString("utf-8"));try{"string"==typeof e&&(e=JSON.parse(e)),r=Object.assign(r,e)}catch(e){}}}}else r=JSON.parse(JSON.stringify(t));return r.data||(r.data={}),r.uniIdToken||(r.uniIdToken=r.uni_id_token),r.url=r.$url||"",r},returnError:l,filterInterception:async function({serviceParam:e,middlewareService:t,filterResponse:n}){try{n=await o.onActionIntercepted({serviceParam:e,middlewareService:t,filterResponse:n})}catch(n){return await l({code:500,msg:`云函数 ${e.url} 的中间件 onActionIntercepted 运行异常!`,err:n,serviceParam:e,middlewareService:t})}return n},requireService:async function(e={}){let t,{vk:n,serviceParam:r}=e,{url:a,data:i,uniIdToken:o,util:s,filterResponse:l={},originalParam:c={}}=r;if(a.indexOf(".")>-1){let e,r=a.lastIndexOf("."),d=n.require("service/"+a.substring(0,r));t=n.pubfn.objectAssign({},d);let u=a.substring(r+1);if(0==u.indexOf("_"))throw new Error("msg:禁止访问私有函数！");if("function"!=typeof t[u]){try{c.event&&c.event.httpMethod&&c.event.path&&(a=c.event.path.substring(1))}catch(e){}throw new Error(`msg:云函数【${a}】不存在！`)}Object.assign(t,{vk:n,methodName:u,isCloudObject:!0,getClientInfo:function(){let{context:e={}}=c;return{uid:l.uid,userInfo:l.userInfo,filterResponse:l,originalParam:c,os:e.OS,appId:e.APPID,locale:e.LOCALE,clientIP:e.CLIENTIP,userAgent:e.CLIENTUA,platform:e.PLATFORM,deviceId:e.DEVICEID,uniIdToken:o}},getUserInfo:async function(){if(l.userInfo&&l.userInfo._id)return l.userInfo;if(!e&&l.uid){let t=await s.uniID.getUserInfo({uid:l.uid});t.userInfo&&t.userInfo._id&&(delete t.userInfo.token,delete t.userInfo.password,e=t.userInfo)}return e},getUtil:function(){return s},getMethodName:function(){return u},getParams:function(){return i},getCloudInfo:function(){let{SPACEINFO:e={}}=c.context||{},{provider:t,spaceId:n}=e;return{provider:t,spaceId:n}},getUniIdToken:function(){return o}})}else t=n.require("service/"+a);return t},serviceRun:async function(e={}){let t,{serviceParam:n={},serviceMain:r}=e,{filterResponse:a}=n;if(a.uid&&(n.uid=a.uid),a.userInfo&&(n.userInfo=a.userInfo),r.isCloudObject){let{methodName:e="main"}=r;if("function"==typeof r._before){let e=await r._before();if("string"==typeof e)return{code:-1,msg:e};if("object"==typeof e&&0!==e.code)return{code:-1,msg:e.msg};if("boolean"==typeof e&&!1===e)return{code:-1,msg:""}}if(t=await r[e](n.data),"function"==typeof r._after){let e=await r._after({res:t||{}});"object"==typeof e&&(t=e)}}else t=await r.main(n);return"object"==typeof t&&void 0===t.vk_uni_token&&"object"==typeof a&&a.token&&void 0!==a.tokenExpired&&(t.vk_uni_token={token:a.token,tokenExpired:a.tokenExpired}),t},errorCatch:async function(e={}){let{err:t,type:n,serviceParam:r,middlewareService:a,serviceMain:i={}}=e,{url:o,originalParam:s={}}=r;t||(t={});let{code:c,message:d=""}=t;if("run"===n&&"function"==typeof i._after){let e=await i._after({err:t});if(e)return e}let u={code:500,msg:d,err:t,serviceParam:r,middlewareService:a};try{s.event&&s.event.httpMethod&&s.event.path&&(o=s.event.path.substring(1))}catch(t){}return"MODULE_NOT_FOUND"==c&&d.indexOf("service/")>-1||"ENOENT"==c&&d.indexOf("service")>-1?Object.assign(u,{code:404,msg:`云函数 ${o} 不存在!`}):"MODULE_NOT_FOUND"==c&&d.indexOf("Cannot find module")>-1?Object.assign(u,{code:500,msg:d}):"InternalServerError"==c&&d.indexOf("_id_ dup key")>-1?Object.assign(u,{code:500,msg:"vk.baseDao.add : _id不能重复添加"}):0===d.indexOf("Cannot read property 'mp-weixin' of undefined")?Object.assign(u,{code:501,msg:"请先绑定微信"}):d.indexOf("Response timeout for 10000ms")>-1?Object.assign(u,{code:502,msg:"timeout 请求超时，请重试！"}):0===d.indexOf("msg:")?Object.assign(u,{code:501,msg:d.substring(4)}):"Error"===t.name?Object.assign(u,{code:501,msg:d}):"ReferenceError"===t.name?Object.assign(u,{code:501,msg:`云函数 ${o} 变量引用错误：${d}`}):"TypeError"===t.name?Object.assign(u,{code:501,msg:`云函数 ${o} 运行异常，类型错误：${d}`}):Object.assign(u,{code:500,msg:"require"==n?`云函数 ${o} 编译异常!`:`云函数 ${o} 运行异常!`}),await l(u)}};async function l(e={}){let{code:t,msg:n,err:r,serviceParam:a,middlewareService:i}=e;console.error(n);let s={code:t,msg:n};return r&&(console.error(r.stack),s.err={message:r.message,stack:r.stack,code:r.code}),await o.onActionError({serviceParam:a,middlewareService:i,serviceRes:s})}process.env.TZ="Asia/Shanghai";var c=async function(e){let{event:t,context:n,vk:r}=e,{config:a,uniID:i,uniPay:o,db:l,middlewareService:c,pubFun:d,customUtil:u,crypto:f}=r.getUnicloud();if(r.pubfn.getData(a,"vk.system.serviceShutdown"))return{code:405,msg:r.pubfn.getData(a,"vk.system.serviceShutdownDescription")};let p={event:t,context:n},g=s.getQueryStringParameters(e),{url:m,data:b,uniIdToken:h}=g;if([403].indexOf(g.code)>-1)return g;if(m&&"function"==typeof m.trim&&(m=m.trim()),b&&(b.vk_appid&&(n.APPID=b.vk_appid),b.vk_platform&&(n.PLATFORM=b.vk_platform),r.pubfn.isNullOne(n.APPID,n.PLATFORM))){let e=r.pubfn.getData(a,"vk.context");r.pubfn.isNotNull(e)&&(n.APPID||(n.APPID=e.APPID),n.PLATFORM||(n.PLATFORM=e.PLATFORM),n.LOCALE||(n.LOCALE=e.LOCALE))}const y=i.createInstance({context:n});l.command.$=l.command.aggregate;let w={vk:r,config:a,pubFun:d,uniID:y,uniPay:o,db:l,_:l.command,$:l.command.aggregate,customUtil:u,crypto:f,env:{APPID:n.APPID,PLATFORM:n.PLATFORM}};try{uniCloud.vk=r,uniCloud.env=w.env}catch(e){}let _={url:m,data:b,uniIdToken:h,util:w,originalParam:p};const k=s.filterService.getMiddleware(c);try{let e=await s.filterService.onActionExecuting({serviceParam:_,middlewareService:k});if(0!==e.code)return await s.filterInterception({serviceParam:_,middlewareService:k,filterResponse:e});e.uid&&(b.uid=e.uid),_.filterResponse=e}catch(e){return await s.returnError({code:500,msg:`云函数 ${m} 的中间件 onActionExecuting 运行异常!`,err:e,serviceParam:_,middlewareService:k})}let N,v;try{N=await s.requireService({vk:r,serviceParam:_})}catch(e){return await s.errorCatch({err:e,type:"require",serviceParam:_,middlewareService:k})}try{v=await s.serviceRun({serviceParam:_,serviceMain:N})}catch(e){return await s.errorCatch({err:e,type:"run",serviceParam:_,middlewareService:k,serviceMain:N})}try{v=await s.filterService.onActionExecuted({serviceParam:_,middlewareService:k,serviceRes:v})}catch(e){return await s.returnError({code:500,msg:`云函数 ${m} 的中间件 onActionExecuted 运行异常!`,err:e,serviceParam:_,middlewareService:k})}return v};function d(e,t,n,r,a,i){return m((o=m(m(t,e),m(r,i)))<<(s=a)|o>>>32-s,n);var o,s}function u(e,t,n,r,a,i,o){return d(t&n|~t&r,e,t,a,i,o)}function f(e,t,n,r,a,i,o){return d(t&r|n&~r,e,t,a,i,o)}function p(e,t,n,r,a,i,o){return d(t^n^r,e,t,a,i,o)}function g(e,t,n,r,a,i,o){return d(n^(t|~r),e,t,a,i,o)}function m(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}var b=function(e){return function(e){for(var t="",n=0;n<4*e.length;n++)t+="0123456789abcdef".charAt(e[n>>2]>>n%4*8+4&15)+"0123456789abcdef".charAt(e[n>>2]>>n%4*8&15);return t}(function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,r=-271733879,a=-1732584194,i=271733878,o=0;o<e.length;o+=16){var s=n,l=r,c=a,d=i;n=u(n,r,a,i,e[o+0],7,-680876936),i=u(i,n,r,a,e[o+1],12,-389564586),a=u(a,i,n,r,e[o+2],17,606105819),r=u(r,a,i,n,e[o+3],22,-1044525330),n=u(n,r,a,i,e[o+4],7,-176418897),i=u(i,n,r,a,e[o+5],12,1200080426),a=u(a,i,n,r,e[o+6],17,-1473231341),r=u(r,a,i,n,e[o+7],22,-45705983),n=u(n,r,a,i,e[o+8],7,1770035416),i=u(i,n,r,a,e[o+9],12,-1958414417),a=u(a,i,n,r,e[o+10],17,-42063),r=u(r,a,i,n,e[o+11],22,-1990404162),n=u(n,r,a,i,e[o+12],7,1804603682),i=u(i,n,r,a,e[o+13],12,-40341101),a=u(a,i,n,r,e[o+14],17,-1502002290),r=u(r,a,i,n,e[o+15],22,1236535329),n=f(n,r,a,i,e[o+1],5,-165796510),i=f(i,n,r,a,e[o+6],9,-1069501632),a=f(a,i,n,r,e[o+11],14,643717713),r=f(r,a,i,n,e[o+0],20,-373897302),n=f(n,r,a,i,e[o+5],5,-701558691),i=f(i,n,r,a,e[o+10],9,38016083),a=f(a,i,n,r,e[o+15],14,-660478335),r=f(r,a,i,n,e[o+4],20,-405537848),n=f(n,r,a,i,e[o+9],5,568446438),i=f(i,n,r,a,e[o+14],9,-1019803690),a=f(a,i,n,r,e[o+3],14,-187363961),r=f(r,a,i,n,e[o+8],20,1163531501),n=f(n,r,a,i,e[o+13],5,-1444681467),i=f(i,n,r,a,e[o+2],9,-51403784),a=f(a,i,n,r,e[o+7],14,1735328473),r=f(r,a,i,n,e[o+12],20,-1926607734),n=p(n,r,a,i,e[o+5],4,-378558),i=p(i,n,r,a,e[o+8],11,-2022574463),a=p(a,i,n,r,e[o+11],16,1839030562),r=p(r,a,i,n,e[o+14],23,-35309556),n=p(n,r,a,i,e[o+1],4,-1530992060),i=p(i,n,r,a,e[o+4],11,1272893353),a=p(a,i,n,r,e[o+7],16,-155497632),r=p(r,a,i,n,e[o+10],23,-1094730640),n=p(n,r,a,i,e[o+13],4,681279174),i=p(i,n,r,a,e[o+0],11,-358537222),a=p(a,i,n,r,e[o+3],16,-722521979),r=p(r,a,i,n,e[o+6],23,76029189),n=p(n,r,a,i,e[o+9],4,-640364487),i=p(i,n,r,a,e[o+12],11,-421815835),a=p(a,i,n,r,e[o+15],16,530742520),r=p(r,a,i,n,e[o+2],23,-995338651),n=g(n,r,a,i,e[o+0],6,-198630844),i=g(i,n,r,a,e[o+7],10,1126891415),a=g(a,i,n,r,e[o+14],15,-1416354905),r=g(r,a,i,n,e[o+5],21,-57434055),n=g(n,r,a,i,e[o+12],6,1700485571),i=g(i,n,r,a,e[o+3],10,-1894986606),a=g(a,i,n,r,e[o+10],15,-1051523),r=g(r,a,i,n,e[o+1],21,-2054922799),n=g(n,r,a,i,e[o+8],6,1873313359),i=g(i,n,r,a,e[o+15],10,-30611744),a=g(a,i,n,r,e[o+6],15,-1560198380),r=g(r,a,i,n,e[o+13],21,1309151649),n=g(n,r,a,i,e[o+4],6,-145523070),i=g(i,n,r,a,e[o+11],10,-1120210379),a=g(a,i,n,r,e[o+2],15,718787259),r=g(r,a,i,n,e[o+9],21,-343485551),n=m(n,s),r=m(r,l),a=m(a,c),i=m(i,d)}return Array(n,r,a,i)}(function(e){for(var t=Array(),n=0;n<8*e.length;n+=8)t[n>>5]|=(255&e.charCodeAt(n/8))<<n%32;return t}(e),8*e.length))},h={},y={init:function(e){h=e},add:async function(e){let{db:t,_:n,vk:r,config:a}=h,{dbName:i,dataJson:o,db:s,cancelAddTime:l}=e;if(r.pubfn.isNull(i))throw new Error("vk.baseDao.add 中 dbName 不能为空");if(r.pubfn.isNull(o))throw new Error("vk.baseDao.add 中 dataJson 不能为空");let c=s||t;if(!o._add_time){let e=r.pubfn.getData(a,"vk.db.unicloud.cancelAddTime");if(void 0===l&&e&&(l=e),!l){let e=new Date;o._add_time=e.getTime(),o._add_time_str=r.pubfn.timeFormat(e,"yyyy-MM-dd hh:mm:ss")}}let d=await c.collection(i).add(o);return d.id?d.id:null},adds:async function(e){let{db:t,_:n,vk:r,config:a}=h,{dbName:i,dataJson:o,cancelAddTime:s,db:l}=e;if(r.pubfn.isNull(i))throw new Error("vk.baseDao.adds 中 dbName 不能为空");if(r.pubfn.isNull(o))throw new Error("vk.baseDao.adds 中 dataJson 不能为空");if("[object Array]"!==Object.prototype.toString.call(o))throw new Error("vk.baseDao.adds 中 dataJson 必须是数组对象");let c=l||t,d=r.pubfn.getData(a,"vk.db.unicloud.cancelAddTime");if(void 0===s&&d&&(s=d),!s){let e=new Date,t=e.getTime(),n=r.pubfn.timeFormat(e,"yyyy-MM-dd hh:mm:ss");for(let e in o)o[e]._add_time||(o[e]._add_time=t,o[e]._add_time_str=n)}let u=await c.collection(i).add(o);return u.ids?u.ids:u.id?u.id:null},del:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,whereJson:i,db:o}=e,s=o||n,l=0;if(t.pubfn.isNotNull(i)){let e=await s.collection(a).where(i).remove();e?l=e.deleted:(console.error(e.errMsg),l=-1)}else console.error("whereJson条件不能为空");return l},delete:async function(e){return await y.del(e)},remove:async function(e){return await y.del(e)},deleteById:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,id:i,db:o}=e,s=o||n,l=0;if(t.pubfn.isNull(i))throw new Error("deleteById的id不能为空,且必须是字符串");let c=await s.collection(a).doc(i).remove();return c?l=c.deleted:(console.error(c.errMsg),l=0),l},update:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,whereJson:i,dataJson:o,db:s}=e,l=s||n,c=0;if(t.pubfn.isNotNull(i)){let e=await l.collection(a).where(i).update(o);e?c=e.updated:(console.error(e.errMsg),c=-1)}else console.error("whereJson条件不能为空");return c},updateById:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,id:i,dataJson:o,getUpdateData:s,db:l}=e,c=l||n,d=0;if(t.pubfn.isNull(i))throw new Error("updateById的id不能为空,且必须是字符串");let u=await c.collection(a).doc(i).update(o);return s?u?await y.findById({db:c,dbName:a,id:i}):null:(u?d=u.updated:(console.error(u.errMsg),d=0),d)},updateAndReturn:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,id:i,whereJson:o,dataJson:s,db:l}=e,c=l||n;if(t.pubfn.isNullAll(i,o))throw new Error("updateAndReturn的id和whereJson两者不能都为空");if(t.pubfn.isNotNull(i)){return(await c.collection(a).doc(i).updateAndReturn(s)).doc}if(t.pubfn.isNotNull(o)){return(await c.collection(a).where(o).updateAndReturn(s)).doc}throw new Error("updateAndReturn的id和whereJson两者不能都为空")},select:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,whereJson:i,pageSize:o=10,getOne:s=!1,getMain:l=!1}=e;if(o<=0&&(o=999999999),o>500)return await y.selectAll(e);let c=await y.getSelectData(e),{result:d,hasMore:u,total:f,getCount:p,pageIndex:g,fieldJson:m}=c;return d=d.skip((g-1)*o).limit(o),t.pubfn.isNotNull(m)&&(d=d.field(m)),d.get().then(e=>{let t={};return p?(t.total=f,t.hasMore=u):(t.total=e.data?e.data.length:0,t.hasMore=t.total>=o),t.rows=e.data,t.code=0,t.msg="查询成功",t.pagination={pageIndex:g,pageSize:o},s&&(t.rows=t.rows[0]),l?t.rows:t})},findById:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,id:i,fieldJson:o,db:s}=e,l=(s||n).collection(a).doc(i);o&&(l=l.field(o));let c=await l.get();return"[object Array]"===Object.prototype.toString.call(c.data)?c.data[0]:c.data},findByWhereJson:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,whereJson:i,fieldJson:o,sortArr:s,db:l}=e,c=l||n;if(t.pubfn.isNotNull(i)){let e=c.collection(a).where(i);if(s)for(let t in s){let n=s[t],r=n.name,a=n.type;null!=a&&""!=a||(a="asc"),e=e.orderBy(r,a)}o&&(e=e.field(o));let t=await e.limit(1).get();if(t.data&&t.data.length>0)return t.data[0]}else console.error("whereJson条件不能为空");return null},count:async function(e){let t,{vk:n,db:r,_:a}=h,{dbName:i,whereJson:o,foreignDB:s,foreignKey:l,groupJson:c,lastWhereJson:d,db:u}=e,f=u||r;if(n.pubfn.isNotNull(s)||n.pubfn.isNotNull(c)){let e=f.collection(i).aggregate();return n.pubfn.isNotNull(o)&&e.match(o),n.pubfn.isNotNull(c)&&e.group(c),n.pubfn.isNotNull(s)&&(e=y.addForeignDB({foreignDB:s,foreignKey:l,result:e})),n.pubfn.isNotNull(d)&&(e=e.match(d)),e=await e.count("total").end(),e.data[0]?e.data[0].total:0}return t=n.pubfn.isNotNull(o)?await f.collection(i).where(o).count():await f.collection(i).count(),t.total},getSelectData:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,whereJson:i,pageIndex:o=1,pageSize:s=10,getCount:l=!1,db:c}=e;s<0&&(o=1,s=999999999,l=!0);let d=c||n,u=e.sortArr,f=e.fieldJson,p=0,g=!1;if(l){let e;e=t.pubfn.isNotNull(i)?await d.collection(a).where(i).count():await d.collection(a).count(),p=e.total,o<Math.ceil(p/s)&&(g=!0)}let m=d.collection(a);if(t.pubfn.isNotNull(i)&&(m=m.where(i)),t.pubfn.isNotNull(u))for(let e in u){let t=u[e],n=t.name,r=t.type;null!=r&&""!=r||(r="asc"),m=m.orderBy(n,r)}return{result:m,dbName:a,whereJson:i,pageIndex:o,pageSize:s,getCount:l,sortArr:u,fieldJson:f,total:p,hasMore:g}},selectAll:async function(e){let{db:t,_:n,vk:r,config:a}=h,{dbName:i,getOne:o=!1,getMain:s=!1}=e,l=500;r.pubfn.getData(a,"vk.db.unicloud.maxLimit")&&(l=r.pubfn.getData(a,"vk.db.unicloud.maxLimit"),l<=0&&(l=500),l>1e3&&(l=1e3));let c=await y.getSelectData(e),{result:d,hasMore:u,total:f,getCount:p,pageIndex:g,pageSize:m,fieldJson:b}=c;m>0&&!f&&!p&&(f=m),r.pubfn.isNotNull(b)&&(d=d.field(b));let w={};if(p&&0===f)w={data:[]};else{let t=f;m<f&&(t=m);let n=Math.ceil(t/l),r=[],a=(g-1)*m,i=a+m;for(let e=0;e<n;e++){let t=a+e*l,n=l;t+l>i&&(n=i-t);let o=d.skip(t).limit(n).get();r.push(o)}try{w=(await Promise.all(r)).reduce((e,t)=>({data:e.data.concat(t.data),errMsg:e.errMsg}))}catch(t){throw console.error("vk.baseDao.select-异常",e,t),new Error("msg:vk.baseDao.select-异常")}}let _={};return _.total=p?f:w.data?w.data.length:0,_.hasMore=u,_.rows=w.data,_.code=0,_.msg="查询成功",_.pagination={pageIndex:g,pageSize:m},o&&(_.rows=_.rows[0]),s?_.rows:_},sum:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,fieldName:i,whereJson:o,db:s}=e,l=s||n;const c=l.command.aggregate;let d=l.collection(a).aggregate();t.pubfn.isNotNull(o)&&d.match(o),d.group({_id:null,num:c.sum("$"+i)});let u=await d.end();return u.data&&u.data[0]?u.data[0].num:0},avg:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,fieldName:i,whereJson:o,db:s}=e,l=s||n;const c=l.command.aggregate;let d=l.collection(a).aggregate();t.pubfn.isNotNull(o)&&d.match(o),d.group({_id:null,num:c.avg("$"+i)});let u=await d.end();return u.data&&u.data[0]?u.data[0].num:null},max:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,fieldName:i,whereJson:o,db:s}=e,l=s||n;const c=l.command.aggregate;let d=l.collection(a).aggregate();t.pubfn.isNotNull(o)&&d.match(o),d.group({_id:null,num:c.max("$"+i)});let u=await d.end();return u.data&&u.data[0]?u.data[0].num:null},min:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,fieldName:i,whereJson:o,db:s}=e,l=s||n;const c=l.command.aggregate;let d=l.collection(a).aggregate();t.pubfn.isNotNull(o)&&d.match(o),d.group({_id:null,num:c.min("$"+i)});let u=await d.end();return u.data&&u.data[0]?u.data[0].num:null},sample:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,whereJson:i,size:o,fieldJson:s,db:l}=e,c=l||n;c.command.aggregate;let d=c.collection(a).aggregate();return t.pubfn.isNotNull(i)&&d.match(i),d.sample({size:o}),t.pubfn.isNotNull(s)&&d.project(s),(await d.end()).data},selects:async function(e){let{vk:t,db:n,_:r}=h;if(t.pubfn.isNotNull(e.treeProps))return await y.tree(e);let{db:a,dbName:i,foreignKey:o="_id",whereJson:s={},pageIndex:l=1,pageSize:c=10,getCount:d=!1,getOne:u=!1,getMain:f=!1,sortArr:p=[],fieldJson:g={},groupJson:m,foreignDB:b=[],lastWhereJson:w,addFields:_}=e,k=a||n;-1==c&&(l=1,c=999999999,d=!1),u&&(c=1,d=!1);let N=0,v=!1;if(d){if(t.pubfn.isNotNull(w)){let e=k.collection(i).aggregate();t.pubfn.isNotNull(s)&&e.match(s),t.pubfn.isNotNull(m)&&e.group(m),t.pubfn.isNotNull(b)&&(e=y.addForeignDB({foreignDB:b,foreignKey:o,result:e})),e=e.match(w),e=await e.count("total").end(),N=e.data[0]?e.data[0].total:0}else if(t.pubfn.isNotNull(m)){let e;e=t.pubfn.isNotNull(s)?await k.collection(i).aggregate().match(s).group(m).count("total").end():await k.collection(i).aggregate().group(m).count("total").end(),N=e.data[0]?e.data[0].total:0}else{let e;e=t.pubfn.isNotNull(s)?await k.collection(i).where(s).count():await k.collection(i).count(),N=e.total}l<Math.ceil(N/c)&&(v=!0)}let x={};r.aggregate;let D=k.collection(i).aggregate();if(t.pubfn.isNotNull(s)){let e;for(let n in s)s[n]&&"object"==typeof s[n]&&"geoNear"===s[n].operator&&(e=t.pubfn.copyObject(s[n]),e.keyName=n,e.limit=l*c,delete s[n]);D=t.pubfn.isNotNull(e)?D.geoNear({near:new k.Geo.Point(e.$geoNear.geometry.coordinates[0],e.$geoNear.geometry.coordinates[1]),spherical:!0,maxDistance:e.$geoNear.maxDistance,minDistance:e.$geoNear.minDistance,query:s,distanceMultiplier:e.$geoNear.distanceMultiplier,distanceField:e.$geoNear.distanceField||"distance",includeLocs:e.keyName,key:e.keyName}):D.match(s)}if(t.pubfn.isNotNull(m)&&(D=D.group(m)),t.pubfn.isNotNull(p)){let e={};for(let t in p){let n=p[t],r=n.name,a=n.type;a=null==a||""==a||"asc"==a?1:-1,e[r]=a}D=D.sort(e)}t.pubfn.isNull(w)&&(D=D.skip((l-1)*c).limit(c)),D=y.addForeignDB({foreignDB:b,foreignKey:o,result:D}),t.pubfn.isNotNull(w)&&(D=D.match(w)),t.pubfn.isNotNull(w)&&(D=D.skip((l-1)*c).limit(c)),t.pubfn.isNotNull(g)&&(g=y.foreignDBToProject({fieldJson:g,foreignDB:b,foreignKey:o}),D=D.project(g)),t.pubfn.isNotNull(_)&&(D=D.addFields(_)),D=await D.end();let T=D.data;return T=y.listToObjectByLimit1({list:T,foreignDB:b}),d?(x.total=N,x.hasMore=v):(x.total=T?T.length:0,x.hasMore=N>=c),x.rows=T,x.code=0,x.msg="查询成功",x.pagination={pageIndex:l,pageSize:c},u&&(x.rows=x.rows[0]),f?x.rows:x},listToObjectByLimit1:function(e){let{vk:t,db:n,_:r}=h,{list:a,foreignDB:i}=e;if(t.pubfn.isNotNull(i))for(let e in a)for(let n in i){let{as:r,limit:o,foreignDB:s,dbName:l}=i[n];r||(r=l),t.pubfn.isNotNull(s)&&(a[e][r]=y.listToObjectByLimit1({list:a[e][r],foreignDB:s})),1===o&&(a[e][r]&&a[e][r].length>0?a[e][r]=a[e][r][0]:a[e][r]={})}return a},addForeignDB:function(e){let{vk:t,db:n,_:r}=h,{foreignDB:a,foreignKey:i,result:o}=e;const s=r.aggregate;for(let e in a){let n,l,{dbName:c,foreignKey:d,localKey:u,localKeyType:f="",foreignKeyType:p="",as:g,limit:m,whereJson:b,fieldJson:h,sortArr:w,foreignDB:_,addFields:k}=a[e];g||(g=c),n=t.pubfn.isNotNull(u)?u:"object"==typeof i?i[e]:i,l="array"===f.toLowerCase()?[s.cond({if:s.isArray("$$foreignKey"+y.getForeignKeyName(n)),then:s.in(["$"+d,"$$foreignKey"+y.getForeignKeyName(n)]),else:s.eq(["$"+d,"$$foreignKey"+y.getForeignKeyName(n)])})]:"array"===p.toLowerCase()?[s.cond({if:s.isArray("$"+d),then:s.in(["$$foreignKey"+y.getForeignKeyName(n),"$"+d]),else:s.eq(["$"+d,"$$foreignKey"+y.getForeignKeyName(n)])})]:[s.eq(["$"+d,"$$foreignKey"+y.getForeignKeyName(n)])];let N=s.pipeline().match(r.expr(s.and(l)));if(t.pubfn.isNotNull(b)&&(N=N.match(b)),t.pubfn.isNotNull(w)){let e={};for(let t in w){let n=w[t],r=n.name,a=n.type;a=null==a||""==a||"asc"==a?1:-1,e[r]=a}N=N.sort(e)}m&&(N=N.limit(m)),t.pubfn.isNotNull(_)&&(N=y.addForeignDB({foreignDB:_,result:N})),t.pubfn.isNotNull(h)&&(h=y.foreignDBToProject({fieldJson:h,foreignDB:_}),N=N.project(h)),t.pubfn.isNotNull(k)&&(N=N.addFields(k)),N=N.done();let v={};v["foreignKey"+y.getForeignKeyName(n)]="$"+n;let x={from:c,let:v,pipeline:N,as:g};o=o.lookup(x)}return o},getForeignKeyName:function(e){return e.replace(new RegExp("\\.","g"),"__")},addWhereJson:function(e,t={},n="whereJson"){let{vk:r,db:a,_:i}=h,{formData:o,columns:s}=e;for(let e in s){let a,l=s[e],{key:c,mode:d,defaultValue:u,type:f="",lastWhereJson:p,auxiliary:g=!0,trim:m=!0,isNumber:b=!1}=l;if("lastWhereJson"===n&&!p)continue;if("lastWhereJson"!==n&&p)continue;let h=c;if(r.pubfn.isNotNull(l.fieldName)&&(h=l.fieldName),a=r.pubfn.isNotNull(l.value)?l.value:o[c],r.pubfn.isNull(a)&&r.pubfn.isNotNull(u)&&(a=u),r.pubfn.isNull(d)&&(d=["address","province","city","area"].indexOf(f)>-1?"address":"[object Array]"===Object.prototype.toString.call(a)&&a.length>=2?"[]":"="),r.pubfn.isNotNull(a))if("string"==typeof a&&m&&"function"==typeof a.trim&&(a=a.trim()),b&&!isNaN(a)&&(a=Number(a)),"custom"===d);else if("%%"===d)try{t[h]=new RegExp(a)}catch(e){}else if("%*"===d)try{t[h]=new RegExp("^"+a)}catch(e){}else if("*%"===d)try{t[h]=new RegExp(a+"$")}catch(e){}else if(">"===d)t[h]=t[h]?t[h].gt(a):i.gt(a);else if(">="===d)t[h]=t[h]?t[h].gte(a):i.gte(a);else if("<"===d)t[h]=t[h]?t[h].lt(a):i.lt(a);else if("<="===d)t[h]=t[h]?t[h].lte(a):i.lte(a);else if("in"===d)t[h]=i.in(a);else if("nin"===d)t[h]=i.nin(a);else if("!="===d)t[h]=i.neq(a);else if("[]"===d)t[h]=i.gte(a[0]).lte(a[1]);else if("[)"===d)t[h]=i.gte(a[0]).lt(a[1]);else if("(]"===d)t[h]=i.gt(a[0]).lte(a[1]);else if("()"===d)t[h]=i.gt(a[0]).lt(a[1]);else if("address"===d){let e={};a.province&&a.province.code&&(e["province.code"]=a.province.code),a.city&&a.city.code&&(e["city.code"]=a.city.code),a.area&&a.area.code&&(e["area.code"]=a.area.code),t[h]=e}else t[h]=g?"___empty-array___"===a?[]:"___empty-object___"===a?{}:"___non-existent___"===a?i.exists(!1):"___existent___"===a?i.exists(!0):a:a}return t},addLastWhereJson:function(e,t={}){return y.addWhereJson(e,t,"lastWhereJson")},getTableData:async function(e){let{vk:t,db:n,_:r,config:a}=h,{db:i,dbName:o,data:s,getCount:l=!0,whereJson:c,fieldJson:d,sortArr:u,treeProps:f,groupJson:p,foreignKey:g,foreignDB:m,lastWhereJson:b}=e,{pageIndex:w,pageSize:_,pagination:k,sortRule:N,formData:v,columns:x}=s;k&&(w=k.pageIndex,_=k.pageSize);let D={},T={},O=[],S={};if(t.pubfn.isNotNull(u))O=u;else{let e=t.pubfn.getData(a,"vk.db.unicloud.getTableData.sortArr");t.pubfn.isNotNull(e)?O=e:O.push({name:"_id",type:"desc"})}return t.pubfn.isNotNull(N)&&(O=N),T=y.addWhereJson(s),S=y.addLastWhereJson(s),t.pubfn.isNotNull(c)&&(c.operator&&c.operands&&["or","and"].indexOf(c.operator)>-1?T=r.and([T,c]):t.pubfn.objectAssign(T,c)),t.pubfn.isNotNull(d)&&t.pubfn.objectAssign(D,d),t.pubfn.isNotNull(b)&&t.pubfn.objectAssign(S,b),t.pubfn.isNullAll(m,p,f)?await t.baseDao.select({db:i,dbName:o,getCount:l,pageIndex:w,pageSize:_,fieldJson:D,whereJson:T,sortArr:O}):await t.baseDao.selects({db:i,dbName:o,foreignKey:g,getCount:l,pageIndex:w,pageSize:_,whereJson:T,fieldJson:D,sortArr:O,treeProps:f,groupJson:p,foreignDB:m,lastWhereJson:S})},startTransaction:async function(e){let{vk:t,db:n,_:r}=h;return await n.startTransaction()},rollbackTransaction:async function(e){let{db:t,msg:n="【异常】操作失败",tips:r="事务已回滚。",err:a={}}=e;console.error("transaction error",a);let i={code:-1,msg:n,tips:r};await t.rollback();let o={message:a.message,stack:a.stack};try{o.body=JSON.parse(a.message),"object"==typeof o.body&&void 0!==o.body.code&&(o.body.msg,1)&&(i.msg=o.body.msg)}catch(e){}return console.error("transaction errJson",o),i.err=o,i},group:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,whereJson:i,groupJson:o,sortArr:s,pageIndex:l=1,pageSize:c=10,getCount:d=!1,lookupJson:u,db:f}=e,p=f||n;c<=0&&(c=999999999);r.aggregate;let g,m=p.collection(a).aggregate();if(t.pubfn.isNotNull(i)&&(m=m.match(i)),t.pubfn.isNotNull(o)&&(m=m.group(o)),t.pubfn.isNotNull(s)){let e={};for(let t in s){let n=s[t],r=n.name,a=n.type;a=null==a||""==a||"asc"==a?1:-1,e[r]=a}m=m.sort(e)}m=m.skip((l-1)*c).limit(c),t.pubfn.isNotNull(u)&&(g=u.returnObject,delete u.returnObject,m=m.lookup(u)),m=await m.end();let b,y=m.data;if(g)for(let e in y)y[e][u.as]=y[e][u.as][0];let w=!1;if(d){let e=p.collection(a).aggregate();t.pubfn.isNotNull(i)&&(e=e.match(i)),t.pubfn.isNotNull(o)&&(e=e.group(o));let n=await e.count("total").end();b=n.data[0]?n.data[0].total:0,l<Math.ceil(b/c)&&(w=!0)}else b=y?y.length:0,w=b>=c;return{hasMore:w,total:b,rows:y,code:0,key:1,pageIndex:l,pageSize:c}},tree:async function(e){let{vk:t,db:n,_:r}=h,{dbName:a,whereJson:i={},pageIndex:o=1,pageSize:s=10,getCount:l=!1,sortArr:c=[],fieldJson:d={},lastWhereJson:u,treeProps:f={}}=e;e.foreignDB||(e.foreignDB=[]);let{id:p="_id",parent_id:g="parent_id",children:m="children",level:b=10,limit:w=500}=f;if(b<1||b>20)throw new Error("msg:treeProps.level的范围必须在[1,20]");delete e.treeProps,e.whereJson||(e.whereJson={[g]:null}),e.foreignDB.unshift({dbName:a,localKey:p,foreignKey:g,as:m,limit:w,whereJson:f.whereJson,fieldJson:f.fieldJson||e.fieldJson,sortArr:f.sortArr,foreignDB:t.pubfn.copyObject(e.foreignDB)});let _=t.pubfn.copyObject(e.foreignDB);for(let n=1;n<b;n++){let r="";for(let e=0;e<n;e++)r+="[0].foreignDB";t.pubfn.setData(_,r,e.foreignDB)}return e.foreignDB=_,await y.selects(e)},foreignDBToProject:function(e){let{fieldJson:t,foreignDB:n,foreignKey:r}=e,a=!0;for(let e in t)"_id"==e||t[e]||(a=!1);if(a)for(let e in n){let{as:r,dbName:a}=n[e];r?t[r]=!0:t[a]=!0}return t}},w=y,_=async(e={})=>{"[object object]"===Object.prototype.toString.call(e.content)&&(e.content=JSON.stringify(e.content)),void 0===e.dataType&&(e.dataType="json"),"default"!=e.dataType&&""!==e.dataType||delete e.dataType,e.useContent&&(e.content=JSON.stringify(e.data)),e.method||(e.method="POST"),void 0===e.headers&&void 0!==e.header&&(e.headers=e.header);let t=await uniCloud.httpclient.request(e.url,e);return!e.needOriginalRes&&t&&t.data?t.data:t},k={formValidateItem:function(e,t,n){let r={code:0,msg:"ok"};for(let a in n){let i=n[a];if(void 0===e[t]&&i.required){r={type:"undefined",code:-1,msg:"字段："+t+" 名称错误，请检查！",key:t,value:e[t]};break}if(i.required&&(null==e[t]||null==e[t]||""===e[t]||0==e[t].length)){r={type:"required",code:-1,msg:i.message,key:t,value:e[t]};break}if(i.type&&void 0!==e[t]){if(Object.prototype.toString.call(e[t]).toLowerCase().toLowerCase()!==`[object ${i.type}]`.toLowerCase()){r={type:"type",code:-1,msg:i.message,key:t,value:e[t]};break}}if(i.len&&e[t].length!=i.len){r={type:"len",code:-1,msg:i.message,key:t,value:e[t]};break}if(i.min)if(i.type&&"number"==i.type){if(e[t]<i.min){r={type:"min",code:-1,msg:i.message,key:t,value:e[t]};break}}else if(e[t].length<i.min){r={type:"min",code:-1,msg:i.message,key:t,value:e[t]};break}if(i.max&&void 0!==e[t])if(i.type&&"number"==i.type){if(e[t]>i.max){r={type:"max",code:-1,msg:i.message,key:t,value:e[t]};break}}else if(e[t].length>i.max){r={type:"max",code:-1,msg:i.message,key:t,value:e[t]};break}if("function"==typeof i.validator){let n=i.validator(i,e[t],(function(e){return e}));if(void 0!==n&&!0!==n){r={type:"validator",code:-1,msg:i.message,key:t,value:e[t]};break}}}return r}};function N(e){return JSON.parse(JSON.stringify(e))}var v={};function x(e){let t=[];for(let n=0;n<e.length;n++)-1==t.indexOf(e[n])&&t.push(e[n]);return t}v.treeToArray=function(e,t){let n=N(e);return v.treeToArrayFn(n,t)},v.treeToArrayFn=function(e,t={},n=[],r){let{id:a="_id",parent_id:i="parent_id",children:o="children",deleteChildren:s=!0}=t;for(let l in e){let c=e[l];r&&(c[i]=r),n.push(c),c[o]&&c[o].length>0&&(n=v.treeToArrayFn(c[o],t,n,c[a])),s&&delete c[o]}return n},v.arrayToTree=function(e,t){let n=N(e),{id:r="_id",parent_id:a="parent_id",children:i="children",deleteParentId:o=!1,need_field:s}=t,l=[],c={};for(let e=0;e<n.length;e++)c[n[e][r]]=n[e];for(let e=0;e<n.length;e++){let t=n[e];if(s){s=x(s.concat([r,a,i]));for(let e in t)-1===s.indexOf(e)&&delete t[e]}let d=c[t[a]];d?(d[i]||(d[i]=[]),o&&delete t[a],d[i].push(t)):l.push(t)}return l};var D=v,T={getTargetTimezone:function(e){if("number"==typeof e)return e;let t=8;try{let e=uniCloud.vk;const{config:n}=e.getUnicloud();t=e.pubfn.getData(n.vk,"system.targetTimezone",8)}catch(e){}return t},timeFormat:function(e,t="yyyy-MM-dd hh:mm:ss",n){try{if(n=T.getTargetTimezone(n),!e)return"";let r;"string"!=typeof e||isNaN(e)||(e=Number(e)),"number"==typeof e?(10==e.toString().length&&(e*=1e3),r=new Date(e)):r=e;const a=60*r.getTimezoneOffset()*1e3+60*n*60*1e3,i=r.getTime()+a;r=new Date(i);let o={"M+":r.getMonth()+1,"d+":r.getDate(),"h+":r.getHours(),"m+":r.getMinutes(),"s+":r.getSeconds(),"q+":Math.floor((r.getMonth()+3)/3),S:r.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(r.getFullYear()+"").substr(4-RegExp.$1.length)));for(let e in o)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?o[e]:("00"+o[e]).substr((""+o[e]).length)));return t}catch(t){return e}},getFullTime:function(e,t=0,n){if(n=T.getTargetTimezone(n),!e)return"";"string"!=typeof e||isNaN(e)||(e=Number(e)),"number"==typeof e&&(10==e.toString().length&&(e*=1e3),e=new Date(e));const r=60*e.getTimezoneOffset()*1e3+60*n*60*1e3,a=e.getTime()+r;let i=(e=new Date(a)).getFullYear()+"",o=e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1,s=e.getDate()<10?"0"+e.getDate():e.getDate(),l=e.getHours()<10?"0"+e.getHours():e.getHours(),c=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),d=e.getSeconds()<10?"0"+e.getSeconds():e.getSeconds();return 2===t?{YYYY:Number(i),MM:Number(o),DD:Number(s),hh:Number(l),mm:Number(c),ss:Number(d),year:Number(i),month:Number(o),day:Number(s),hour:Number(l),minute:Number(c),second:Number(d)}:1===t?i+""+o+s+l+c+d:i+"-"+o+"-"+s+" "+l+":"+c+":"+d},getWeekStartAndEnd:function(e=0,t=new Date,n){n=T.getTargetTimezone(n);let r={};const a=60*t.getTimezoneOffset()*1e3+60*n*60*1e3,i=t.getTime()+a,o=new Date(i);let s=o.getDay();o.getDate();t=new Date(t.getTime()+6048e5*e);let l=0!=s?s-1:6,c=new Date(t.getTime()-864e5*l),d=new Date(c.getTime()+5184e5),u=T.getFullTime(c,2),f=T.getFullTime(d,2);return r.weekStart=new Date(`${u.year}/${u.month}/${u.day}`).getTime()-a,r.weekEnd=new Date(`${f.year}/${f.month}/${f.day}`).getTime()+86399999-a,r},getCommonTime:function(e=new Date,t){t=T.getTargetTimezone(t);let n={};const r=60*e.getTimezoneOffset()*1e3+60*t*60*1e3,{year:a,month:i,day:o,hour:s,minute:l,second:c}=T.getFullTime(e,2);n.now={year:a,month:i,day:o,hour:s,minute:l,second:c};let d=new Date(a,i,0).getDate(),u=new Date(a,12,0).getDate();n.todayStart=new Date(`${a}/${i}/${o}`).getTime()-r,n.today12End=new Date(`${a}/${i}/${o}`).getTime()+43199999-r,n.todayEnd=new Date(`${a}/${i}/${o}`).getTime()+86399999-r,n.monthStart=new Date(`${a}/${i}/1`).getTime()-r,n.monthEnd=new Date(`${a}/${i}/${d}`).getTime()+86399999-r,n.yearStart=new Date(a+"/1/1").getTime()-r,n.yearEnd=new Date(`${a}/12/${u}`).getTime()+86399999-r;let f=a,p=i-1;0===p&&(p=12,f=a-1);let g=new Date(f,p,0).getDate();n.lastMonthStart=new Date(`${f}/${p}/1`).getTime()-r,n.lastMonthEnd=new Date(`${f}/${p}/${g}`).getTime()+86399999-r;let m=T.getWeekStartAndEnd(0,e);n.weekStart=m.weekStart,n.weekEnd=m.weekEnd,n.months=[],n.months[0]={monthStart:n.monthStart,monthEnd:n.monthEnd};for(let e=1;e<=12;e++){let t=new Date(a,e,0).getDate(),i=new Date(`${a}/${e}/1`).getTime()-r,o=new Date(`${a}/${e}/${t}`).getTime()+86399999-r;n.months[e]={monthStart:i,monthEnd:o}}return n},getMonthStartAndEnd:function(e,t){t=T.getTargetTimezone(t);let n={startTime:null,endTime:null},{year:r,month:a}=e;if(r>0&&a>0){const e=60*(new Date).getTimezoneOffset()*1e3+60*t*60*1e3;let i=new Date(r,a,0).getDate();n.startTime=new Date(`${r}/${a}/1`).getTime()-e,n.endTime=new Date(`${r}/${a}/${i}`).getTime()+86399999-e}return n},getDayOffsetStartAndEnd:function(e=0,t,n){n=T.getTargetTimezone(n);let r,a={};"string"!=typeof t||isNaN(t)||(t=Number(t)),t?"number"==typeof t?(10==t.toString().length&&(t*=1e3),r=new Date(t)):r=t:r=new Date;const i=60*r.getTimezoneOffset()*1e3+60*n*60*1e3;r=new Date(r.getTime()+864e5*e);let o=T.getFullTime(r,2);return a.startTime=new Date(`${o.year}/${o.month}/${o.day}`).getTime()-i,a.endTime=new Date(`${o.year}/${o.month}/${o.day}`).getTime()+86399999-i,a},getMonthOffsetStartAndEnd:function(e=0,t,n){n=T.getTargetTimezone(n);let r,a={};"string"!=typeof t||isNaN(t)||(t=Number(t)),t?"number"==typeof t?(10==t.toString().length&&(t*=1e3),r=new Date(t)):r=t:r=new Date;const i=60*r.getTimezoneOffset()*1e3+60*n*60*1e3;let o=T.getFullTime(r,2),s=o.month+e,l=o.year;s>12?(l+=Math.floor(s/12),s=Math.abs(s)%12):s<=0&&(l=l-1-Math.floor(Math.abs(s)/12),s=12-Math.abs(s)%12);let c=new Date(l,s,0).getDate();return a.startTime=new Date(`${l}/${s}/1`).getTime()-i,a.endTime=new Date(`${l}/${s}/${c}`).getTime()+86399999-i,a},getYearOffsetStartAndEnd:function(e=0,t,n){n=T.getTargetTimezone(n);let r,a={};"string"!=typeof t||isNaN(t)||(t=Number(t)),t?"number"==typeof t?(10==t.toString().length&&(t*=1e3),r=new Date(t)):r=t:r=new Date;const i=60*r.getTimezoneOffset()*1e3+60*n*60*1e3;let o=T.getFullTime(r,2).year+e;return a.startTime=new Date(o+"/1/1").getTime()-i,a.endTime=new Date(o+"/12/31").getTime()+86399999-i,a},isLeapYear:function(e){if(void 0===e){let{now:t}=T.getCommonTime();e=t.year}else if("object"==typeof e){let{now:t}=T.getCommonTime(e);e=t.year}return e%4==0&&e%100!=0||e%400==0},isQingming:function(e=new Date){let{now:t}=T.getCommonTime(e),{year:n,month:r,day:a}=t,i=!1;return T.isLeapYear(n)||T.isLeapYear(n-1)?4===r&&4===a&&(i=!0):4===r&&5===a&&(i=!0),i},getOffsetTime:function(e=new Date,t){let n="number"==typeof e?new Date(e):e,r=t.year||t.y,a=t.month||t.m,i=t.day||t.d,o=t.hours||t.hh,s=t.minutes||t.mm,l=t.seconds||t.ss,{mode:c="after"}=t;return"before"==c&&(r*=-1,a*=-1,i*=-1,o*=-1,s*=-1,l*=-1),r&&(n=n.setFullYear(n.getFullYear()+r),n=new Date(n)),a&&(n=n.setMonth(n.getMonth()+a),n=new Date(n)),i&&(n=n.setDate(n.getDate()+i),n=new Date(n)),o&&(n=n.setHours(n.getHours()+o),n=new Date(n)),s&&(n=n.setMinutes(n.getMinutes()+s),n=new Date(n)),l&&(n=n.setSeconds(n.getSeconds()+l),n=new Date(n)),n.getTime()}},O=T,S={formValidate:function(e={}){let t={code:0,msg:"ok"},{data:n,rules:r}=e;if(r)for(let e in r){let a=r[e];if(t=k.formValidateItem(n,e,a),0!=t.code)break}return t}};S.treeUtil=D,S.timeUtil=O,S.sleep=e=>new Promise(t=>setTimeout(t,e)),S.timeFormat=S.timeUtil.timeFormat,S.getFullTime=S.timeUtil.getFullTime,S.getCommonTime=S.timeUtil.getCommonTime,S.getOffsetTime=S.timeUtil.getOffsetTime,S.getWeekStartAndEnd=S.timeUtil.getWeekStartAndEnd,S.getDayOffsetStartAndEnd=S.timeUtil.getDayOffsetStartAndEnd,S.getMonthOffsetStartAndEnd=S.timeUtil.getMonthOffsetStartAndEnd,S.getYearOffsetStartAndEnd=S.timeUtil.getYearOffsetStartAndEnd,S.getMonthStartAndEnd=S.timeUtil.getMonthStartAndEnd,S.validator=function(e){return function(t,n,r){let a=S.test(n,e);return"function"!=typeof r||!a&&n?r(!1):void r()}},S.test=function(e,t){switch(t){case"mobile":return new RegExp(/^1[3|4|5|6|7|8|9][0-9]{9}$/).test(e);case"tel":return new RegExp(/^(0\d{2,3}-\d{7,8})(-\d{1,4})?$/).test(e);case"card":return new RegExp(/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/).test(e);case"mobileCode":return new RegExp(/^[0-9]{6}$/).test(e);case"username":return new RegExp(/^[a-zA-Z]([-_a-zA-Z0-9]{5,17})$/).test(e);case"pwd":case"password":return new RegExp(/^([a-zA-Z0-9_@]){6,18}$/).test(e);case"payPwd":return new RegExp(/^[0-9]{6}$/).test(e);case"postal":return new RegExp(/[1-9]\d{5}(?!\d)/).test(e);case"QQ":return new RegExp(/^[1-9][0-9]{4,9}$/).test(e);case"email":return new RegExp(/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/).test(e);case"money":return new RegExp(/^\d*(?:\.\d{0,2})?$/).test(e);case"URL":return new RegExp(/(http|ftp|https):\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?/).test(e);case"IP":return new RegExp(/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/).test(e);case"date":return new RegExp(/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])$/).test(e);case"time":return new RegExp(/^(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/).test(e);case"dateTime":return new RegExp(/^[1-9]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])\s+(20|21|22|23|[0-1]\d):[0-5]\d:[0-5]\d$/).test(e);case"english+number":return new RegExp(/^[a-zA-Z0-9]*$/).test(e);case"english+number+_":return new RegExp(/^[a-zA-Z0-9_]*$/).test(e);case"english+number+_-":return new RegExp(/^[a-zA-Z0-9_-]*$/).test(e);case"number":return new RegExp(/^[0-9]*$/).test(e);case"english":return new RegExp(/^[a-zA-Z]+$/).test(e);case"chinese":return new RegExp(/^[\u4e00-\u9fa5]+$/gi).test(e);case"lower":return new RegExp(/^[a-z]+$/).test(e);case"upper":return new RegExp(/^[A-Z]+$/).test(e);case"HTML":return new RegExp(/<("[^"]*"|'[^']*'|[^'">])*>/).test(e);default:return!0}},S.checkStr=S.test,S.priceFilter=function(e,t=""){return S.isNull(e)?t:isNaN(e)?e:("string"==typeof e&&(e=parseFloat(e)),(e/100).toFixed(2))},S.priceLeftFilter=function(e){let t="";return e&&(t=S.priceFilter(e).split(".")[0]),t},S.priceRightFilter=function(e){let t="";return e&&(t=S.priceFilter(e).split(".")[1]),t},S.percentageFilter=function(e,t=!0,n=""){return S.isNull(e)?n:(isNaN(e)||("string"==typeof e&&(e=parseFloat(e)),e=parseFloat((100*e).toFixed(2)),t&&(e+="%")),e)},S.discountFilter=function(e,t=!0,n=""){return S.isNull(e)?n:isNaN(e)?e:("string"==typeof e&&(e=parseFloat(e)),(e=parseFloat((10*e).toFixed(2)))>10?"折扣不可以大于原价":10==e?"原价":0==e?"免费":e<0?"折扣不可以小于0":(t&&(e+=" 折"),e))},S.objectAssign=function(e,t){return Object.assign(e,t)},S.copyObject=function(e){return void 0!==e?JSON.parse(JSON.stringify(e)):e},S.deepClone=function(e){if([null,void 0,NaN,!1].includes(e))return e;if("object"!=typeof e&&"function"!=typeof e)return e;let t="[object Array]"===Object.prototype.toString.call(e)?[]:{};for(let n in e)e.hasOwnProperty(n)&&(t[n]="object"==typeof e[n]?S.deepClone(e[n]):e[n]);return t},S.formAssign=function(e,t){let n=S.copyObject(e);return S.objectAssign(n,t)},S.arr_concat=function(e,t,n){n||(n="id");var r=e.concat(t),a=[];if(-1!=n){var i=[];for(var o in r)-1==i.indexOf(r[o][n])&&(i.push(r[o][n]),a.push(r[o]))}else a=r;return a},S.getData=function(e,t,n){let r=JSON.parse(JSON.stringify(e));t=t.replace(/\s+/g,"")+".";let a="";for(let e=0;e<t.length;e++){let n=t.charAt(e);"."!=n&&"["!=n&&"]"!=n?a+=n:r&&(""!=a&&(r=r[a]),a="")}return void 0===r&&void 0!==n&&(r=n),r},S.setData=function(e,t,n){let r;r="object"==typeof n?S.copyObject(n):n;let a=new RegExp("([\\w$]+)|\\[(:\\d)\\]","g");const i=t.match(a);for(let t=0;t<i.length-1;t++){let n=i[t];"object"!=typeof e[n]&&(e[n]={}),e=e[n]}e[i[i.length-1]]=r},S.isNull=function(e){let t=!1;return void 0!==e&&"[object Null]"!=Object.prototype.toString.call(e)&&""!==e&&"{}"!=JSON.stringify(e)&&"[]"!=JSON.stringify(e)&&void 0!==JSON.stringify(e)||(t=!0),t},S.isNotNull=function(e){return!S.isNull(e)},S.isNullOne=function(...e){let t=!1;for(let n=0;n<e.length;n++){let r=e[n];if(S.isNull(r)){t=!0;break}}return t},S.isNullOneByObject=function(e){let t;for(let n in e){let r=e[n];if(S.isNull(r)){t=n;break}}return t},S.isNullAll=function(...e){let t=!0;for(let n=0;n<e.length;n++){let r=e[n];if(S.isNotNull(r)){t=!1;break}}return t},S.isNotNullAll=function(...e){return!S.isNullOne(...e)},S.getListItem=function(e,t,n){let r;for(let a=0;a<e.length;a++)if(e[a][t]===n){r=e[a];break}return r},S.getListIndex=function(e,t,n){let r=-1;for(let a=0;a<e.length;a++)if(e[a][t]===n){r=a;break}return r},S.getListItemIndex=function(e,t,n){let r,a={},i=-1;for(let a=0;a<e.length;a++)if(e[a][t]===n){i=a,r=e[a];break}return a={item:r,index:i},a},S.arrayToJson=function(e,t){let n={};for(let r in e){let a=e[r];n[a[t]]=a}return n},S.listToJson=S.arrayToJson,S.arrayObjectGetArray=function(e,t){return e.map(e=>e[t])},S.random=function(e,t,n){let r;if(S.isNull(n))r=S.randomFn(e,t);else{let a=0,i=1e5;do{a++,r=S.randomFn(e,t)}while(n.indexOf(r)>-1&&a<i);a===i&&(r=void 0)}return r},S.randomFn=function(e,t){let n="",r="123456789";S.isNotNull(t)&&("a-z,0-9"==t?t="abcdefghijklmnopqrstuvwxyz0123456789":"A-Z,0-9"==t?t="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789":"a-z,A-Z,0-9"!=t&&"A-Z,a-z,0-9"!=t||(t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"),r=t);for(let t=0;t<e;t++){n+=r[Math.floor(Math.random()*r.length)]}return n},S.stringIdToNumberId=function(e,t){let n="",r=e.split("").reverse().join("");for(let e=0;e<t;e++)if(r.length>e){n+="0123456789"[r[e].charCodeAt()%10]}else n="0"+n;return n},S.hidden=function(e="",t=0,n=0){let r=e.length-t-n,a="";for(let e=0;e<r;e++)a+="*";return e.substring(0,t)+a+e.substring(e.length-n)},S.checkArrayIntersection=function(e=[],t=[]){let n=!1;for(let r=0;r<t.length;r++)e.indexOf(t[r])>-1&&(n=!0);return n},S.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},S.isObject=function(e){return"[object Object]"===Object.prototype.toString.call(e)},S.calcFreights=function(e,t){let{first_weight:n,first_weight_price:r,continuous_weight:a,continuous_weight_price:i,max_weight:o=1e8}=e,s=0,l=0,c=o,d=!1,u=0;for(;t>0;)d?(u++,t-=a,c-=a):(d=!0,l++,c=o,t-=n,c-=n),c<=0&&(d=!1);return s=l*r+i*u,s},S.getNewObject=function(e,t){let n=S.copyObject(e),r={};if(t&&t.length>0)for(let e in t){let a=t[e];S.isNotNull(n[a])&&(r[a]=n[a])}else r=n;return r},S.deleteObjectKeys=function(e,t=[]){var n={};if(e)for(let r in e)-1==t.indexOf(r)&&(n[r]=e[r]);return n},S.arrayToTree=S.treeUtil.arrayToTree,S.treeToArray=S.treeUtil.treeToArray,S.wildcardTestOne=function(e,t){if(!t)return!1;let n=t.replace(new RegExp("\\*"),"(.*)"),r=0!==t.indexOf("*")?"^":"",a="*"!==t[t.length-1]?"$":"";return new RegExp(r+n+a).test(e)},S.wildcardTest=function(e,t){let n=0;if("string"==typeof t)S.wildcardTestOne(e,t)&&n++;else if("object"==typeof t)for(let r=0;r<t.length;r++){let a=t[r];S.wildcardTestOne(e,a)&&n++}return n},S.regExpTestOne=function(e,t){if(!t)return!1;return new RegExp(t).test(e)},S.regExpTest=function(e,t){let n=0;if("string"==typeof t)S.regExpTestOne(e,t)&&n++;else if("object"==typeof t)for(let r=0;r<t.length;r++){let a=t[r];S.regExpTestOne(e,a)&&n++}return n},S.regExpExecToTemplate=function(e,t,n){let r=new RegExp(t).exec(e);if(r){for(let e=1;e<r.length;e++)n=n.replace("$"+e,r[e]);return n}},S.createOrderNo=function(e="",t=25){let n=S.getFullTime(new Date,1);n=n.substring(2);let r=t-(e+n).length;return e+n+S.random(r)},S.dateDiff=function(e,t="前"){if(!e)return"";"string"!=typeof e||isNaN(e)||(e=Number(e)),"number"==typeof e&&(10==e.toString().length&&(e*=1e3),e=new Date(e),e=S.getFullTime(e)),"string"==typeof e&&(e=e=e.replace("T"," "),e=new Date(e.replace(/-/g,"/")));var n=864e5,r=36e5,a=(new Date).getTime()-e.getTime(),i=Math.floor(a/n),o=Math.floor(a%n/r),s=Math.floor(a%n%r/6e4),l=Math.round(a%n%r%6e4/1e3),c="1 秒";return i>0?c=i+"天":o>0?c=o+"小时":s>0?c=s+"分钟":l>0&&(c=l+"秒"),c+=t},S.dateDiff2=function(e,t="1秒"){if(!e)return"";"string"!=typeof e||isNaN(e)||(e=Number(e)),"number"==typeof e&&(10==e.toString().length&&(e*=1e3),e=new Date(e),e=S.getFullTime(e)),"string"==typeof e&&(e=e=e.replace("T"," "),e=new Date(e.replace(/-/g,"/")));var n=new Date,r=864e5,a=36e5,i=e.getTime()-n.getTime(),o=Math.floor(i/r),s=Math.floor(i%r/a),l=Math.floor(i%r%a/6e4),c=Math.round(i%r%a%6e4/1e3),d=t;return o>0?d=o+"天":s>0?d=s+"小时":l>0?d=l+"分钟":c>0&&(d=c+"秒"),d},S.numStr=function(e){"string"==typeof e&&(e=parseFloat(e));var t=e;if(e<1e3)t=e;else if(e<1e4){t=Math.floor(e/100)/10+"千"}else if(e<1e6){t=Math.floor(e/1e3)/10+"万"}else if(e<1e7){t=Math.floor(e/1e6)+"百万"}else if(e<1e8){t=Math.floor(e/1e7)+"千万"}else if(e>=1e8){t=Math.floor(e/1e7)/10+"亿"}return t},S.calcSize=function(e=0,t,n,r=2,a="auto"){let i=0,o="";if((e=parseFloat(e))<n||t.length<=1)o=t[0],i=parseFloat(e.toFixed(r));else for(let s=1;s<t.length;s++){let l=t[s];if(e/=n,"auto"===a){if(e<n){o=l,i=parseFloat(e.toFixed(r));break}}else if(a===l){o=l,i=parseFloat(e.toFixed(r));break}}return{size:i,type:o,title:i+" "+o}};const A=new RegExp("_(\\w)","g"),I=new RegExp("[A-Z]","g");function E(e,t){let n,r;switch(t){case"snake2camel":r=S.snake2camel,n=A;break;case"camel2snake":r=S.camel2snake,n=I}for(const a in e)if(Object.prototype.hasOwnProperty.call(e,a)&&n.test(a)){const n=r(a);e[n]=e[a],delete e[a],"[object Object]"===Object.prototype.toString.call(e[n])?e[n]=E(e[n],t):Array.isArray(e[n])&&(e[n]=e[n].map(e=>E(e,t)))}return e}S.snake2camel=function(e){return e.replace(A,(e,t)=>t?t.toUpperCase():"")},S.camel2snake=function(e){return e.replace(I,e=>"_"+e.toLowerCase())},S.snake2camelJson=function(e){return E(e,"snake2camel")},S.camel2snakeJson=function(e){return E(e,"camel2snake")},S.string2Number=function(e,t={}){switch(Object.prototype.toString.call(e).slice(8,-1).toLowerCase()){case"string":if(e&&!isNaN(e)){let{mobile:n=!0,idCard:r=!0,startFrom0:a=!0,maxLength:i=14}=t;return e.length>i||(n&&S.test(e,"mobile")||r&&S.test(e,"card")||a&&e.length>1&&0===e.indexOf("0")&&1!==e.indexOf("."))?e:Number(e)}return e;case"object":const n=Object.keys(e);for(let t=0;t<n.length;t++){const r=n[t];e[r]=S.string2Number(e[r])}return e;case"array":for(let t=0;t<e.length;t++)e[t]=S.string2Number(e[t]);return e;default:return e}},S.toDecimal=function(e,t=0){return"string"==typeof e&&(e=Number(e)),parseFloat(e.toFixed(t))},S.urlStringToJson=function(e){var t={};if(""!=e&&null!=e&&null!=e)for(var n=e.split("&"),r=0;r<n.length;r++){var a=n[r].split("="),i=a[0],o=a[1];t[i]=o}return t},S.getQueryStringParameters=function(e){let t={};if(e.httpMethod){if(console.log("event.path:",e.path),e.body){let n=e.body;e.isBase64Encoded&&(n=Buffer.from(n,"base64").toString("utf-8")),"string"==typeof n&&(n=JSON.parse(n)),t=n}else if(e.queryStringParameters){let n=e.queryStringParameters;"string"==typeof n.data&&(n.data=JSON.parse(n.data)),t=n}}else t=JSON.parse(JSON.stringify(e));return t.data||(t.data={}),t.url=t.$url||"",t},S.stringToFormData=function(e){e||(e="");for(var t=e.split("Content-Disposition: form-data;"),n={},r=0;r<t.length;r++){var a=t[r];let e='name="';var i=a.indexOf(e)+e.length;if(i>-1){var o=a.indexOf('"',i),s=a.substring(i,o);if(o>i){var l=a.indexOf("---",o),c=a.substring(o+1,l).trim();n[s]=c}}}return n},S.getPlatform=function(e){e||(e=uniCloud.$context);let t=e.PLATFORM;return"h5"===t&&e.CLIENTUA.toLowerCase().indexOf("micromessenger")>-1&&(t="h5-weixin"),t},S.batchRun=async function(e){let{main:t,data:n=[],concurrency:r=100}=e,a=n.length,i=[];if(0==n.length)return{stack:i,total:a};if(1===r){for(let e=0;e<n.length;e++)try{let r=await t(n[e],e);i.push(r)}catch(e){i.push(e)}return{stack:i,total:a}}{let e=Math.ceil(a/r);for(let o=0;o<e;o++){let e=[];for(let i=0;i<r;i++){let s=o*r+i;if(s>=a)break;let l=t(n[s],s);e.push(l)}try{await Promise.all(e).then(e=>{i=i.concat(e)})}catch(e){console.error(e)}}return{stack:i,total:a}}};var $=S,J={},C={};J.get=function(e){let t,n=C[e];if(n){let{value:r,expired:a}=n;J.isExpired(e)?delete C[e]:t=r}return t},J.set=function(e,t,n=0){let r={value:t,expired:n>0?(new Date).getTime()+1e3*n:0};C[e]=r},J.del=function(e){delete C[e]},J.clear=function(e){if(e)for(let t in C)0==t.indexOf(e)&&delete C[t];else C={}},J.isExpired=function(e){let t=!0,n=C[e];return n&&(0==n.expired||n.expired>(new Date).getTime())&&(t=!1),t},J.getAll=function(e){let t={};if(e)for(let n in C)0==n.indexOf(e)&&(t[e]=C[e]);else t=C;for(let e in t)J.isExpired(e)&&(delete t[e],delete C[e]);return t};var P=J,M={},F={},j={};M.init=function(e){j=(F=e).vk.system.globalDataDao},M.get=async function(e,t=0,n,r=!0){return"function"==typeof n?M.autoGet(e,t,n,r):M._get(e)},M.autoGet=async function(e,t=0,n,r=!0){let a,{vk:i}=F;try{a=await M._get(e),i.pubfn.isNull(a)&&"function"==typeof n&&(a=await n(),void 0!==a&&r&&await i.globalDataCache.set(e,a,t))}catch(e){return}return a},M._get=async function(e){let t;try{let n=await j.find(e);if(n){let{value:r,expired_at:a}=n;M.isExpired(n)?await M.del(e):t=r}}catch(e){return}return t},M.set=async function(e,t,n=0){let r;e&&void 0!==e.key&&void 0!==e.value?(r=e.key,t=e.value,n=e.second):r=e;let a={code:0,msg:"ok"};try{if(!r)return{code:-1,msg:"key值不能为空"};let e=n>0?(new Date).getTime()+1e3*n:0;a=await j.set({key:r,value:t,expired_at:e})}catch(e){return console.error(e),{code:-1,msg:"异常"}}return a},M.del=async function(e){await j.del(e)},M.clear=async function(e){if(e)return await j.deleteByWhere({key:new RegExp("^"+e)})},M.list=async function(e){return await j.list(e)},M.count=async function(e){return await j.count(e)},M.isExpired=function(e){let t=!0;return e&&(!e.expired_at||0==e.expired_at||e.expired_at>(new Date).getTime())&&(t=!1),t},M.inc=async function(e,t=1,n=0){let r;e&&void 0!==e.key&&void 0!==e.value?(r=e.key,t=e.value,n=e.second):r=e;let a={code:0,msg:"ok"};try{if(!r)return{code:-1,msg:"key值不能为空"};let e=n>0?(new Date).getTime()+1e3*n:0;a=await j.inc({key:r,value:t,expired_at:e})}catch(e){return{code:-1,msg:"异常",err:e}}return a},M.uniqueAdd=async function(e,t=1,n=5){let{vk:r}=F,a={code:0,msg:"ok"};try{if(!e)return{code:-1,msg:"key值不能为空"};let i=n>0?(new Date).getTime()+1e3*n:0;await r.globalDataCache.deleteExpired(e);a.id=await j.add({key:e,value:t,expired_at:i})}catch(e){return console.error(e),{code:-1,msg:"异常"}}return a},M.deleteExpired=async function(e){await j.deleteExpired(e)};var B=M,q={},R={};function L(e){return e.code=e.errcode,e.msg=e.errmsg,e}q.init=function(e){R=e},q.getConfig=function(){let{vk:e,config:t,crypto:n,uniID:r}=R;const a=t.uni;var i;if(e.pubfn.isArray(a)){let t=uniCloud.env&&uniCloud.env.APPID?uniCloud.env.APPID:uniCloud.$context.APPID;i=e.pubfn.getListItem(a,"dcloudAppid",t),e.pubfn.isNull(i)&&(i=e.pubfn.getListItem(a,"isDefaultConfig",!0))}else i=a;return i},q.decrypt={},q.decrypt.getPhoneNumber=async function(e={}){let{appid:t,encryptedData:n,iv:r,sessionKey:a}=e;e.appId&&(t=e.appId);let i,{vk:o,crypto:s,uniID:l,config:c}=R,d={code:0,msg:"ok"},u=o.pubfn.isNullOneByObject({encryptedData:n,iv:r,sessionKey:a});if(u)return{code:-1,msg:u+"不能为空"};if(t)i=t;else try{const e=q.getConfig();let t=e["mp-weixin"];if(i=t.oauth.weixin.appid,o.pubfn.isNull(i))return console.log("config",e),console.log("mpWeixin",t),{code:-1,msg:"请先配置微信小程序APPID"}}catch(e){return{code:-1,msg:"请先配置微信小程序APPID"}}return d.data=q.decrypt.decryptData({appid:i,encryptedData:n,iv:r,sessionKey:a}),d.phone=d.data.phoneNumber,d.mobile=d.data.phoneNumber,d},q.decrypt.decryptData=function(e={}){let t,{appid:n,encryptedData:r,iv:a,sessionKey:i}=e,{vk:o,crypto:s}=R,l=new Buffer(i,"base64"),c=new Buffer(r,"base64"),d=new Buffer(a,"base64");try{let e=s.createDecipheriv("aes-128-cbc",l,d);e.setAutoPadding(!0),t=e.update(c,"binary","utf8"),t+=e.final("utf8"),t=JSON.parse(t)}catch(e){throw new Error(e)}return t.watermark.appid!==n?{code:-1,msg:"appid不一致"}:t},q.auth={},q.auth.getAppidInfo=function(e={}){let{appid:t,appsecret:n}=e,{vk:r,config:a}=R;const i=q.getConfig();if(t){if(!n){let e=r.pubfn.getData(a,"vk.oauth.weixin.list")||[],i=r.pubfn.getListItem(e,"appid",t)||{};t=i.appid,n=i.appsecret}}else{let e=r.pubfn.getData(i,"mp-weixin.oauth.weixin")||{};t=e.appid,n=e.appsecret}if(r.pubfn.isNullOne(t,n))throw console.log("config",i),new Error("请先配置微信小程序appid和appsecret");return{appid:t,appsecret:n}},q.auth.getAccessTokenFn=async function(e={}){let{appid:t,appsecret:n}=q.auth.getAppidInfo(e),{vk:r,config:a}=R,i=await r.request({url:`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${t}&secret=${n}`,method:"GET"});return i.errcode?(console.error("getAccessToken失败：",i),{code:i.errcode,msg:i.errmsg,err:i}):{code:0,msg:"ok",access_token:i.access_token,expires_in:i.expires_in}},q.auth.getAccessToken=async function(e={}){let t,{appid:n,appsecret:r}=q.auth.getAppidInfo(e),{cache:a=!0}=e,{vk:i}=R,o="mp-weixin-"+n;if(a&&(t=await i.globalDataCache.get(o)),i.pubfn.isNull(t)){let n=await q.auth.getAccessTokenFn(e);0===n.code&&(t=n.access_token,await i.globalDataCache.set(o,t,240),await i.globalDataCache.deleteExpired())}return t},q.auth.code2Session=async function(e={}){let t,{vk:n,uniID:r}=R,{platform:a,context:i}=e;return a||(a=n.pubfn.getPlatform(i)||"mp-weixin"),t="mp-weixin"===a?await q.auth.code2SessionMpWeixin(e):"h5-weixin"===a?await q.h5.auth.code2Session(e):await r.code2SessionWeixin(e),t.platform=a,t},q.auth.code2SessionMpWeixin=async function(e={}){let{appid:t,appsecret:n}=q.auth.getAppidInfo(e),r=e.code||e.js_code,{vk:a}=R,i=await a.request({url:`https://api.weixin.qq.com/sns/jscode2session?appid=${t}&secret=${n}&js_code=${r}&grant_type=authorization_code`,method:"GET"});if(i.errcode){let e=i.errmsg;return 40163===i.errcode&&(e="该code已被使用，请重新获取"),40029===i.errcode&&(e="无效code，请重新获取"),{...i,code:i.errcode,msg:e}}return i=a.pubfn.snake2camelJson(i),{...i,code:0,msg:"ok"}},q.wxacode={},q.wxacode.getUnlimited=async function(e={}){let t,{vk:n}=R,{access_token:r,scene:a,page:i,width:o,auto_color:s,line_color:l,is_hyaline:c}=e;if(t=r||await q.auth.getAccessToken(e),!t)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};let d=await n.request({url:"https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token="+t,method:"POST",data:{scene:a,page:i,width:o,auto_color:s,line_color:l,is_hyaline:c},dataType:"default",useContent:!0,headers:{encoding:null}});if(d.length<500){let e=d.toString();try{e=JSON.parse(e)}catch(e){}return{code:-1,msg:"生成小程序码失败，请重试！",res:e}}return Buffer.isBuffer(d)?d:{code:d.errcode,msg:d.errmsg,err:d}},q.urlscheme={},q.urlscheme.generate=async function(e={}){let{vk:t}=R,{jump_wxa:n={},is_expire:r,expire_time:a}=e,{path:i,query:o}=n,s=await q.auth.getAccessToken(e);if(!s)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};a>0&&(a=(new Date).getTime()/1e3+a);let l=await t.request({url:"https://api.weixin.qq.com/wxa/generatescheme?access_token="+s,method:"POST",data:{jump_wxa:{path:i,query:o},is_expire:r,expire_time:a},useContent:!0});switch(l=L(l),l.code){case 40001:l.msg="access_token错误";break;case 40165:l.msg="小程序页面不存在!"}return l},q.security={},q.security.msgSecCheck=async function(e={}){let{vk:t}=R,{content:n}=e,r=await q.auth.getAccessToken(e);if(!r)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};let a=await t.request({url:"https://api.weixin.qq.com/wxa/msg_sec_check?access_token="+r,method:"POST",data:{content:n},useContent:!0});switch(a=L(a),a.code){case 40001:a.msg="access_token错误";break;case 87014:a.msg="内容含有违法违规内容，请检查!"}return a},q.security.imgSecCheck=async function(e={}){let{vk:t}=R,{dataBuffer:n,formData:r,base64:a}=e,i=await q.auth.getAccessToken(e);if(!i)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};if(a&&!n){let e="base64,",t=a.indexOf(e);t>-1&&(a=a.substring(t+e.length)),n=new Buffer(a,"base64")}n&&!r&&(r=new t.formDataUtil.FormData,r.append("media",n,{filename:Date.now()+".png",contentType:"image/png"}));let o=await t.request({url:"https://api.weixin.qq.com/wxa/img_sec_check?access_token="+i,content:r.getBuffer(),headers:r.getHeaders()});switch(o=L(o),o.code){case 40001:o.msg="access_token错误";break;case 87014:o.msg="图片内容含有违法违规内容，请检查!";break;case 40006:o.msg="图片大小不能超过1M"}return o},q.subscribeMessage={},q.subscribeMessage.send=async function(e={}){let{vk:t}=R,{touser:n,template_id:r,page:a,data:i,miniprogram_state:o="formal",lang:s="zh_CN"}=e,l=await q.auth.getAccessToken(e);if(!l)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};let c=await t.request({url:"https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token="+l,method:"POST",data:{touser:n,template_id:r,page:a,data:i,miniprogram_state:o,lang:s},useContent:!0});switch(c=L(c),c.code){case 40003:c.msg="touser字段openid为空或者不正确";break;case 40037:c.msg="订阅模板id为空不正确";break;case 43101:c.msg="用户未订阅该消息";break;case 47003:c.msg="模板参数不准确，可能为空或者不满足规则，errmsg会提示具体是哪个字段出错";break;case 41030:c.msg="page路径不正确，需要保证在现网版本小程序中存在"}return c},q.uniformMessage={},q.uniformMessage.send=async function(e={}){let{vk:t}=R,{touser:n,template_id:r,url:a,miniprogram:i,data:o}=e,s=await q.auth.getAccessToken(e);if(!s)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};let{appid:l,appsecret:c}=q.h5.auth.getAppidInfo(e),d=await t.request({url:"https://api.weixin.qq.com/cgi-bin/message/wxopen/template/uniform_send?access_token="+s,method:"POST",data:{touser:n,mp_template_msg:{appid:l,template_id:r,url:a,miniprogram:i,data:o}},useContent:!0});switch(d=L(d),d.code){case 40003:d.msg="touser字段openid为空或者不正确";break;case 40037:d.msg="订阅模板id为空不正确";break;case 43101:d.msg="用户未订阅该消息";break;case 47003:d.msg="模板参数不准确，可能为空或者不满足规则，errmsg会提示具体是哪个字段出错";break;case 41030:d.msg="page路径不正确，需要保证在现网版本小程序中存在"}return d},q.livebroadcast={},q.livebroadcast.getLiveInfo=async function(e={}){let{vk:t}=R,{pageIndex:n=1,pageSize:r=100}=e,a=await q.auth.getAccessToken(e);if(!a)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};if(n<=0)return{code:-1,msg:"pageIndex必须是大于0的整数"};let i=(n-1)*r,o=r,s=await t.request({url:"https://api.weixin.qq.com/wxa/business/getliveinfo?access_token="+a,method:"POST",data:{start:i,limit:o},useContent:!0});switch(s=L(s),s.code){case 941e4:s.msg="直播间列表为空"}return s},q.app={},q.app.auth={},q.app.auth.getAppidInfo=function(e={}){let{appid:t,appsecret:n}=e,{vk:r,config:a}=R;const i=q.getConfig();if(t){if(!n){let e=r.pubfn.getData(a,"vk.oauth.weixin.list")||[],i=r.pubfn.getListItem(e,"appid",t)||{};t=i.appid,n=i.appsecret}}else{let e=r.pubfn.getData(i,"app-plus.oauth.weixin")||{};t=e.appid,n=e.appsecret}if(r.pubfn.isNullOne(t,n))throw console.log("config",i),new Error("请先配置微信小程序appid和appsecret");return{appid:t,appsecret:n}},q.app.auth.getAccessToken=async function(e={}){let{appid:t,appsecret:n}=q.app.auth.getAppidInfo(e),{vk:r,config:a}=R,{code:i}=e,o=await r.request({url:`https://api.weixin.qq.com/sns/oauth2/access_token?appid=${t}&secret=${n}&code=${i}&grant_type=authorization_code`,method:"GET"});return o.errcode?(console.error("getAccessToken失败：",o),{code:o.errcode,msg:o.errmsg,err:o}):{...o,code:0,msg:"ok"}},q.app.auth.getUserInfo=async function(e={}){let{vk:t,config:n}=R,{access_token:r,openid:a,lang:i="zh-CN"}=e;if(!r)return{code:-1,msg:"access_token不能为空"};let o=await t.request({url:`https://api.weixin.qq.com/sns/userinfo?access_token=${r}&openid=${a}$lang=${i}`,method:"GET"});return o.errcode?(console.error("getUserInfo失败：",o),{code:o.errcode,msg:o.errmsg,err:o}):{...o,code:0,msg:"ok",avatar:o.headimgurl,gender:o.sex}},q.h5={},q.h5.auth={},q.h5.auth.getAppidInfo=function(e={}){let{appid:t,appsecret:n}=e,{vk:r,config:a}=R;const i=q.getConfig();if(t){if(!n){let e=r.pubfn.getData(a,"vk.oauth.weixin.list")||[],i=r.pubfn.getListItem(e,"appid",t)||{};t=i.appid,n=i.appsecret}}else{let e=r.pubfn.getData(i,"h5-weixin.oauth.weixin")||{};t=e.appid,n=e.appsecret}if(r.pubfn.isNullOne(t,n))throw console.log("config",i),new Error("请先配置微信公众号appid和appsecret");return{appid:t,appsecret:n}},q.h5.auth.code2Session=async function(e={}){let{appid:t,appsecret:n}=q.h5.auth.getAppidInfo(e),{code:r}=e,{vk:a}=R,i=await a.request({url:`https://api.weixin.qq.com/sns/oauth2/access_token?appid=${t}&secret=${n}&code=${r}&grant_type=authorization_code`,method:"GET"});if(i.errcode){let e=i.errmsg;return 40163===i.errcode&&(e="该code已被使用，请重新获取"),40029===i.errcode&&(e="无效code，请重新获取"),{...i,code:i.errcode,msg:e}}return i=a.pubfn.snake2camelJson(i),{...i,code:0,msg:"ok"}},q.h5.auth.getAccessToken=async function(e={}){let t,{appid:n,appsecret:r}=q.h5.auth.getAppidInfo(e),{cache:a=!0}=e,{vk:i}=R,o="h5-weixin-"+n;if(a&&(t=await i.globalDataCache.get(o)),i.pubfn.isNull(t)){let n=await q.h5.auth.getAccessTokenFn(e);0===n.code&&(t=n.access_token,await i.globalDataCache.set(o,t,240),await i.globalDataCache.deleteExpired())}return t},q.h5.auth.getAccessTokenFn=async function(e={}){let{appid:t,appsecret:n}=q.h5.auth.getAppidInfo(e),{vk:r,config:a}=R,i=await r.request({url:`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${t}&secret=${n}`,method:"GET"});return i.errcode?(console.error("getAccessToken失败：",i),{code:i.errcode,msg:i.errmsg,err:i}):{code:0,msg:"ok",access_token:i.access_token,expires_in:i.expires_in}},q.h5.subscribeMessage={},q.h5.subscribeMessage.send=async function(e={}){let{vk:t}=R,{touser:n,template_id:r,page:a,data:i,miniprogram:o}=e,s=await q.h5.auth.getAccessToken(e);if(!s)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};let l=await t.request({url:"https://api.weixin.qq.com/cgi-bin/message/subscribe/bizsend?access_token="+s,method:"POST",data:{touser:n,template_id:r,page:a,data:i,miniprogram:o},useContent:!0});switch(l=L(l),l.code){case 40003:l.msg="touser字段openid为空或者不正确";break;case 40037:l.msg="订阅模板id为空不正确";break;case 43101:l.msg="用户未订阅该消息";break;case 47003:l.msg="模板参数不准确，可能为空或者不满足规则，errmsg会提示具体是哪个字段出错";break;case 41030:l.msg="page路径不正确，需要保证在现网版本小程序中存在"}return l},q.h5.templateMessage={},q.h5.templateMessage.send=async function(e={}){let{vk:t}=R,{touser:n,template_id:r,url:a,miniprogram:i,data:o}=e,s=await q.h5.auth.getAccessToken(e);if(!s)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};let l=await t.request({url:"https://api.weixin.qq.com/cgi-bin/message/template/send?access_token="+s,method:"POST",data:{touser:n,template_id:r,url:a,miniprogram:i,data:o},useContent:!0});switch(l=L(l),l.code){case 40003:l.msg="touser字段openid为空或者不正确";break;case 40037:l.msg="订阅模板id为空不正确";break;case 43101:l.msg="用户未订阅该消息";break;case 47003:l.msg="模板参数不准确，可能为空或者不满足规则，errmsg会提示具体是哪个字段出错";break;case 41030:l.msg="page路径不正确，需要保证在现网版本小程序中存在"}return l},q.loginByWeixin=async function(e={},t,n){let r,a,i;e.context?(r=e.data||{},a=e.context,i=e.custom,e.appid&&(r.appid=e.appid),e.appsecret&&(r.appsecret=e.appsecret)):(r=e,a=t,i=n);let o,s,{vk:l,uniID:c,_:d}=R,{code:u,platform:f,type:p,appid:g}=r;if(f||(f=l.pubfn.getPlatform(a),r.platform=f),["mp-weixin"].indexOf(f)>-1&&g){let{appid:e,appsecret:t}=q.auth.getAppidInfo(r),n=l.pubfn.copyObject(q.getConfig());n[f]={oauth:{weixin:{appid:e,appsecret:t}}},r.platform=f,s=c.createInstance({context:a,config:n})}s||(s=c);try{o=await s.loginByWeixin(r);try{if(o.uid&&!o.msg&&(o.msg="register"===o.type?"注册成功":"登录成功"),o.uid&&"register"===o.type){let e={};if(["h5-weixin","app-plus"].indexOf(f)>-1){let t=await l.openapi.weixin.app.auth.getUserInfo({access_token:o.accessToken,openid:o.openid});e={nickname:t.nickname,avatar:t.headimgurl}}["mp-weixin"].indexOf(f)>-1&&(e={nickname:r.nickname,avatar:r.avatar}),l.pubfn.isNotNull(i)&&(e=l.pubfn.objectAssign(e,i)),l.pubfn.isNotNull(e)&&(o.userInfo=await l.baseDao.updateAndReturn({dbName:"uni-id-users",whereJson:{_id:o.uid||"___",nickname:d.exists(!1)},dataJson:e}))}}catch(e){console.error("保存用户头像昵称异常：",e)}}catch(e){console.error("loginByWeixin异常：",e);let t=e.message||"";throw e.message.indexOf("code been used")>-1&&(t="该code已被使用，请重新获取"),e.message.indexOf("invalid code")>-1&&(t="无效code，请重新获取"),new Error("msg:"+t)}return o};var z=q,U={},K={};U.init=function(e){K=e},U.open={},U.open.auth={},U.open.auth.getAppidInfo=function(e={}){let{appid:t,appsecret:n}=e,{vk:r,config:a}=K;if(!t){let e=r.pubfn.getData(a,"vk.service.openapi.baidu")||{};t=e.appid,n=e.appsecret}if(r.pubfn.isNullOne(t,n))throw new Error("请在cloudfunctions/common/config/index.js中配置并检查百度开放平台的appid和appsecret是否正确，参数路径：vk.service.openapi.baidu");return{appid:t,appsecret:n}},U.open.auth.getAccessTokenFn=async function(e={}){let{appid:t,appsecret:n}=U.open.auth.getAppidInfo(e),{vk:r,config:a}=K,i=await r.request({url:`https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${t}&client_secret=${n}`,method:"GET"});return i.error_code?(console.error("getAccessToken失败：",i),{code:i.error_code,msg:i.error_msg,err:i}):{...i,code:0,msg:"ok"}},U.open.auth.getAccessToken=async function(e={}){let t,{appid:n,appsecret:r}=U.open.auth.getAppidInfo(e),{cache:a=!0}=e,{vk:i}=K,o="openapi-baidu-"+n;if(a&&(t=await i.globalDataCache.get(o)),i.pubfn.isNull(t)){let n=await U.open.auth.getAccessTokenFn(e);0===n.code&&(t=n.access_token,await i.globalDataCache.set(o,t,n.expires_in-3600),await i.globalDataCache.deleteExpired())}return t},U.open.ocr={},U.open.ocr.business_license=async function(e={}){let{image:t,url:n}=e;return await U.open.request({...e,action:"ocr/v1/business_license",actionVersion:"2.0",data:{image:t,url:n}})},U.open.ocr.idcard=async function(e={}){let{image:t,url:n,id_card_side:r,detect_risk:a,detect_photo:i}=e;return await U.open.request({...e,action:"ocr/v1/idcard",actionVersion:"2.0",data:{image:t,url:n,id_card_side:r,detect_risk:a,detect_photo:i}})},U.open.request=async function(e={}){let{vk:t}=K,n=await U.open.auth.getAccessToken(e);if(!n)return{code:-1,msg:"获取access_token失败，请检查appid和appsecret是否正确"};let{action:r,actionVersion:a="2.0",header:i={"content-type":"application/x-www-form-urlencoded"},data:o}=e,s=await t.request({url:`https://aip.baidubce.com/rest/${a}/${r}?access_token=${n}`,method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},data:o});return s.error_code?{code:s.error_code,msg:s.error_msg,err:s}:{...s,code:0,msg:"ok"}};var W=U,Y={};Y.weixin=z,Y.baidu=W,Y.init=function(e){Y.weixin.init(e),Y.baidu.init(e)};var Z=Y;const G=/^multipart\/.+?(?:;\s*boundary=(?:(?:"(.+)")|(?:([^\s]+))))$/i,V=/Content-Disposition:\sform-data;\sname="(.+?)"(?:;\sfilename="(.+?)")?/i,H=/Content-Type:\s(.+?)$/i;var Q={FormData:class{constructor(){this._shouldUseCache=!1,this._cachedBuffer=null,this._lineBreak="\r\n",this._boundary="------FormDataBaseBoundary"+Math.random().toString(36).substring(2),this.dataList=[]}_addData(e){if(this._shouldUseCache=!1,0===this.dataList.length)return void this.dataList.push(e);const t=this.dataList[this.dataList.length-1];switch(`${Buffer.isBuffer(t)?"buffer":"other"}_${Buffer.isBuffer(e)?"buffer":"other"}`){case"buffer_buffer":this.dataList.push(this._lineBreak),this.dataList.push(e);break;case"buffer_other":this.dataList.push(this._lineBreak+e);break;case"other_buffer":this.dataList[this.dataList.length-1]=t+"\r\n",this.dataList.push(e);break;case"other_other":this.dataList[this.dataList.length-1]=t+"\r\n"+e}}append(e,t,n){this._addData("--"+this._boundary);let r=`Content-Disposition: form-data; name="${encodeURIComponent(e)}"`;if(Buffer.isBuffer(t)){if(!n.filename||!n.contentType)throw new Error("filename and contentType required");r+=`; filename="${encodeURIComponent(n.filename)}"`,this._addData(r),this._addData("Content-Type: "+n.contentType),this._addData(""),this._addData(t)}else this._addData(r),this._addData(""),this._addData(t)}getHeaders(e){const t={"Content-Type":"multipart/form-data; boundary="+this._boundary};return Object.assign(t,e)}getBuffer(){if(this._shouldUseCache)return this._cachedBuffer;this._shouldUseCache=!0;let e=Buffer.alloc(0);return this.dataList.forEach(t=>{e=Buffer.isBuffer(t)?Buffer.concat([e,t]):Buffer.concat([e,Buffer.from(""+t)])}),e=Buffer.concat([e,Buffer.from(`${this._lineBreak}--${this._boundary}--`)]),this._cachedBuffer=e,e}},formParser:e=>{const t=(e.headers["content-type"]||e.headers["Content-Type"]).match(G),n=t[1]||t[2],r=function(e,t){let n=0,r=0,a=[];for(;-1!==(r=e.indexOf(t,n));)a.push(e.slice(n,r)),n=r+t.length,r=e.indexOf(t,n);return a}(Buffer.from(e.body,"base64"),Buffer.from("--"+n)).map(e=>function(e){let t=e.indexOf("\r\n")+"\r\n".length,n=t,r=e.lastIndexOf("\r\n"),a=[];for(;-1!==(n=e.indexOf("\r\n",t));)if(a.push(e.slice(t,n)),t=n+"\r\n".length,0===a[a.length-1].length){a.push(e.slice(t,r));break}return a}(e).filter(e=>e.length>0)).filter(e=>2===e.length||3===e.length||4===e.length).map(e=>{const t={},n=e[0].toString().match(V);switch(t.name=decodeURIComponent(n[1]),e.length){case 2:t.value=e[1].toString();break;case 3:t.filename=decodeURIComponent(n[2]),t.contentType=e[1].toString().match(H)[1],t.fileContent=e[2];break;case 4:t.filename=decodeURIComponent(n[2]),t.contentType=e[1].toString().match(H)[1],t.fileContent=e[3]}return t}),a={};return r.forEach(e=>{const t=e.name;delete e.name,a[t]=e.fileContent?e:e.value}),a}};const X="opendb-admin-menus";var ee={},te={};ee.init=function(e){te=e},ee.findRoleById=async(e="___")=>{let t,{vk:n,db:r,_:a}=te;return t=await n.baseDao.findByWhereJson({dbName:"uni-id-roles",whereJson:{role_id:e}}),t},ee.roleBindPermission=async(e={})=>{let{vk:t,db:n,_:r}=te,a={code:0,msg:""},{role_id:i="___",permissionList:o=[],reset:s=!1}=e;if(!s){let e=await ee.findRoleById(i),{permission:t=[]}=e;o=t.concat(o),o=[...new Set(o)]}return a.num=await t.baseDao.update({dbName:"uni-id-roles",whereJson:{role_id:i},dataJson:{permission:r.set(o)}}),a},ee.roleBindMenu=async(e={})=>{let{vk:t,db:n,_:r}=te,a={code:0,msg:""},{role_id:i="___",menuList:o=[],reset:s=!1,addPermission:l=!1}=e,c=[],d=await ee.findRoleById(i),{menu:u=[],permission:f=[]}=d;if(s?c=re(o,u):(o=u.concat(o),o=[...new Set(o)]),a.num=await t.baseDao.update({dbName:"uni-id-roles",whereJson:{role_id:i},dataJson:{menu:r.set(o)}}),l){let e=await ee.findMenuByIdsToPermission(o),n=[];if(s&&t.pubfn.isNotNull(c)){n=re(e,await ee.findMenuByIdsToPermission(c))}f=f.concat(e),f=re(n,f),f=[...new Set(f)],ee.roleBindPermission({role_id:i,permissionList:f,reset:!0})}return a},ee.findPermissionById=async(e="___")=>{let t,{vk:n,db:r,_:a}=te;return t=await n.baseDao.findByWhereJson({dbName:"uni-id-permissions",whereJson:{permission_id:e}}),t},ee.findMenuByIdsToPermission=async e=>{let{vk:t,db:n,_:r}=te,a=await ee.findMenuByIds(e);if(t.pubfn.isNull(a))return[];let i=[];for(let e in a){let n=a[e].permission;t.pubfn.isNotNull(n)&&(i=i.concat(n))}return i=[...new Set(i)],i},ee.listPermissionToTree=async(e={})=>{let t,{vk:n,db:r,_:a}=te,{getCount:i=!1,pageSize:o=500,pageIndex:s=1,whereJson:l={parent_id:null},sortArr:c=[{name:"sort",type:"asc"}],treeProps:d={}}=e,{level:u=3,limit:f=500,whereJson:p}=d;t=await n.baseDao.selects({dbName:"uni-id-permissions",pageIndex:s,pageSize:o,getCount:i,whereJson:l,sortArr:c,treeProps:{id:"permission_id",parent_id:"parent_id",children:"children",level:u,limit:f,whereJson:p,sortArr:c}});let g={id:"permission_id",parent_id:"parent_id",children:"children"},m=t.rows;m=n.pubfn.treeToArray(m,g),t.list=n.pubfn.copyObject(m);for(let e in m){let t=m[e],r="",a="";if(n.pubfn.isNotNull(t.level)){r=` - ${["未分类","子弹级","炸弹级","榴弹级","核弹级"][t.level]}（LV：${t.level}）`}if(n.pubfn.isNotNull(t.curd_category)){a=" - "+["未分类","增","删","改","查","特殊"][t.curd_category]}m[e].label=`${t.permission_name}（${t.permission_id}）${a}${r}`}return m=n.pubfn.arrayToTree(m,g),t.rows=m,t},ee.findMenuById=async(e="___")=>{let t,{vk:n,db:r,_:a}=te;return t=await n.baseDao.findByWhereJson({dbName:X,whereJson:{menu_id:e}}),t},ee.findMenuByIds=async e=>{let t,{vk:n,db:r,_:a}=te;return n.pubfn.isNull(e)?[]:(t=(await n.baseDao.select({dbName:X,pageIndex:1,pageSize:500,whereJson:{menu_id:a.in(e)}})).rows,t)},ee.listMenuByRole=async(e={})=>{let{vk:t,db:n,_:r}=te,a={code:0,msg:"",menus:[],menuList:[]},{role:i}=e,o=[],s={enable:!0},l={enable:!0};if(!(i.indexOf("admin")>-1)){if(t.pubfn.isNull(i))return a;let e=await t.baseDao.select({dbName:"uni-id-roles",pageSize:500,whereJson:{role_id:r.in(i),enable:!0},fieldJson:{menu:!0}});for(let n in e.rows){let{menu:r}=e.rows[n];t.pubfn.isNotNull(r)&&(o=o.concat(r))}if(0==o.length)return a;o=[...new Set(o)],s.menu_id=r.in(o),l.menu_id=r.in(o)}s.parent_id=null;let c=[{name:"sort",type:"asc"}],d=await t.baseDao.selects({dbName:X,pageIndex:1,pageSize:500,whereJson:s,sortArr:c,treeProps:{id:"menu_id",parent_id:"parent_id",children:"children",level:3,limit:500,whereJson:l,sortArr:c}});return a.menus=d.rows,a.menuList=t.pubfn.treeToArray(d.rows,{id:"menu_id",parent_id:"parent_id",children:"children"}),a},ee.menuBindPermission=async(e={})=>{let{vk:t,db:n,_:r}=te,a={code:0,msg:""},{menu_id:i="___",permissionList:o=[],reset:s=!1}=e;if(!s){let e=await ee.findMenuById(i),{permission:t=[]}=e;o=t.concat(o),o=[...new Set(o)]}return a.num=await t.baseDao.update({dbName:X,whereJson:{menu_id:i},dataJson:{permission:r.set(o)}}),a},ee.listMenuToTree=async(e={})=>{let t,{vk:n,db:r,_:a}=te,{getCount:i=!1,pageSize:o=500,pageIndex:s=1,whereJson:l={parent_id:null},sortArr:c=[{name:"sort",type:"asc"}],treeProps:d={}}=e,{level:u=3,limit:f=500,whereJson:p}=d;t=await n.baseDao.selects({dbName:X,pageIndex:s,pageSize:o,getCount:i,whereJson:l,sortArr:c,treeProps:{id:"menu_id",parent_id:"parent_id",children:"children",level:u,limit:f,whereJson:p,sortArr:c}});let g={id:"menu_id",parent_id:"parent_id",children:"children"},m=t.rows;m=n.pubfn.treeToArray(m,g),t.list=n.pubfn.copyObject(m);for(let e in m){let t=m[e];m[e].label=`${t.name}（${t.menu_id}）`}return m=n.pubfn.arrayToTree(m,g),t.rows=m,t};var ne=ee;function re(e,t){let n=new Set(e);return t.filter(e=>!n.has(e))}const ae="vk-global-data";var ie={},oe={};ie.init=function(e){oe=e},ie.find=async e=>{let{vk:t,db:n,_:r}=oe,a={};return a=await t.baseDao.findById({dbName:ae,id:e}),a},ie.del=async e=>{let{vk:t,db:n,_:r}=oe,a={};return a=await t.baseDao.deleteById({dbName:ae,id:e}),a},ie.deleteByWhere=async e=>{let{vk:t,db:n,_:r}=oe,a={};return a=await t.baseDao.del({dbName:ae,whereJson:e}),a},ie.deleteExpired=async e=>{let{vk:t,db:n,_:r}=oe,a={},i={};"string"==typeof e?i._id=e:"object"==typeof e&&(i=e);let o=(new Date).getTime();return a=await t.baseDao.del({dbName:ae,whereJson:{...i,expired_at:r.gt(0).lte(o)}}),a},ie.update=async e=>{let{vk:t,db:n,_:r}=oe,a={},{key:i,value:o,comment:s,expired_at:l}=e;return a=await t.baseDao.updateById({dbName:ae,id:i,dataJson:{value:r.set(o),comment:s,expired_at:l}}),a},ie.add=async e=>{let{vk:t,db:n,_:r}=oe,a={},{key:i,value:o,comment:s,expired_at:l}=e;return a=await t.baseDao.add({dbName:ae,dataJson:{_id:i,key:i,value:o,comment:s,expired_at:l}}),a},ie.count=async e=>{let{vk:t,db:n,_:r}=oe,a={};return a=await t.baseDao.count({dbName:ae,whereJson:e}),a},ie.set=async e=>{let{vk:t,db:n,_:r}=oe,a={code:0,msg:"ok"},i=new Date;e._add_time=i.getTime(),e._add_time_str=t.pubfn.timeFormat(i,"yyyy-MM-dd hh:mm:ss");let o=await n.collection(ae).doc(e.key).set(e);return o.upsertedId?(a.id=o.upsertedId,a.mode="add"):(a.mode="update",a.updated=o.updated),a.num=1,a},ie.inc=async e=>{let{vk:t,db:n,_:r}=oe,{key:a,value:i,expired_at:o}=e,s={},l=await t.baseDao.updateById({dbName:ae,id:a,dataJson:{value:r.inc(i),expired_at:o}});if(0==l){0===await ie.count({_id:a})&&(s.id=await ie.add(e),s.num=1,s.mode="add")}else s.num=l,s.mode="update";return s},ie.list=async e=>{let{vk:t,db:n,_:r}=oe,a={},{pageIndex:i,pageSize:o,whereJson:s,sortArr:l}=e;return a=await t.baseDao.select({dbName:ae,pageIndex:i,pageSize:o,whereJson:s,sortArr:l}),a};var se=ie,le={},ce={init:function(e){le=e}},de={specialUrlEncode:function(e){return(e=encodeURIComponent(e)).replace(/\+/g,"%20").replace(/\*/g,"%2A").replace(/%7E/g,"~")},sign:function(e,t){let{crypto:n}=le;return n.createHmac("sha1",e).update(t).digest("base64")}};ce.sendSms=async function(e){let{vk:t,config:n}=le,{provider:r,appid:a,smsKey:i,smsSecret:o,signName:s,phone:l,templateId:c,data:d}=e,u={};if("aliyun"===r){let r=t.pubfn.getData(n,"vk.service.sms.aliyun");t.pubfn.isNotNull(r)&&(i||(e.smsKey=r.accessKeyId),o||(e.smsSecret=r.accessKeySecret),s||(e.signName=r.signName)),u=await ce.sendSmsByAliyun(e)}else{if("unicloud"!==r)return{code:-1,msg:`暂不支持${r}供应商`};{let r=t.pubfn.getData(n,"uni.service.sms");t.pubfn.isNotNull(r)&&(i||(e.smsKey=r.smsKey),o||(e.smsSecret=r.smsSecret),s||(e.signName=r.signName)),u=await ce.sendSmsByUnicloud(e)}}return u.requestParam={provider:r,phone:l},u},ce.sendSmsByAliyun=async function(e){let{vk:t,config:n}=le,{provider:r,appid:a,smsKey:i,smsSecret:o,signName:s,phone:l,templateId:c,data:d}=e,u={code:0,msg:""};try{if(t.pubfn.isNullOne(i,o))return{code:-1,msg:"阿里云短信配置错误,请检查!"};let e="https://dysmsapi.aliyuncs.com",n=t.pubfn.timeFormat(new Date,"yyyy-MM-ddThh:mm:ssZ",0),r=(new Date).getTime().toString().substring(7)+t.pubfn.random(30);"object"==typeof d&&(d=JSON.stringify(d));let a={SignatureMethod:"HMAC-SHA1",SignatureNonce:r,AccessKeyId:i,SignatureVersion:"1.0",Timestamp:n,Format:"json",Action:"SendSms",Version:"2017-05-25",PhoneNumbers:l,SignName:s,TemplateParam:d,TemplateCode:c};delete a.Signature;let f=[];for(let e in a)f.push(e);f.sort();let p=!1,g="";for(let e in f){let t=f[e];g+="&"+de.specialUrlEncode(t)+"="+de.specialUrlEncode(a[t])}g=g.substring(1);let m="GET&"+de.specialUrlEncode("/")+"&"+de.specialUrlEncode(g),b=de.sign(o+"&",m),h=de.specialUrlEncode(b),y="Signature="+h+"&"+g;p&&(console.log("\r\n随机数\r\n"),console.log(a.SignatureNonce),console.log("\r\n=========\r\n"),console.log(a.Timestamp),console.log("\r\n====sortedQueryString====\r\n"),console.log(g),console.log("\r\n=====stringToSign====\r\n"),console.log(m),console.log("\r\n=====sign====\r\n"),console.log(b),console.log("\r\n=====signature====\r\n"),console.log(h),console.log("\r\n=========\r\n"),console.log(e+"/?"+y));t.pubfn.urlStringToJson(y);let w=await t.request({url:`${e}?${y}`,method:"GET"});return u="OK"===w.Code?{code:0,msg:"ok",requestRes:w}:{code:-1,msg:w.Message,requestRes:w},u}catch(e){return{code:-1,msg:"短信发送失败",err:{message:e.message,stack:e.stack}}}},ce.sendSmsByUnicloud=async function(e){let{provider:t,appid:n,smsKey:r,smsSecret:a,signName:i,phone:o,templateId:s,data:l}=e,c={code:0,msg:""};try{let e=await uniCloud.sendSms({smsKey:r,smsSecret:a,phone:o,templateId:s,data:l});c=0==e.code||0==e.errCode?{code:0,msg:"ok",requestRes:e}:{code:-1,msg:e.errMessage||e.errMsg,requestRes:e}}catch(e){return{code:-1,msg:"短信发送失败",err:{message:e.message,stack:e.stack}}}return c},ce.sendSmsVerifyCode=async function(e){let t,{vk:n,config:r,uniID:a}=le,{provider:i,phone:o,code:s,type:l,expiresIn:c=180}=e,d={code:0,msg:""};if("unicloud"===i){t=n.pubfn.getData(r,"uni.service.sms.templateId");let e=n.pubfn.getData(r,"uni.service.sms.codeExpiresIn");e&&(c=e);let a=n.pubfn.getData(r,"uni.service.sms.name"),l=Math.ceil(c/60).toString();d=await n.system.smsUtil.sendSms({provider:i,phone:o,templateId:t,data:{code:s,name:a,action:"身份验证",expMinute:l}})}else t=n.pubfn.getData(r,`vk.service.sms.${i}.templateCode.verifyCode`),d=await n.system.smsUtil.sendSms({provider:i,phone:o,templateId:t,data:{code:s}});return 0===d.code&&await a.setVerifyCode({mobile:o,code:s,expiresIn:c,type:l}),d};var ue=ce,fe={};fe.sysDao=ne,fe.globalDataDao=se,fe.smsUtil=ue,fe.init=function(e){let t=["sysDao","globalDataDao","smsUtil"];for(let n in t){let r=t[n];"function"==typeof fe[r].init&&fe[r].init(e)}};var pe=fe,ge={};ge.router=c,ge.md5=b,ge.baseDao=w,ge.request=_,ge.pubfn=$,ge.temporaryCache=P,ge.globalDataCache=B,ge.openapi=Z,ge.formDataUtil=Q,ge.system=pe,ge.require=function(e){return me.requireFn(me.baseDir+"/"+e)},ge.requireFn=function(e){try{return me.requireFn(e)}catch(e){let{message:t=""}=e;return void(-1==t.indexOf("Cannot find module")&&console.error(e))}},ge.use=function(e,t){for(let n in e)e[n]&&"function"==typeof e[n].init&&e[n].init(t),ge[n]=e[n]};var me={};ge.init=function(e={}){if(me.requireFn=e.requireFn,e.configCenter||(e.configCenter=ge.requireFn("uni-config-center")),e.uniID||(e.uniID=ge.requireFn("uni-id")),e.uniPay||(e.uniPay=ge.requireFn("uni-pay")),e.middlewareService||(e.middlewareService=ge.requireFn("./middleware/index")),e.daoCenter||(e.daoCenter=ge.requireFn("./dao/index")),e.crypto||(e.crypto=ge.requireFn("crypto")),e.urlrewrite||(e.urlrewrite=ge.requireFn("./util/urlrewrite")),e.config||(e.config=e.configCenter({pluginId:"vk-unicloud"}).requireFile("index.js")),!e.config)throw new Error("配置文件：uniCloud/cloudfunctions/common/uni-config-center/vk-unicloud/index.js \n编译错误，请检查！");if(!e.db)try{e.db=uniCloud.database()}catch(e){}ge.vkPay=ge.requireFn("vk-uni-pay"),e.pubFun||(e.pubFun=ge.requireFn("./util/pubFunction")),e.pubFun&&(ge.myfn=e.pubFun),e.redis||(e.redis=ge.requireFn("vk-redis")),e.redis&&(ge.redisUtil=e.redis,ge.redis=e.redis.redis,ge.newRedis=e.redis.newRedis),me.configCenter=e.configCenter,me.config=e.config,me.uniID=e.uniID,me.uniPay=e.uniPay,me.db=e.db,me._=e.db.command,me.pubfn=ge.pubfn,me.middlewareService=e.middlewareService,me.pubFun=e.pubFun,me.customUtil=e.customUtil,me.baseDir=e.baseDir,me.crypto=e.crypto,me.urlrewrite=e.urlrewrite;const t={vk:ge,...me};ge.use({daoCenter:e.daoCenter,baseDao:ge.baseDao,openapi:ge.openapi,globalDataCache:ge.globalDataCache,system:ge.system,pubFun:e.pubFun},t)},ge.getUnicloud=function(){return me};var be=ge;module.exports=be;
